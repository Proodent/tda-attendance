<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tolon District Assembly Staff Attendance Portal</title>
  <link rel="icon" type="image/png" href="/assets/favicon.png" />
  <style>
    /* YOUR ORIGINAL STYLES – 100% UNCHANGED */
    body {font-family: Arial, sans-serif;background: #e8f5e8;text-align: center;margin: 0;padding: 20px;min-height: 100vh;display: flex;flex-direction: column;justify-content: center;align-items: center;overflow-x: hidden;}
    .container {padding: 20px;border-radius: 12px;box-shadow: 0 8px 24px rgba(0,0,0,.15);max-width: 600px;width: 90%;background: rgba(255,255,255,0.92);}
    .logo {width: 60px;height: 60px;margin-bottom: 8px;border-radius: 50%;object-fit: contain;box-shadow: 0 2px 8px rgba(0,0,0,0.1);border: 1.8px solid #009245;}
    h1 {color: #009245;margin-bottom: 15px;font-size: 1.4em;}
    h1 .subtitle {color: #242424;font-size: .65em;}
    .input-group {margin: 20px 0 8px;max-width: 300px;}
    .input-group input {width: 100%;padding: 10px 12px;font-size: 15px;border: 1.5px solid #ccc;border-radius: 8px;text-align: center;font-weight: 600;background: rgba(255,255,255,0.95);}
    #userIdStatus {font-size: 0.85em;font-weight: 600;margin-top: 8px;padding: 8px 12px;border-radius: 8px;max-width: 300px;min-height: 40px;display: flex;align-items: center;justify-content: center;background: rgba(255,255,255,0.95);}
    #userIdStatus.valid {color: #155724;background: #d4edda;border: 1.5px solid #c3e6cb;}
    #userIdStatus.inactive {color: #856404;background: #fff3cd;border: 1.5px solid #ffeaa7;}
    #userIdStatus.invalid {color: #721c24;background: #f8d7da;border: 1.5px solid #f5c6cb;}
    #userIdStatus.loading {color: #856404;background: #fff3cd;border: 1.5px solid #ffeaa7;}
    #userIdStatus.placeholder {color: #666;background: #f8f9fa;border: 1.5px dashed #ccc;}
    .status-box {margin: 18px 0 8px;max-width: 300px;}
    #gpsCoords {font-size: 0.8em;color: #006837;background: #d4edda;padding: 6px 14px;border-radius: 8px;display: inline-block;margin-bottom: 8px;}
    #status {font-size: 1.3em;color: #009245;font-weight: 700;}
    .time-box {margin: 20px 0 12px;max-width: 300px;}
    #liveClock {font-size: 1em;font-weight: 700;letter-spacing: 2px;color: #009245;background: #d4edda;padding: 6px 8px;border-radius: 8px;display: inline-block;min-width: 150px;}
    .colon {color: #006837;font-weight: 600;}
    #liveDate {font-size: .8em;color: #444;margin-top: 7px;font-weight: 600;}
    .button-group {display: flex;gap: 12px;margin-top: 20px;max-width: 300px;}
    button {flex: 1;padding: 14px;font-size: 16px;background: #009245;color: #fff;border: none;border-radius: 8px;cursor: pointer;font-weight: 600;transition: background .3s, transform .2s;}
    #clockIn {background: #4CAF50;}
    #clockOut {background: #F44336;}
    button:hover:not(:disabled) {transform: scale(1.05);}
    #clockIn:hover:not(:disabled) {background: #45a049;}
    #clockOut:hover:not(:disabled) {background: #d32f2f;}
    button:disabled {background: #ccc;opacity: .6;cursor: not-allowed;}
    #adminDashboard {background: #009245;color: #fff;padding: 6px 12px;font-size: 0.8em;border-radius: 6px;margin-bottom: 8px;}
    #adminDashboard:hover {background: #007a3d;}
    #faceModal {display: none;position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0,0,0,.6);z-index: 3000;justify-content: center;align-items: center;}
    #faceModal.show {display: flex;}
    #faceModal .popup-content {background: #fff;padding: 20px;border-radius: 14px;max-width: 380px;width: 90%;text-align: center;box-shadow: 0 10px 30px rgba(0,0,0,.3);}
    #faceModal .popup-header {background: #009245;color: #fff;padding: 10px;border-radius: 8px;font-weight: bold;margin-bottom: 15px;}
    #faceModal .video-container {position: relative;margin: 15px auto;width: 280px;height: 210px;border: 3px solid #009245;border-radius: 12px;overflow: hidden;}
    #faceModal video {width: 100%;height: 100%;object-fit: cover;transform: scaleX(-1);}
    #faceModal .face-guide {position: absolute;top: 50%;left: 50%;transform: translate(-50%,-50%);width: 140px;height: 180px;border: 2px dashed #fff;border-radius: 50%;opacity: 0.7;}
    #faceModal .capture-status {margin: 15px 0;font-weight: 600;color: #009245;}
    #loaderOverlay {display: none;position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(255,255,255,.95);z-index: 3000;justify-content: center;align-items: center;flex-direction: column;backdrop-filter: blur(3px);}
    .loader {border: 6px solid #f3f3f3;border-top: 6px solid #009245;border-radius: 50%;width: 55px;height: 55px;animation: spin 1s linear infinite;margin-bottom: 15px;}
    @keyframes spin {100% {transform: rotate(360deg);}}
    .popup {display: none;position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0,0,0,.4);justify-content: center;align-items: center;z-index: 2000;}
    .popup.show {display: flex;}
    .popup-content {background: #fff;padding: 25px;border-radius: 12px;width: 90%;max-width: 380px;text-align: center;box-shadow: 0 5px 20px rgba(0,0,0,.2);}
    .popup-header {font-size: 1.2em;font-weight: bold;margin-bottom: 10px;padding: 8px;border-radius: 6px;}
    .popup-header.success {background: linear-gradient(135deg,#4CAF50,#45a049);color: #fff;}
    .popup-header.error {background: linear-gradient(135deg,#F44336,#d32f2f);color: #fff;}
    #adminPopup {display: none;position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0,0,0,.5);z-index: 2500;justify-content: center;align-items: center;}
    #adminPopup.show {display: flex;}
    .footer {margin-top: auto;font-size: .9em;color: #666;padding: 10px 0;border-top: 1px solid #eee;max-width: 600px;}
    .footer a {color: #009245;text-decoration: none;}
  </style>
</head>
<body>
  <!-- YOUR FULL HTML (unchanged) -->
  <div class="container">
    <img src="/assets/client-logo.jpg" alt="Logo" class="logo" />
    <h1><span>Tolon District Assembly</span><br><span class="subtitle">Staff Attendance Portal</span></h1>
    <div class="status-box">
      <div id="gpsCoords">GPS: Waiting for signal...</div>
      <p id="status">Checking location...</p>
    </div>
    <div class="time-box">
      <div id="liveClock">00 : 00 : 00</div>
      <div id="liveDate"></div>
    </div>
    <div class="input-group">
      <input type="number" id="userId" placeholder="Enter User ID" maxlength="10" autocomplete="off" disabled />
      <div id="userIdStatus" class="placeholder">Enter User ID to validate</div>
    </div>
    <div class="button-group">
      <button id="clockIn" disabled>Clock In</button>
      <button id="clockOut" disabled>Clock Out</button>
    </div>
  </div>

  <div id="faceModal">
    <div class="popup-content">
      <div class="popup-header">Face Verification</div>
      <p style="margin:12px 0 8px;font-weight:600;">Position your face in the frame</p>
      <div class="video-container">
        <video id="video" autoplay playsinline></video>
        <div class="face-guide"></div>
      </div>
      <div class="capture-status" id="captureStatus">Capturing in 3...</div>
    </div>
  </div>

  <div id="loaderOverlay">
    <div class="loader"></div>
    <p>Verifying face...</p>
  </div>

  <div id="popup" class="popup">
    <div class="popup-content">
      <div class="popup-header" id="popupHeader">Title</div>
      <div id="popupMessage">Message</div>
      <button id="popupCloseBtn">Close</button>
    </div>
  </div>

  <div id="adminPopup">
    <div class="popup-content">
      <button class="popup-close" id="adminCloseBtn">X</button>
      <h2>Admin Login</h2>
      <p style="font-size:0.8em;color:#666;margin-bottom:15px;">(Check with server)</p>
      <input type="email" id="adminEmail" placeholder="Email" />
      <input type="password" id="adminPassword" placeholder="Password" />
      <button id="adminLoginBtn">Login <span class="spinner"></span></button>
      <p id="adminError" class="error"></p>
    </div>
  </div>

  <div class="footer">
    <div><button id="adminDashboard">Admin</button></div>
    <div>Developed by: <a href="https://proodentit.com" target="_blank">Proodent IT Solutions</a></div>
  </div>

  <script>
    // SUCCESS & ERROR SOUNDS – FIXED TO PLAY RELIABLY
    const successSound = new Audio('/assets/success-sound.mp3');
    const errorSound = new Audio('/assets/error-sound.mp3');
    let soundAllowed = false;

    // Unlock audio on first user interaction (fixes iPhone/Android/Chrome autoplay block)
    document.body.addEventListener('touchstart', function unlock() {
      successSound.load();
      errorSound.load();
      const silent = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA');
      silent.play().catch(() => {});
      soundAllowed = true;
      document.body.removeEventListener('touchstart', unlock);
    }, { once: true });

    document.body.addEventListener('click', function unlock() {
      if (!soundAllowed) {
        successSound.load();
        errorSound.load();
        const silent = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA');
        silent.play().catch(() => {});
        soundAllowed = true;
      }
    }, { once: true });

    // LIVE CLOCK & DATE – FIXED (real date, not hardcoded)
    function updateClockAndDate() {
      const now = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const dateStr = now.toLocaleDateString(undefined, options);
      const h = now.getHours().toString().padStart(2, '0');
      const m = now.getMinutes().toString().padStart(2, '0');
      const s = now.getSeconds().toString().padStart(2, '0');

      document.getElementById('liveClock').innerHTML = `<span>${h}</span><span class="colon">:</span><span>${m}</span><span class="colon">:</span><span>${s}</span>`;
      document.getElementById('liveDate').textContent = dateStr;
    }
    updateClockAndDate();
    setInterval(updateClockAndDate, 500);

    // GPS & LOCATION – FIXED (direct update)
    let watchId = null;
    let current_office = null;
    let staff_cache = new Map();
    let videoEl, faceModal, captureStatus;
    let countdown = 0;
    let countdownInterval = null;
    let locations = [];

    const toRad = v => v * Math.PI / 180;
    const getDistanceKm = (lat1, lon1, lat2, lon2) => {
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    };

    // ... [rest of your code unchanged until captureAndVerify] ...

    const captureAndVerify = async (staff, action) => {
      const canvas = document.createElement('canvas');
      canvas.width = videoEl.videoWidth;
      canvas.height = videoEl.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
      const base64 = canvas.toDataURL('image/jpeg').split(',')[1];

      hideFaceModal();
      showLoader(`Verifying face for ${staff.name}...`);

      const result = await validateFaceWithSubject(base64, staff.name);
      hideLoader();

      if (!result.ok) {
        showPopup('Face Verification Failed', result.error, false);
        return;
      }

      // SUCCESS SOUND PLAYS ONLY ONCE – HERE, WHEN FACE IS VERIFIED
      successSound.play().catch(e => console.log("Success sound error:", e));

      showPopup('Success', `Face verified! Recording ${action}...`, true);

      await submitAttendance(action, staff);
    };

    const submitAttendance = async (action, staff) => {
      const statusEl = document.getElementById('status');
      const lat = Number(statusEl.dataset.lat);
      const long = Number(statusEl.dataset.long);

      try {
        const res = await fetch('/api/attendance/web', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action,
            subjectName: staff.name,
            userId: document.getElementById('userId').value.trim(),
            latitude: lat,
            longitude: long,
            timestamp: new Date().toISOString()
          })
        });

        const data = await res.json();

        showPopup(
          data.success ? 'Success' : 'Error',
          data.success
            ? `Dear ${staff.name}, ${action === 'clock in' ? 'clocked in' : 'clocked out'} successfully at ${current_office}.`
            : data.message || 'Attendance failed.',
          data.success
        );

      } catch (err) {
        showPopup('Error', `Connection failed: ${err.message}`, false);
      }
    };

    const showPopup = (title, message, success = null) => {
      const popup = document.getElementById('popup');
      const header = document.getElementById('popupHeader');
      const msg = document.getElementById('popupMessage');
      header.textContent = title;
      header.className = success === true ? 'popup-header success' : success === false ? 'popup-header error' : 'popup-header';
      msg.innerHTML = message;
      popup.classList.add('show');

      // ERROR SOUND ONLY ON FAILURE (not on success – success is already played once)
      if (success === false) {
        errorSound.play().catch(e => console.log("Error sound error:", e));
      }

      setTimeout(() => popup.classList.remove('show'), 5000);
      document.getElementById('popupCloseBtn').onclick = () => popup.classList.remove('show');
    };

    // ... rest of your code unchanged ...

    document.addEventListener('DOMContentLoaded', () => {
      updateClockAndDate();
      startLocationWatch();
    });

    window.onunload = () => {
      if (watchId) navigator.geolocation.clearWatch(watchId);
      stopVideo();
    };
  </script>
</body>
</html>
