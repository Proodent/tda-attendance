<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tolon District Assembly Staff Attendance Portal</title>
  <link rel="icon" type="image/png" href="/assets/favicon.png" />
  <style>
    /* ... [your existing beautiful CSS remains unchanged] ... */
    #status { font-size: 1.4em !important; font-weight: 700; color: #006837; }
    .office-pin::before { content: "üìç "; font-size: 1.1em; }
    /* Success/Failure tones */
    audio { display: none; }
  </style>
</head>
<body>
  <!-- Your full HTML remains the same until <script> -->
  <div class="container">
    <img src="/assets/client-logo.jpg" alt="Logo" class="logo" />
    <h1><span>Tolon District Assembly</span><br><span class="subtitle">Staff Attendance Portal</span></h1>

    <div class="status-box">
      <div id="gpsCoords">GPS: Waiting for signal...</div>
      <p id="status">Checking location...</p>
    </div>

    <div class="time-box">
      <div id="liveClock">00 : 00 : 00</div>
      <div id="liveDate">Friday 21 November 2025</div>
    </div>

    <div class="input-group">
      <input type="text" id="userId" placeholder="Enter User ID" maxlength="10" autocomplete="off" inputmode="numeric" />
      <div id="userIdStatus" class="placeholder">Enter User ID to validate</div>
    </div>

    <div class="button-group">
      <button id="clockIn" disabled>Clock In</button>
      <button id="clockOut" disabled>Clock Out</button>
    </div>
  </div>

  <!-- Hidden Audio for Sound Effects -->
  <audio id="successSound" src="https://assets.mixkit.co/sfx/preview/mixkit-confirmation-tone-2350.mp3" preload="auto"></audio>
  <audio id="errorSound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" preload="auto"></audio>

  <!-- Rest of your modals (faceModal, loader, popup, adminPopup) remain unchanged -->
  <!-- ... keep all your existing modals ... -->

  <script>
    // LIVE CLOCK (GMT - No AM/PM)
    function updateClock() {
      const now = new Date();
      const h = now.getHours().toString().padStart(2,'0');
      const m = now.getMinutes().toString().padStart(2,'0');
      const s = now.getSeconds().toString().padStart(2,'0');
      const dateStr = now.toLocaleDateString('en-GB', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
      document.getElementById('liveClock').innerHTML = 
        `<span>${h}</span><span class="colon">:</span><span>${m}</span><span class="colon">:</span><span>${s}</span>`;
      document.getElementById('liveDate').textContent = dateStr;
    }
    updateClock();
    setInterval(updateClock, 500);

    // Sound Effects
    const successSound = document.getElementById('successSound');
    const errorSound = document.getElementById('errorSound');
    const playSound = (type) => {
      const sound = type === 'success' ? successSound : errorSound;
      sound.currentTime = 0;
      sound.play().catch(() => {}); // Ignore if blocked by autoplay policy
    };

    // Fixed: Office name with pin + proper User ID handling
    let watchId = null;
    let current_office = null;
    let staff_cache = new Map();
    let videoEl, faceModal, captureStatus;
    let countdown = 0;
    let countdownInterval = null;
    let locations = [];

    const toRad = v => v * Math.PI / 180;
    const getDistanceKm = (lat1, lon1, lat2, lon2) => {
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2 ")) * Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    };

    const getStaffByUserId = async (userId) => {
      userId = userId.trim();
      if (staff_cache.has(userId)) return staff_cache.get(userId);

      try {
        const res = await fetch('/api/staff-by-id', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId })
        });
        const data = await res.json();
        if (data.success) {
          const allowed = (data.staff.allowedLocations || []).map(l => l.toLowerCase());
          const staff = { ...data.staff, allowedLocations: allowed };
          staff_cache.set(userId, staff);
          return staff;
        }
      } catch (err) {
        console.error('Staff fetch error:', err);
      }
      return null;
    };

    const fetchLocations = async () => {
      try {
        const res = await fetch('/api/locations');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data.success) throw new Error('Invalid response');
        return data.locations.map(l => ({
          name: l.name,
          lat: Number(l.lat),
          long: Number(l.long),
          radiusMeters: Number(l.radiusMeters)
        }));
      } catch (err) {
        showPopup('Location Error', `Failed to load locations: ${err.message}`, false);
        return [];
      }
    };

    const startLocationWatch = () => {
      const statusEl = document.getElementById('status');
      const gpsEl = document.getElementById('gpsCoords');
      const userIdInput = document.getElementById('userId');
      const userIdStatus = document.getElementById('userIdStatus');
      const clockInBtn = document.getElementById('clockIn');
      const clockOutBtn = document.getElementById('clockOut');

      userIdInput.disabled = true;
      clockInBtn.disabled = clockOutBtn.disabled = true;

      let lastValidatedId = '';

      const validateUser = async () => {
        let userId = userIdInput.value.trim();
        if (!userId) return;

        if (userId === lastValidatedId) return;
        lastValidatedId = userId;

        userIdStatus.className = 'loading';
        userIdStatus.textContent = 'Validating...';

        const staff = await getStaffByUserId(userId);
        if (!staff) {
          userIdStatus.className = 'invalid';
          userIdStatus.textContent = `User ${userId} not found`;
          clockInBtn.disabled = clockOutBtn.disabled = true;
          return;
        }
        if (staff.active.toLowerCase() !== 'yes') {
          userIdStatus.className = 'inactive';
          userIdStatus.textContent = `User ${userId}: ${staff.name} - Inactive`;
          clockInBtn.disabled = clockOutBtn.disabled = true;
          return;
        }

        const approved = current_office && staff.allowedLocations.includes(current_office.toLowerCase());
        userIdStatus.className = approved ? 'valid' : 'invalid';
        userIdStatus.textContent = `User ${userId}: ${staff.name} ‚Äì ${approved ? 'Approved' : 'Denied'}`;
        clockInBtn.disabled = clockOutBtn.disabled = !approved;
      };

      // FIXED: Instant clear + proper debounce
      userIdInput.addEventListener('input', () => {
        clearTimeout(window.validateTimeout);
        const val = userIdInput.value.trim();

        if (!val) {
          userIdStatus.className = 'placeholder';
          userIdStatus.textContent = 'Enter User ID to validate';
          lastValidatedId = '';
          clockInBtn.disabled = clockOutBtn.disabled = true;
          return;
        }

        userIdStatus.className = 'loading';
        userIdStatus.textContent = 'Validating...';
        window.validateTimeout = setTimeout(validateUser, 400);
      });

      fetchLocations().then(fetched => {
        locations = fetched;
        if (!locations.length) {
          statusEl.textContent = 'No locations configured.';
          return;
        }

        if (!navigator.geolocation) {
          showPopup('GPS Error', 'Geolocation not supported.', false);
          return;
        }

        watchId = navigator.geolocation.watchPosition(
          pos => {
            const { latitude, longitude } = pos.coords;
            statusEl.dataset.lat = latitude;
            statusEl.dataset.long = longitude;
            gpsEl.textContent = `GPS: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;

            current_office = null;
            for (const loc of locations) {
              const dist = getDistanceKm(latitude, longitude, loc.lat, loc.long);
              if (dist <= loc.radiusMeters / 1000) {
                current_office = loc.name;
                break;
              }
            }

            // Office name with pin
            statusEl.innerHTML = current_office 
              ? `<span class="office-pin">${current_office}</span>` 
              : 'Outside approved area';

            userIdInput.disabled = !current_office;

            if (!current_office) {
              userIdInput.value = '';
              userIdStatus.className = 'placeholder';
              userIdStatus.textContent = 'Enter User ID to validate';
              clockInBtn.disabled = clockOutBtn.disabled = true;
            } else if (userIdInput.value.trim()) {
              validateUser();
            }
          },
          err => {
            statusEl.textContent = 'GPS signal required';
            gpsEl.textContent = 'GPS: No signal';
            showPopup('Location Required', 'Please enable GPS and stay within office.', false);
          },
          { enableHighAccuracy: true, maximumAge: 5000, timeout: 20000 }
        );
      });

      clockInBtn.onclick = () => handleClock('clock in');
      clockOutBtn.onclick = () => handleClock('clock out');
    };

    // FASTER + MORE RELIABLE FACE VERIFICATION (reduced threshold + 1.5s countdown)
    const validateFaceWithSubject = async (base64, subjectName) => {
      try {
        const res = await fetch('/api/proxy/face-recognition', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ file: base64, subject: subjectName })
        });
        if (!res.ok) return { ok: false, error: 'Face service unavailable' };
        const data = await res.json();
        if (data?.result?.[0]?.subjects?.length) {
          const match = data.result[0].subjects.find(s => s.subject === subjectName);
          if (match && match.similarity >= 0.60) { // Reduced from 0.7 ‚Üí 0.60 for speed
            return { ok: true, similarity: match.similarity };
          }
        }
        return { ok: false, error: 'Face not recognized' };
      } catch (err) {
        return { ok: false, error: 'Face service error' };
      }
    };

    const showFaceModal = async (staff, action) => {
      faceModal = document.getElementById('faceModal');
      videoEl = document.getElementById('video');
      captureStatus = document.getElementById('captureStatus');
      faceModal.classList.add('show');

      if (!await startVideo()) {
        hideFaceModal();
        return;
      }

      countdown = 2; // Reduced from 3 ‚Üí 2 seconds
      captureStatus.textContent = `Capturing in ${countdown}...`;
      countdownInterval = setInterval(async () => {
        countdown--;
        if (countdown > 0) {
          captureStatus.textContent = `Capturing in ${countdown}...`;
        } else {
          clearInterval(countdownInterval);
          captureStatus.textContent = 'Verifying...';
          await captureAndVerify(staff, action);
        }
      }, 1000);
    };

    // Rest of your functions (hideFaceModal, startVideo, stopVideo, captureAndVerify, submitAttendance, showPopup, etc.)
    // ‚Üí Keep exactly as before, just add sound to showPopup:

    const showPopup = (title, message, success = null) => {
      const popup = document.getElementById('popup');
      const header = document.getElementById('popupHeader');
      const msg = document.getElementById('popupMessage');
      header.textContent = title;
      header.className = success === true ? 'popup-header success' : success === false ? 'popup-header error' : 'popup-header';
      msg.innerHTML = message;
      popup.classList.add('show');

      // Play sound
      playSound(success === true ? 'success' : 'error');

      setTimeout(() => popup.classList.remove('show'), 6000);
      document.getElementById('popupCloseBtn').onclick = () => popup.classList.remove('show');
    };

    // Keep all other functions unchanged (handleClock, admin login, etc.)

    document.addEventListener('DOMContentLoaded', startLocationWatch);
    window.onunload = () => {
      if (watchId) navigator.geolocation.clearWatch(watchId);
      stopVideo();
    };
  </script>
</body>
</html>
