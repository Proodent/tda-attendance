<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tolon District Assembly Staff Attendance</title>
  <link rel="icon" type="image/png" href="/assets/favicon.png" />
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      text-align: center;
      margin: 0;
      padding: 20px;
      min-height: 85vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow-x: hidden;
    }

    .container {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      max-width: 600px;
      width: 90%;
      text-align: center;
      margin: auto 0;
    }

    h1 {
      color: #009245;
      margin-bottom: 15px;
      font-size: 1.4em;
    }

    h1 span { font-size: 1.0em; }
    h1 .subtitle { font-size: 0.80em; }

    #status, #location { margin: 10px 0; color: #333; }
    pre { white-space: pre-wrap; text-align: center; color: #333; }

    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 5px;
      background: #009245;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
    }

    #clockIn { background: #4CAF50; }
    #clockOut { background: #F44336; }

    button:hover:not(:disabled) { background: #006837; transform: scale(1.05); }
    #clockOut:hover:not(:disabled) { background: #d32f2f; }
    button:disabled { background: #ccc; cursor: not-allowed; opacity: 0.6; }

    #faceRecognition { display: none; margin-top: 10px; }
    #video, #canvas { display: block; margin: 0 auto; width: 100%; max-width: 480px; border-radius: 10px; }

    #loaderOverlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.9); z-index: 3000; justify-content: center; align-items: center; flex-direction: column;
    }
    .loader { border: 6px solid #f3f3f3; border-top: 6px solid #009245; border-radius: 50%; width: 55px; height: 55px; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    .popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); justify-content: center; align-items: center; z-index: 2000; animation: popupFadeIn 0.3s forwards; }
    .popup.show { display: flex; }
    @keyframes popupFadeIn { from { opacity: 0; } to { opacity: 1; } }

    .popup-content { background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 380px; text-align: center; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-15px); } to { opacity: 1; transform: translateY(0); } }

    .popup-header { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; padding: 8px; border-radius: 6px; }
    .popup-header.success { background: linear-gradient(135deg, #4CAF50, #45a049); color: #fff; }
    .popup-header.error { background: linear-gradient(135deg, #F44336, #d32f2f); color: #fff; }

    .popup-icon { font-size: 28px; margin: 10px 0; animation: pop 0.4s ease-in-out; }
    .popup-icon.success { color: #4CAF50; animation: bounce 0.6s ease-in-out; }
    .popup-icon.error { color: #F44336; animation: shake 0.5s ease-in-out; }

    @keyframes pop { from { transform: scale(0.6); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }

    .footer { margin-top: auto; font-size: 0.9em; color: #666; padding: 10px 0; text-align: center; border-top: 1px solid #eee; width: 100%; }
    .footer a { color: #009245; text-decoration: none; }
    .footer a:hover { text-decoration: underline; }

    #adminPopup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); justify-content: center; align-items: center; z-index: 2000; }
    #adminPopup.show { display: flex; }
    #adminPopupContent { background: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 380px; text-align: center; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); }
    #adminPopupContent h2 { font-size: 1.2em; margin-bottom: 20px; color: #009245; }
    #adminPopupContent input { display: block; width: 80%; margin: 10px auto; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; }
    #adminPopupContent button { margin-top: 15px; padding: 10px 20px; font-size: 1em; }
    #adminError { color: #F44336; margin-top: 10px; font-size: 0.9em; }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      <span>Tolon District Assembly</span><br>
      <span class="subtitle">Staff Attendance Management</span>
    </h1>
    <p id="status">Initializing camera...</p>
    <pre id="location">Location: Loading...</pre>
    <button id="clockIn" disabled>Clock In</button>
    <button id="clockOut" disabled>Clock Out</button>
    <p id="message"></p>
    <div id="faceRecognition">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas" width="112" height="112" style="display:none;"></canvas>
    </div>
  </div>

  <!-- Popup -->
  <div id="popup" class="popup">
    <div class="popup-content">
      <div class="popup-header" id="popupHeader"></div>
      <div id="popupIcon"></div>
      <div id="popupMessage"></div>
      <div class="popup-footer" id="popupFooter"></div>
      <div id="popupRetry"></div>
    </div>
  </div>

  <!-- Loader -->
  <div id="loaderOverlay">
    <div class="loader"></div>
    <p>Loading AI model...</p>
  </div>

  <!-- Footer -->
  <div class="footer">
    <div><button id="adminDashboard">Admin Dashboard</button></div>
    <div>Developed by: <a href="https://proodentit.com" target="_blank">Proodent IT Solutions</a></div>
  </div>

  <!-- Admin Login -->
  <div id="adminPopup" class="popup">
    <div id="adminPopupContent">
      <h2>Admin Login</h2>
      <input type="email" id="adminEmail" placeholder="Enter Email" />
      <input type="password" id="adminPassword" placeholder="Enter Password" />
      <button onclick="loginAdmin()">Login</button>
      <p id="adminError" class="error"></p>
    </div>
  </div>

  <script>
    const backendURL = "https://tolon-attendance.proodentit.com/api";
    let faceMatcher = null;
    let isInitialized = false;
    let currentAction = null;

    // IndexedDB
    const openDB = () => new Promise((resolve, reject) => {
      const req = indexedDB.open('tolon-faces', 1);
      req.onupgradeneeded = () => req.result.createObjectStore('staff');
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });

    // Init Face Recognition with Tiny Models + Progress
    async function initFaceRecognition() {
      if (isInitialized) return;
      showLoader("Loading AI model...");

      const progress = document.createElement('div');
      progress.style.width = '80%'; progress.style.height = '6px'; progress.style.background = '#eee';
      progress.style.borderRadius = '3px'; progress.style.marginTop = '10px'; progress.style.overflow = 'hidden';
      const bar = document.createElement('div');
      bar.style.height = '100%'; bar.style.width = '0%'; bar.style.background = '#009245'; bar.style.transition = 'width 0.3s';
      progress.appendChild(bar);
      document.querySelector('#loaderOverlay').appendChild(progress);

      try {
        await faceapi.nets.tinyFaceDetector.loadFromUri('/models', {
          onProgress: (p) => bar.style.width = `${p * 100}%`
        });
        await faceapi.nets.faceLandmark68Net.loadFromUri('/models');
        await faceapi.nets.faceRecognitionNet.loadFromUri('/models');

        const db = await openDB();
        const tx = db.transaction('staff', 'readonly');
        const store = tx.objectStore('staff');
        const cached = await new Promise(r => store.getAll().onsuccess = e => r(e.target.result));

        if (cached.length > 0) {
          const descriptors = cached.map(c => new faceapi.LabeledFaceDescriptors(c.name, c.embedding.map(parseFloat)));
          faceMatcher = new faceapi.FaceMatcher(descriptors, 0.6);
        } else {
          const res = await fetch(`${backendURL}/staff/embeddings`);
          const staff = await res.json();
          const descriptors = staff.map(s => new faceapi.LabeledFaceDescriptors(s.name, s.embedding.map(parseFloat)));
          faceMatcher = new faceapi.FaceMatcher(descriptors, 0.6);

          const tx2 = db.transaction('staff', 'readwrite');
          staff.forEach(s => tx2.store.put({ name: s.name, embedding: s.embedding }, s.id));
          await tx2.done;
        }

        hideLoader();
        isInitialized = true;
        enableButtons();
      } catch (e) {
        hideLoader();
        showPopup("Error", "AI model failed to load", "error");
      }
    }

    // Camera
    async function startCamera() {
      const video = document.getElementById('video');
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        video.srcObject = stream;
        video.onloadedmetadata = () => video.play();
      } catch (e) {
        showPopup("Camera Error", "Please allow camera access", "error");
      }
    }

    // Verify + Clock
    async function verifyAndClock(action) {
      if (!isInitialized) return;
      currentAction = action;
      showLoader("Verifying face...");

      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, 112, 112);

      const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.7));
      const img = await faceapi.bufferToImage(blob);

      const detection = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptor();

      hideLoader();

      if (!detection) {
        showPopup("No Face", "Please face the camera", "error");
        return;
      }

      const result = faceMatcher.findBestMatch(detection.descriptor);
      if (result.distance > 0.6) {
        showPopup("Not Recognized", "Face not in database", "error");
        return;
      }

      await clockInOut(result.label, action);
    }

    async function clockInOut(name, action) {
      try {
        const res = await fetch(`${backendURL}/clock`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, action, timestamp: new Date().toISOString() })
        });
        const data = await res.json();
        showPopup("Success", data.message, "success");
      } catch (e) {
        showPopup("Error", "Clock failed. Try again.", "error");
      }
    }

    function enableButtons() {
      document.getElementById('clockIn').disabled = false;
      document.getElementById('clockOut').disabled = false;
    }

    function showLoader(msg) {
      const overlay = document.getElementById('loaderOverlay');
      overlay.style.display = 'flex';
      overlay.querySelector('p').textContent = msg;
    }

    function hideLoader() {
      document.getElementById('loaderOverlay').style.display = 'none';
    }

    function showPopup(title, msg, type) {
      const popup = document.getElementById('popup');
      document.getElementById('popupHeader').textContent = title;
      document.getElementById('popupHeader').className = `popup-header ${type}`;
      document.getElementById('popupMessage').textContent = msg;
      document.getElementById('popupIcon').textContent = type === 'success' ? 'Checkmark' : 'Cross';
      document.getElementById('popupIcon').className = `popup-icon ${type}`;
      popup.classList.add('show');
      setTimeout(() => popup.classList.remove('show'), 3000);
    }

    window.loginAdmin = async () => {
      const email = document.getElementById('adminEmail').value;
      const pass = document.getElementById('adminPassword').value;
      try {
        const res = await fetch(`${backendURL}/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password: pass })
        });
        if (res.ok) {
          localStorage.setItem('isLoggedIn', 'true');
          window.location.href = 'stats.html';
        } else {
          document.getElementById('adminError').textContent = 'Invalid credentials';
        }
      } catch (e) {
        document.getElementById('adminError').textContent = 'Network error';
      }
    };

    // Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .catch(err => console.log('SW failed:', err));
      });
    }

    // Init
    document.addEventListener('DOMContentLoaded', async () => {
      await startCamera();
      await initFaceRecognition();
      document.getElementById('clockIn').onclick = () => verifyAndClock('in');
      document.getElementById('clockOut').onclick = () => verifyAndClock('out');
      document.getElementById('adminDashboard').onclick = () => document.getElementById('adminPopup').classList.add('show');
    });
  </script>
</body>
</html>
