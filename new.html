<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tolon District Assembly | Staff Attendance</title>
  <link rel="icon" href="/assets/favicon.png" />
  
  <!-- CompreFace SDK (Fast) -->
  <script src="https://unpkg.com/compreface-javascript-sdk@2.3.2/dist/compreface.js"></script>

  <style>
    /* YOUR ORIGINAL DESIGN â€” 100% PRESERVED */
    body {font-family:Arial,sans-serif;background:#f7f7f7;text-align:center;margin:0;padding:20px;min-height:85vh;display:flex;flex-direction:column;justify-content:center;align-items:center;overflow-x:hidden}
    .container {background:#fff;padding:20px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.15);max-width:600px;width:90%;margin:auto 0}
    h1 {color:#009245;font-size:1.4em;margin-bottom:15px}
    h1 span {font-size:1em}
    .subtitle {font-size:.8em}
    #status,#location {margin:10px 0;color:#333}
    button {padding:10px 20px;font-size:16px;margin:5px;background:#009245;color:#fff;border:none;border-radius:5px;cursor:pointer;transition:.3s}
    #clockIn {background:#4CAF50}
    #clockOut {background:#F44336}
    button:hover:not(:disabled){transform:scale(1.05)}
    #clockOut:hover:not(:disabled){background:#d32f2f}
    button:disabled {background:#ccc;opacity:.6;cursor:not-allowed}
    #video {width:100%;max-width:480px;border-radius:10px}
    #loaderOverlay {display:none;position:fixed;inset:0;background:rgba(255,255,255,.9);z-index:9999;justify-content:center;align-items:center;flex-direction:column}
    .loader {border:6px solid #f3f3f3;border-top:6px solid #009245;border-radius:50%;width:55px;height:55px;animation:s 1s linear infinite;margin-bottom:15px}
    @keyframes s{100%{transform:rotate(360deg)}}
    #progress-bar {width:80%;height:6px;background:#eee;border-radius:3px;overflow:hidden}
    #progress-fill {height:100%;width:0%;background:#009245;transition:width .3s}
    .popup {display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:2000;justify-content:center;align-items:center}
    .popup.show {display:flex}
    .popup-content {background:#fff;padding:25px;border-radius:12px;width:90%;max-width:380px;text-align:center;animation:f .3s}
    @keyframes f{from{opacity:0;transform:translateY(-15px)}to{opacity:1;transform:none}}
    .popup-header {font-weight:bold;padding:8px;border-radius:6px;margin-bottom:10px}
    .popup-header.success {background:#4CAF50;color:#fff}
    .popup-header.error {background:#F44336;color:#fff}
    .popup-icon {font-size:28px;margin:10px 0}
    .footer {margin-top:auto;font-size:.9em;color:#666;padding:10px;width:100%;border-top:1px solid #eee}
    #adminPopup.show {display:flex}
    #adminError {color:#F44336;margin-top:10px}
  </style>
</head>
<body>
  <div class="container">
    <h1><span>Tolon District Assembly</span><br><span class="subtitle">Staff Attendance Management</span></h1>
    <p id="status">Loading...</p>
    <pre id="location">Location: Detecting...</pre>
    <button id="clockIn" disabled>Clock In</button>
    <button id="clockOut" disabled>Clock Out</button>
    <div id="faceRecognition" style="display:none;margin-top:15px">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas" style="display:none"></canvas>
    </div>
  </div>

  <div id="loaderOverlay">
    <div class="loader"></div>
    <p>Verifying face...</p>
    <div id="progress-bar"><div id="progress-fill"></div></div>
  </div>

  <div id="popup" class="popup">
    <div class="popup-content">
      <div class="popup-header" id="popupHeader"></div>
      <div class="popup-icon" id="popupIcon"></div>
      <div id="popupMessage"></div>
      <div style="font-size:.8em;color:#777" id="popupFooter"></div>
    </div>
  </div>

  <div class="footer">
    <button id="adminDashboard">Admin Dashboard</button><br><br>
    Developed by: <a href="https://proodentit.com" target="_blank">Proodent IT Solutions</a>
  </div>

  <div id="adminPopup" class="popup">
    <div class="popup-content">
      <h2>Admin Login</h2>
      <input type="email" id="adminEmail" placeholder="Email" />
      <input type="password" id="adminPassword" placeholder="Password" />
      <button onclick="loginAdmin()">Login</button>
      <p id="adminError"></p>
    </div>
  </div>

  <script>
    // === SECURE CONFIG FROM .env ===
    let CONFIG = {};
    async function loadConfig() {
      const r = await fetch('/api/config');
      CONFIG = await r.json();
    }

    // === COMPRE FACE (INSTANT) ===
    let cf = null;
    async function initCF() {
      if (cf) return;
      await loadConfig();
      const { CompreFace } = window;
      cf = new CompreFace({
        baseUrl: CONFIG.COMPREFACE_URL,
        apiKey: CONFIG.COMPREFACE_API_KEY
      });
    }

    // === UI HELPERS ===
    function showLoader(txt="Verifying...") {
      const l = document.getElementById('loaderOverlay');
      l.style.display = 'flex';
      l.querySelector('p').textContent = txt;
      document.getElementById('progress-fill').style.width = '0%';
    }
    function prog(p) { document.getElementById('progress-fill').style.width = p + '%'; }
    function hideLoader() { setTimeout(() => document.getElementById('loaderOverlay').style.display = 'none', 300); }

    function popup(title, msg, type) {
      const p = document.getElementById('popup');
      document.getElementById('popupHeader').textContent = title;
      document.getElementById('popupHeader').className = 'popup-header ' + type;
      document.getElementById('popupIcon').textContent = type === 'success' ? 'Check' : 'Cross';
      document.getElementById('popupMessage').textContent = msg;
      document.getElementById('popupFooter').textContent = new Date().toLocaleString();
      p.classList.add('show');
      setTimeout(() => p.classList.remove('show'), 4000);
    }

    // === CAMERA ===
    async function startCam() {
      const v = document.getElementById('video');
      const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
      v.srcObject = s;
      await v.play();
    }
    function stopCam() {
      document.getElementById('video').srcObject?.getTracks().forEach(t => t.stop());
    }

    // === CAPTURE 224x224 (40 KB) ===
    function snap() {
      const c = document.createElement('canvas');
      c.width = 224; c.height = 224;
      const ctx = c.getContext('2d');
      ctx.drawImage(document.getElementById('video'), 0, 0, 224, 224);
      return new Promise(r => c.toBlob(r, 'image/jpeg', 0.8));
    }

    // === FACE VERIFY (<0.7s) ===
    async function verify(blob, action) {
      if (!cf) await initCF();
      showLoader('Recognizing...');
      prog(30);
      const fd = new FormData();
      fd.append('file', blob, 'face.jpg');
      prog(60);
      const res = await cf.recognition.recognize(fd, { limit: 1, det_prob_threshold: 0.8 });
      prog(90);
      const m = res.result?.[0]?.subjects?.[0];
      if (!m || m.similarity < 0.85) throw 'Face not recognized';
      await clock(m.subject, action);
    }

    // === CLOCK IN/OUT ===
    async function clock(name, action) {
      const loc = document.getElementById('location');
      const body = {
        action,
        subjectName: name,
        latitude: loc.dataset.lat,
        longitude: loc.dataset.long,
        timestamp: new Date().toISOString()
      };
      const r = await fetch('/api/attendance/web', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const d = await r.json();
      prog(100); hideLoader();
      popup('Success', d.message || `${action} recorded!`, 'success');
    }

    // === GPS (RUNS IN BACKGROUND) ===
    let gpsOk = false;
    function initGPS() {
      navigator.geolocation.watchPosition(p => {
        const lat = p.coords.latitude.toFixed(6);
        const lng = p.coords.longitude.toFixed(6);
        document.getElementById('location').dataset.lat = lat;
        document.getElementById('location').dataset.long = lng;
        document.getElementById('location').textContent = `Location: GPS Ready\n${lat}, ${lng}`;
        document.getElementById('status').textContent = 'Ready to Clock';
        document.getElementById('clockIn').disabled = false;
        document.getElementById('clockOut').disabled = false;
        gpsOk = true;
      }, () => {}, { enableHighAccuracy: true });
    }

    // === MAIN CLOCK BUTTONS ===
    async function doClock(action) {
      if (!gpsOk) return popup('Error', 'Wait for GPS', 'error');
      document.getElementById('faceRecognition').style.display = 'block';
      await startCam();
      await new Promise(r => setTimeout(r, 800));
      const blob = await snap();
      stopCam();
      document.getElementById('faceRecognition').style.display = 'none';
      try { await verify(blob, action); }
      catch (e) { hideLoader(); popup('Failed', e, 'error'); }
    }

    // === ADMIN ===
    window.loginAdmin = async () => {
      const e = document.getElementById('adminEmail').value.trim();
      const p = document.getElementById('adminPassword').value;
      if (!e || !p) return document.getElementById('adminError').textContent = 'Fill all';
      const r = await fetch('/api/admin/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: e, password: p })
      });
      if (r.ok) {
        localStorage.setItem('adminToken', await r.text());
        location.href = 'stats.html';
      } else {
        document.getElementById('adminError').textContent = 'Wrong credentials';
      }
    };

    // === START ===
    document.addEventListener('DOMContentLoaded', () => {
      initGPS();
      document.getElementById('clockIn').onclick = () => doClock('clock in');
      document.getElementById('clockOut').onclick = () => doClock('clock out');
      document.getElementById('adminDashboard').onclick = () => document.getElementById('adminPopup').classList.add('show');
      document.querySelectorAll('.popup').forEach(p => p.addEventListener('click', e => e.target === p && p.classList.remove('show')));
    });
  </script>
</body>
</html>
