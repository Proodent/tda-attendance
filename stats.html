<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Dashboard</title>
  <link rel="icon" type="image/png" href="/assets/favicon.png"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf-autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {font-family:'Inter',sans-serif;background:linear-gradient(135deg,#f0f4f8 0%,#d9e2ec 100%);color:#1a202c;margin:0;padding:0;min-height:100vh;}
    header {background:linear-gradient(90deg,#48bb78 0%,#38a169 100%);color:#fff;padding:0.75rem 1rem;font-size:1.4rem;font-weight:700;box-shadow:0 4px 6px rgba(0,0,0,0.1);display:flex;align-items:center;justify-content:space-between;gap:0.5rem;}
    header img {height:2rem;}
    header .title {flex:1;text-align:center;font-size:1.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    header .logout-icon {width:2rem;height:2rem;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.1rem;cursor:pointer;transition:all .2s;}
    header .logout-icon:hover {background:#e53e3e;color:#fff;}
    #summary-tiles {display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;padding:1.5rem;}
    .tile {background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);padding:1rem;text-align:center;transition:transform .2s;}
    .tile:hover {transform:translateY(-5px);}
    .tile h3 {color:#2d3748;font-size:.875rem;margin-bottom:.5rem;}
    .tile p {font-size:1.5rem;font-weight:700;margin:0;color:#48bb78;}
    #avg-times {display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;padding:0 1.5rem 1.5rem;}
    .avg-tile {background:#fff;border-radius:12px;padding:1rem;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
    .avg-tile p {font-size:1.6rem;font-weight:700;color:#48bb78;}
    #stats-container {display:grid;grid-template-columns:repeat(4,1fr);gap:1.5rem;padding:1.5rem;}
    .chart-tile {background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);padding:1.25rem;transition:transform .2s;height:320px;display:flex;flex-direction:column;}
    .chart-tile:hover {transform:translateY(-5px);}
    .chart-tile h3 {text-align:center;color:#2d3748;margin-bottom:1rem;font-size:1.1rem;font-weight:600;height:40px;display:flex;align-items:center;justify-content:center;}
    .chart-container {flex:1;position:relative;}
    .full-width-chart {grid-column:1/-1;height:380px;}
    #log-container {margin:1rem;padding:0;background:#1a202c;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);overflow:hidden;}
    #log-header {display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1rem;background:#2d3748;color:#fff;font-weight:600;}
    #clear-logs {background:#e53e3e;color:#fff;padding:0.25rem 0.75rem;border:none;border-radius:6px;font-size:0.8rem;cursor:pointer;}
    #log {background:#1a202c;color:#25e876;font-family:'Courier New',monospace;padding:1rem;height:180px;overflow-y:auto;font-size:.85rem;}
    #attendance-table {margin:1rem;padding:1.25rem;background:rgb(209,226,250);border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);overflow-x:auto;position:relative;}
    #attendance-table table {width:100%;border-collapse:collapse;min-width:600px;}
    #attendance-table th,#attendance-table td {padding:.75rem;text-align:left;border-bottom:1px solid #e2e8f0;font-size:.9rem;}
    #attendance-table th {background:#2d3748;color:#fff;cursor:pointer;position:relative;}
    #filters,#pdf-export {display:flex;gap:1rem;margin:1rem;padding:1.25rem;background:rgb(209,226,250);border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);flex-wrap:wrap;align-items:flex-end;}
    input,select {padding:.5rem;border-radius:6px;border:2px solid #e2e8f0;font-size:.875rem;width:100%;height:40px;}
    button {background:#48bb78;color:#fff;padding:0 1.5rem;border:none;border-radius:6px;cursor:pointer;font-size:.875rem;height:40px;transition:.2s;min-width:100px;}
    button:hover {background:#38a169;}
    .filter-group,.pdf-filter-group {flex:1;min-width:180px;}
    #staff-analysis {margin:1.5rem;padding:1.5rem;background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
    #staff-stats {display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-top:1rem;}
    .stat-box {background:#f8fafc;padding:1rem;border-radius:8px;text-align:center;}
    .stat-box p {font-size:1.4rem;font-weight:700;color:#48bb78;}
    .loader {display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9);z-index:10;justify-content:center;align-items:center;flex-direction:column;}
    .loader.active {display:flex;}
    .spinner {border:4px solid #f3f3f3;border-top:4px solid #48bb78;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin-bottom:10px;}
    @keyframes spin {0% {transform:rotate(0deg);} 100% {transform:rotate(360deg);}}
  </style>
</head>
<body>
  <!-- Your full HTML (header, tiles, charts, table, PDF, staff analysis, logs) -->
  <!-- Exactly the same as your current file â€” no changes needed here -->

  <script>
    const SPREADSHEET_ID = '1hGuj1yAy2zB1n8xQq_soIq8lMl_TYmz6x0KgTNtjP2A';
    const STATS_SHEET = 'Stats Sheet';
    const ATTENDANCE_SHEET = 'Attendance Sheet';

    const currentDate = new Date().toISOString().split('T')[0];
    let allStaff = [], staffAttendanceData = [], charts = {}, staffAnalysisChart = null;

    const log = msg => {
      const box = document.getElementById('log');
      box.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
      box.scrollTop = box.scrollHeight;
    };

    const fetchSheet = async (name) => {
      const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(name)}`;
      const txt = await fetch(url).then(r => r.text());
      const json = JSON.parse(txt.substr(47).slice(0, -2));
      const headers = json.table.cols.map(c => c.label);
      const rows = json.table.rows.map(r => r.c.map(cell => cell ? cell.v : null));
      return { headers, rows };
    };

    const timeToMinutes = t => t ? parseInt(t.split(':')[0])*60 + parseInt(t.split(':')[1]) : null;
    const minutesToTime = m => m == null ? '--:--' : `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;

    const initChart = (id, cfg) => {
      const ctx = document.getElementById(id).getContext('2d');
      if (charts[id]) charts[id].destroy();
      charts[id] = new Chart(ctx, {
        ...cfg,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'circle' } } },
          ...cfg.options
        }
      });
    };

    const loadDashboardData = async () => {
      document.getElementById('table-loader').classList.add('active');
      try {
        log('Loading Stats Sheet...');
        const { rows: stats } = await fetchSheet(STATS_SHEET);

        // Parse Stats Sheet exactly as your screenshot
        const metrics = {};
        const trend = {};
        const depts = {}, locs = {};
        stats.forEach(row => {
          const date = row[0];
          const present = row[1];
          const metric = row[2];
          const value = row[3];
          const dept = row[5];
          const deptTotal = row[6];
          const deptIn = row[7];
          const deptOut = row[8];
          const location = row[10];
          const locAssigned = row[11];
          const locIn = row[12];

          if (date) trend[date] = present || 0;
          if (metric) metrics[metric] = value;
          if (dept) {
            depts[dept] = depts[dept] || { total: 0, in: 0, out: 0 };
            depts[dept].total = deptTotal || 0;
            depts[dept].in = deptIn || 0;
            depts[dept].out = deptOut || 0;
          }
          if (location) {
            locs[location] = locIn || 0;
          }
        });

        // Update summary tiles
        const set = (id, v) => document.getElementById(id).innerText = v ?? '--';
        set('totalStaff', metrics['Total Staff']);
        set('activeStaff', metrics['Active Staff']);
        set('inactiveStaff', metrics['Inactive Staff']);
        set('clockInsToday', metrics['Clock-Ins Today']);
        set('clockOutsToday', metrics['Clock-Outs Today']);
        set('absentToday', metrics['Absent Today']);
        set('percentClockedIn', metrics['Attendance Rate %']);
        set('percentClockedOut', metrics['Departure Rate %']);
        set('avgReportingTime', metrics['Avg Clock-In Time']);
        set('avgDepartureTime', metrics['Avg Clock-Out Time']);

        // Charts
        initChart('generalAttendanceChart', 'doughnut', {
          data: { labels: ['Present', 'Absent'], datasets: [{ data: [metrics['Clock-Ins Today'], metrics['Absent Today']], backgroundColor: ['#48bb78', '#e2e8f0'] }] }
        });
        initChart('departmentChart', 'bar', {
          data: { labels: Object.keys(depts), datasets: [
            { label: 'Total Staff', data: Object.values(depts).map(d => d.total), backgroundColor: 'rgba(45,55,72,0.2)' },
            { label: 'Clock In', data: Object.values(depts).map(d => d.in), backgroundColor: '#48bb78' },
            { label: 'Clock Out', data: Object.values(depts).map(d => d.out), backgroundColor: '#f56565' }
          ]},
          options: { scales: { y: { beginAtZero: true } } }
        });
        initChart('locationChart', 'bar', {
          data: { labels: Object.keys(locs), datasets: [{ label: 'Clock-Ins', data: Object.values(locs), backgroundColor: '#48bb78' }] },
          options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });

        // 90-Day Trend
        const today = new Date();
        const labels = [], data = [];
        for (let i = 89; i >= 0; i--) {
          const d = new Date(today); d.setDate(d.getDate() - i);
          const ds = d.toISOString().split('T')[0];
          labels.push(ds);
          data.push(trend[ds] || 0);
        }
        initChart('trendChart', 'line', {
          data: { labels, datasets: [{ label: 'Clock-Ins', data, borderColor: '#48bb78', backgroundColor: 'rgba(72,187,120,0.1)', tension: 0.3, fill: true }] },
          options: { scales: { y: { beginAtZero: true } } }
        });

        // Load Attendance Sheet for table
        const selected = document.getElementById('date-select').value || currentDate;
        const { rows: att } = await fetchSheet(ATTENDANCE_SHEET);
        const dateIdx = 0, nameIdx = 2, userIdIdx = 3, deptIdx = 1, timeInIdx = 4, timeOutIdx = 5, locIdx = 6;
        staffAttendanceData = att.filter(r => r[dateIdx] === selected).map(r => ({
          userId: r[userIdIdx] || 'N/A',
          name: r[nameIdx] || '--',
          department: r[deptIdx] || '--',
          timeIn: r[timeInIdx] || '--',
          timeOut: r[timeOutIdx] || '--',
          clockInLocation: r[locIdx] || 'Unknown'
        }));

        updateTable(staffAttendanceData);
        document.getElementById('attendance-title').textContent = `Attendance Details - ${new Date(selected).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;

        log('Dashboard fully loaded from Stats Sheet & Attendance Sheet!');
      } catch (e) {
        log('ERROR: ' + e.message);
        alert('Check System Logs (bottom) for details');
      } finally {
        document.getElementById('table-loader').classList.remove('active');
      }
    };

    const updateTable = data => {
      const tbody = document.getElementById('attendance-body');
      tbody.innerHTML = data.map(r => `<tr>
        <td>${r.userId}</td>
        <td>${r.name}</td>
        <td>${r.department}</td>
        <td>${r.timeIn}</td>
        <td>${r.timeOut}</td>
        <td>${r.timeIn && r.timeOut ? calculateWorkTime(r.timeIn, r.timeOut) : 'N/A'}</td>
        <td>${r.clockInLocation}</td>
      </tr>`).join('');
      document.getElementById('attendance-count').textContent = `Showing ${data.length} entries`;
    };

    // Your existing analyzeStaff, exportToPDF, etc. can stay exactly the same

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('date-select').value = currentDate;
      document.getElementById('date-select').addEventListener('change', () => loadDashboardData(true));
      document.getElementById('analyze-staff').addEventListener('click', analyzeStaff);
      document.getElementById('pdf-export-btn').addEventListener('click', exportToPDF);
      loadDashboardData();
      setInterval(loadDashboardData, 60000);
    });
  </script>
</body>
</html>
