<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Dashboard</title>
  <link rel="icon" type="image/png" href="/assets/favicon.png"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf-autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {font-family:'Inter',sans-serif;background:linear-gradient(135deg,#f0f4f8 0%,#d9e2ec 100%);color:#1a202c;margin:0;padding:0;min-height:100vh;}
    header {background:linear-gradient(90deg,#48bb78 0%,#38a169 100%);color:#fff;padding:0.75rem 1rem;font-size:1.4rem;font-weight:700;box-shadow:0 4px 6px rgba(0,0,0,0.1);display:flex;align-items:center;justify-content:space-between;flex-wrap:nowrap;gap:0.5rem;}
    header img {height:2rem;} header .title {flex:1;text-align:center;font-size:1.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;} header .logout-icon {width:2rem;height:2rem;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.1rem;cursor:pointer;transition:all .2s;} header .logout-icon:hover {background:#e53e3e;color:#fff;}
    #summary-tiles {display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;padding:1.5rem;} .tile {background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);padding:1rem;text-align:center;transition:transform .2s;} .tile:hover {transform:translateY(-5px);} .tile h3 {color:#2d3748;font-size:.875rem;margin-bottom:.5rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;} .tile p {font-size:1.5rem;font-weight:700;margin:0;color:#48bb78;} .tile.error p {color:#f56565;}
    #avg-times {display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;padding:0 1.5rem 1.5rem;} .avg-tile {background:#fff;border-radius:12px;padding:1rem;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,0.1);} .avg-tile h3 {font-size:.9rem;color:#2d3748;margin-bottom:.5rem;} .avg-tile p {font-size:1.6rem;font-weight:700;color:#48bb78;}
    #stats-container {display:grid;grid-template-columns:repeat(4,1fr);gap:1.5rem;padding:1.5rem;} .chart-tile {background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);padding:1.25rem;transition:transform .2s;height:320px;display:flex;flex-direction:column;} .chart-tile:hover {transform:translateY(-5px);} .chart-tile h3 {text-align:center;color:#2d3748;margin-bottom:1rem;font-size:1.1rem;font-weight:600;height:40px;display:flex;align-items:center;justify-content:center;} .chart-container {flex:1;display:flex;align-items:center;justify-content:center;position:relative;min-height:0;} .chart-container canvas {max-width:100%!important;max-height:100%!important;} .full-width-chart {grid-column:1/-1;height:380px;} .full-width-chart .chart-container {height:280px;}
    #log-container {margin:1rem;padding:0;background:#1a202c;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);overflow:hidden;} #log-header {display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1rem;background:#2d3748;color:#fff;font-weight:600;} #clear-logs {background:#e53e3e;color:#fff;padding:0.25rem 0.75rem;border:none;border-radius:6px;font-size:0.8rem;cursor:pointer;} #clear-logs:hover {background:#c53030;} #log {background:#1a202c;color:#25e876;font-family:'Courier New',monospace;padding:1rem;height:180px;overflow-y:auto;font-size:.85rem;}
    #attendance-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;} #attendance-count {font-size:0.9rem;color:#4a5568;} #attendance-table {margin:1rem;padding:1.25rem;background:rgb(209,226,250);border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);overflow-x:auto;position:relative;} #attendance-table table {width:100%;border-collapse:collapse;min-width:600px;} #attendance-table th,#attendance-table td {padding:.75rem;text-align:left;border-bottom:1px solid #e2e8f0;font-size:.9rem;} #attendance-table th {background:#2d3748;color:#fff;cursor:pointer;white-space:nowrap;position:relative;} #attendance-table th:hover {background:#4a5568;} #attendance-table tr:nth-child(even){background:#f7fafc;} .asc::after, .desc::after {position:absolute;right:0.5rem;top:50%;transform:translateY(-50%);font-size:0.8rem;font-weight:bold;} .asc::after {content:"asc";} .desc::after {content:"des";}
    #filters,#pdf-export {display:flex;gap:1rem;margin:1rem;padding:1.25rem;background:rgb(209,226,250);border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);flex-wrap:wrap;align-items:flex-end;} #filters label,#pdf-export label {font-weight:600;color:#2d3748;font-size:.875rem;margin-bottom:.5rem;display:block;} input,select {padding:.5rem;border-radius:6px;border:2px solid #e2e8f0;font-size:.875rem;width:100%;height:40px;} input:focus,select:focus {border-color:#48bb78;outline:none;} button {background:#48bb78;color:#fff;padding:0 1.5rem;border:none;border-radius:6px;cursor:pointer;font-size:.875rem;height:40px;transition:.2s;min-width:100px;} button:hover {background:#38a169;} .filter-group,.pdf-filter-group {flex:1;min-width:180px;} .button-group {display:flex;gap:.5rem;flex-wrap:wrap;} .button-group .filter-group,.button-group .pdf-filter-group {min-width:auto;flex:1;}
    #staff-analysis {margin:1.5rem;padding:1.5rem;background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);position:relative;} #staff-analysis h3 {font-size:1.25rem;font-weight:600;color:#2d3748;margin-bottom:1rem;} #staff-filters {display:flex;gap:1rem;flex-wrap:wrap;align-items:flex-end;margin-bottom:1rem;} #staff-chart-tile {height:380px;margin-top:1rem;} #staff-stats {display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-top:1rem;} .stat-box {background:#f8fafc;padding:1rem;border-radius:8px;text-align:center;} .stat-box h4 {font-size:0.9rem;color:#4a5568;margin-bottom:0.5rem;} .stat-box p {font-size:1.4rem;font-weight:700;color:#48bb78;}
    .loader {display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);z-index:10;justify-content:center;align-items:center;} .loader.active {display:flex;} .spinner {border:4px solid #f3f3f3;border-top:4px solid #48bb78;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;} @keyframes spin {0% {transform:rotate(0deg);} 100% {transform:rotate(360deg);}}
    @media (max-width:1024px){ #stats-container{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:768px){ header{font-size:1.1rem;padding:0.5rem;} header img{height:1.6rem;} header .title{font-size:1rem;} header .logout-icon{width:1.8rem;height:1.8rem;font-size:1rem;} #summary-tiles{grid-template-columns:repeat(2,1fr);gap:.75rem;padding:1rem;} .tile h3{font-size:.8rem;}.tile p{font-size:1.25rem;} #avg-times{grid-template-columns:repeat(2,1fr);} .avg-tile h3{font-size:.8rem;}.avg-tile p{font-size:1.2rem;} #stats-container{grid-template-columns:1fr;gap:1rem;padding:1rem;} .chart-tile{height:280px;padding:1rem;} .full-width-chart{height:320px;} .full-width-chart .chart-container{height:220px;} #filters,#pdf-export{flex-direction:column;padding:1rem;} .filter-group,.pdf-filter-group{min-width:100%;} .button-group{width:100%;} #attendance-table {padding:0.75rem;} #attendance-table th,#attendance-table td {font-size:.75rem;padding:.5rem;} #staff-filters{flex-direction:column;} #staff-stats{grid-template-columns:1fr;} }
    @media (max-width:480px){ header{font-size:0.95rem;padding:0.5rem;} header img{height:1.4rem;} header .title{font-size:0.9rem;} header .logout-icon{width:1.6rem;height:1.6rem;font-size:0.9rem;} #log{height:120px;font-size:.75rem;} #attendance-header {flex-direction:column;align-items:flex-start;gap:0.5rem;} #attendance-count {text-align:right;width:100%;} }
  </style>
</head>
<body>
  <header>
    <img src="/assets/favicon.png" alt="logo" />
    <div class="title">Attendance Dashboard</div>
    <img src="/assets/favicon.png" alt="logo" />
    <span class="logout-icon" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></span>
  </header>
  <!-- SUMMARY TILES -->
  <section id="summary-tiles">
    <div class="tile"><h3>Total Staff</h3><p id="totalStaff">--</p></div>
    <div class="tile"><h3>Active Staff</h3><p id="activeStaff">--</p></div>
    <div class="tile"><h3>Clock-Ins</h3><p id="clockInsToday">--</p></div>
    <div class="tile"><h3>Clock-Outs</h3><p id="clockOutsToday">--</p></div>
    <div class="tile"><h3>Absent</h3><p id="absentToday">--</p></div>
    <div class="tile"><h3>Inactive Staff</h3><p id="inactiveStaff">--</p></div>
    <div class="tile"><h3>Clock-In Rate</h3><p id="percentClockedIn">--%</p></div>
    <div class="tile"><h3>Clock-Out Rate</h3><p id="percentClockedOut">--%</p></div>
  </section>
  <!-- AVERAGE TIMES -->
  <section id="avg-times">
    <div class="avg-tile"><h3>Avg Reporting Time</h3><p id="avgReportingTime">--:--</p></div>
    <div class="avg-tile"><h3>Avg Departure Time</h3><p id="avgDepartureTime">--:--</p></div>
  </section>
  <!-- CHARTS -->
  <section id="stats-container">
    <div class="chart-tile"><h3>General Attendance</h3><div class="chart-container"><canvas id="generalAttendanceChart"></canvas></div></div>
    <div class="chart-tile"><h3>Reporting</h3><div class="chart-container"><canvas id="reportingChart"></canvas></div></div>
    <div class="chart-tile"><h3>Departure</h3><div class="chart-container"><canvas id="departureChart"></canvas></div></div>
    <div class="chart-tile"><h3>Clocking</h3><div class="chart-container"><canvas id="clockingChart"></canvas></div></div>
    <div class="chart-tile full-width-chart"><h3>Department Attendance</h3><div class="chart-container"><canvas id="departmentChart"></canvas></div></div>
    <div class="chart-tile full-width-chart"><h3>Location Attendance</h3><div class="chart-container"><canvas id="locationChart"></canvas></div></div>
    <div class="chart-tile full-width-chart"><h3>90 Days Attendance Trend</h3><div class="chart-container"><canvas id="trendChart"></canvas></div></div>
  </section>
  <!-- FILTERS -->
  <section id="filters">
    <div class="filter-group"><label for="date-select">Select Date:</label><input type="date" id="date-select"></div>
    <div class="filter-group"><label for="department-select">Filter Department:</label><select id="department-select"><option value="">All Departments</option></select></div>
    <div class="filter-group"><label for="name-search">Search Name / User ID:</label><input type="text" id="name-search" placeholder="Search name or ID..."></div>
    <div class="button-group">
      <div class="filter-group"><label style="visibility:hidden;">.</label><button id="clear-filter-btn">Clear Filter</button></div>
      <div class="filter-group"><label style="visibility:hidden;">.</label><button id="export-btn">Export to CSV</button></div>
    </div>
  </section>
  <!-- TABLE -->
  <section id="attendance-table">
    <div id="attendance-header">
      <h3 id="attendance-title" class="text-xl font-semibold text-green-600">Attendance Details</h3>
      <p id="attendance-count">Showing 0 of 0 entries</p>
    </div>
    <div class="loader" id="table-loader"><div class="spinner"></div></div>
    <table>
      <thead>
        <tr>
          <th class="sortable" data-sort="userId">User ID</th>
          <th class="sortable" data-sort="name">Name</th>
          <th class="sortable" data-sort="department">Department</th>
          <th class="sortable" data-sort="timeIn">Time In</th>
          <th class="sortable" data-sort="timeOut">Time Out</th>
          <th class="sortable" data-sort="workTime">Work Time</th>
          <th class="sortable" data-sort="clockInLocation">Clock In Location</th>
        </tr>
      </thead>
      <tbody id="attendance-body"></tbody>
    </table>
  </section>
  <!-- PDF EXPORT -->
  <section id="pdf-export">
    <h3 class="text-xl font-semibold text-green-600">Export PDF</h3>
    <div class="pdf-filter-group"><label for="department-select-pdf">Select Department:</label><select id="department-select-pdf"><option value="">All Departments</option></select></div>
    <div class="pdf-filter-group"><label for="start-date">Start Date:</label><input type="date" id="start-date"></div>
    <div class="pdf-filter-group"><label for="end-date">End Date:</label><input type="date" id="end-date"></div>
    <div class="pdf-filter-group"><label for="month-select">Select Month:</label>
      <select id="month-select">
        <option value="">All Months</option><option value="01">January</option><option value="02">February</option><option value="03">March</option>
        <option value="04">April</option><option value="05">May</option><option value="06">June</option><option value="07">July</option>
        <option value="08">August</option><option value="09">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option>
      </select>
    </div>
    <div class="button-group"><div class="pdf-filter-group"><label style="visibility:hidden;">.</label><button id="pdf-export-btn">Export to PDF</button></div></div>
  </section>
  <!-- STAFF ANALYSIS -->
  <section id="staff-analysis">
    <h3>Individual Staff Attendance Analysis</h3>
    <div id="staff-filters">
      <div class="filter-group"><label for="staff-search">Search Staff:</label><input type="text" id="staff-search" placeholder="Enter name or ID..."></div>
      <div class="filter-group"><label for="period-select">Period:</label>
        <select id="period-select">
          <option value="7">1 Week</option>
          <option value="30">1 Month</option>
          <option value="90">3 Months</option>
          <option value="180">6 Months</option>
          <option value="365">1 Year</option>
        </select>
      </div>
      <div class="filter-group"><label style="visibility:hidden;">.</label><button id="analyze-staff">Analyze</button></div>
    </div>
    <div class="loader" id="staff-loader"><div class="spinner"></div></div>
    <div class="chart-tile full-width-chart" id="staff-chart-tile" style="display:none;">
      <h3 id="staff-chart-title">Attendance Trend</h3>
      <div class="chart-container"><canvas id="staffTrendChart"></canvas></div>
    </div>
    <div id="staff-stats" style="display:none;">
      <div class="stat-box"><h4>Avg Clock In</h4><p id="avgClockIn">--:--</p></div>
      <div class="stat-box"><h4>Avg Clock Out</h4><p id="avgClockOut">--:--</p></div>
      <div class="stat-box"><h4>Days Present</h4><p id="daysPresent">0 / 0</p></div>
      <div class="stat-box"><h4>Attendance %</h4><p id="attendancePercent">0%</p></div>
    </div>
  </section>
  <!-- LOGS -->
  <div id="log-container">
    <div id="log-header">
      <span>System Logs</span>
      <button id="clear-logs">Clear Logs</button>
    </div>
    <div id="log"></div>
  </div>
  <script>
  // --- CONFIG ---
  const backendURL = "https://tolon-attendance.proodentit.com/api";
  const currentDate = new Date().toISOString().split('T')[0];
  const SESSION_TIMEOUT = 12 * 60 * 60 * 1000;
  let timeoutId;

  const isLoggedIn = () => localStorage.getItem('isLoggedIn') === 'true';
  const logout = () => { clearTimeout(timeoutId); ['mousemove','keypress','click','scroll'].forEach(e=>document.removeEventListener(e,resetTimeout)); localStorage.removeItem('isLoggedIn'); localStorage.removeItem('lastActivity'); window.location.href = 'index.html'; };
  const resetTimeout = () => { localStorage.setItem('lastActivity', Date.now()); clearTimeout(timeoutId); timeoutId = setTimeout(() => { log('Session expired (12 h)'); alert('Session expired. Please log in again.'); logout(); }, SESSION_TIMEOUT); };
  const log = msg => { const box = document.getElementById('log'); const t = new Date().toLocaleTimeString(); box.innerHTML += `[${t}] ${msg}<br>`; box.scrollTop = box.scrollHeight; };

  // --- HELPERS ---
  async function fetchJSON(url) {
    log(`Fetching: ${url}`);
    const res = await fetch(url);
    if (!res.ok) { const text = await res.text().catch(()=>''); log(`Fetch failed ${res.status} ${res.statusText} - ${url}`); throw new Error(`HTTP ${res.status} - ${res.statusText} - ${text}`); }
    const txt = await res.text(); log(`Fetched ${url} (${txt.length} chars)`); return JSON.parse(txt);
  }
  const timeToMinutes = t => { if (!t || t === '--') return null; const [h,m] = t.split(':').map(Number); if (isNaN(h)||isNaN(m)) return null; return h*60 + m; };
  const minutesToTime = mins => { if (mins === null || isNaN(mins)) return '--:--'; const h = Math.floor(mins/60); const m = mins%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; };
  const minutesToClock = mins => { if (mins===null||isNaN(mins)) return 'N/A'; let h = Math.floor(mins/60); let m = mins%60; const ampm = h>=12? 'PM':'AM'; h = h%12||12; return `${h}:${String(m).padStart(2,'0')} ${ampm}`; };
  const avgTime = arr => { const valid = arr.filter(x=>x!==null); if (!valid.length) return null; return Math.round(valid.reduce((a,b)=>a+b,0)/valid.length); };
  const calculateWorkTime = (inT,outT) => { if (!inT||!outT) return 'N/A'; const diff = timeToMinutes(outT)-timeToMinutes(inT); if (isNaN(diff)) return 'N/A'; return `${Math.floor(diff/60)}h ${diff%60}m`; };

  // --- CHART HELPERS ---
  let charts = {};
  const destroyChart = id => { if (charts[id]) { charts[id].destroy(); delete charts[id]; } };
  const initChart = (id,type,cfg) => {
    const ctx = document.getElementById(id)?.getContext('2d'); if (!ctx) return;
    destroyChart(id);
    const defaultPlugins = { legend: { position: 'bottom', labels: { usePointStyle: true, pointStyle: 'circle' } } };
    charts[id] = new Chart(ctx, { type, data: cfg.data, options: { responsive:true, maintainAspectRatio:false, ...(cfg.options||{}), plugins: { ...(cfg.options?.plugins||{}), ...defaultPlugins } } });
  };

  // --- GLOBAL DATA CACHES / INDEXES ---
  let allStaff = [];
  let staffAttendanceData = [];
  let attendanceIndexByUserId = {};
  let attendanceIndexByName = {};
  let locationsCache = [];

  function buildIndexes() {
    attendanceIndexByUserId = {};
    attendanceIndexByName = {};
    (staffAttendanceData || []).forEach(r => {
      const uid = (r.userId||'').toString();
      if (uid) { attendanceIndexByUserId[uid] = attendanceIndexByUserId[uid] || []; attendanceIndexByUserId[uid].push(r); }
      const name = (r.name||'').toLowerCase(); if (name) { attendanceIndexByName[name] = attendanceIndexByName[name] || []; attendanceIndexByName[name].push(r); }
    });
    log('Built attendance indexes');
  }

  // --- SMART RANGE FETCH (try range endpoint first, fallback to per-day with concurrency limit) ---
  async function fetchRangeStats(startDate,endDate) {
    const s = startDate.toISOString().split('T')[0];
    const e = endDate.toISOString().split('T')[0];
    try {
      const r = await fetchJSON(`${backendURL}/stats?start=${s}&end=${e}`);
      if (r && (r.staffAttendance || r.trend || r.data)) return r;
    } catch (err) {
      log('Range endpoint failed, falling back to per-day: ' + err.message);
    }
    const days = [];
    const cur = new Date(startDate);
    while (cur <= endDate) { days.push(new Date(cur)); cur.setDate(cur.getDate()+1); }
    const results = [];
    const concurrency = 6;
    let i = 0;
    async function worker() {
      while (i < days.length) {
        const idx = i++;
        const d = days[idx];
        const dateStr = d.toISOString().split('T')[0];
        try {
          const res = await fetchJSON(`${backendURL}/stats?date=${dateStr}`);
          res.date = dateStr;
          results.push(res);
        } catch (e) {
          log(`Failed to fetch ${dateStr}: ${e.message}`);
        }
      }
    }
    await Promise.all(Array.from({length:concurrency}).map(worker));
    const combined = { staffAttendance: [], trend: [] };
    results.forEach(r => { if (Array.isArray(r.staffAttendance)) combined.staffAttendance.push(...r.staffAttendance); if (r.trend) combined.trend.push(...r.trend); });
    return combined;
  }

  // --- MAIN DASHBOARD LOAD ---
  async function loadDashboardData(showLoader=false) {
    if (!isLoggedIn()) { logout(); return; }
    const selected = document.getElementById('date-select').value || currentDate;
    log(`Loading dashboard for ${selected}`);
    if (showLoader) document.getElementById('table-loader').classList.add('active');
    try {
      const staffRes = await fetchJSON(`${backendURL}/staff`);
      allStaff = staffRes.staff || [];
      const totalStaff = staffRes.totalStaff ?? allStaff.length;
      const active = staffRes.staffCount ?? allStaff.filter(s=>s.active).length;
      const inactive = totalStaff - active;
      const stats = await fetchJSON(`${backendURL}/stats?date=${selected}`);
      staffAttendanceData = stats.staffAttendance || [];
      buildIndexes();
      const depts = [...new Set(allStaff.map(s=>s.department))].filter(Boolean).sort();
      ['department-select','department-select-pdf'].forEach(id=>{
        const sel = document.getElementById(id); sel.innerHTML = '<option value="">All Departments</option>'; depts.forEach(d=>sel.appendChild(new Option(d,d)));
      });
      const inToday = staffAttendanceData.filter(e=>e.timeIn).length;
      const outToday = staffAttendanceData.filter(e=>e.timeOut).length;
      const both = staffAttendanceData.filter(e=>e.timeIn && e.timeOut).length;
      const partial = inToday - both;
      const absent = Math.max(0, active - inToday);
      const pctIn = active? Math.round(inToday/active*100):0;
      const pctOut = inToday? Math.round(outToday/inToday*100):0;
      const inMins = staffAttendanceData.map(e=>timeToMinutes(e.timeIn)).filter(t=>t!==null);
      const outMins = staffAttendanceData.map(e=>timeToMinutes(e.timeOut)).filter(t=>t!==null);
      const avgIn = avgTime(inMins); const avgOut = avgTime(outMins);
      const set = (id,v)=>document.getElementById(id).innerText = v;
      set('totalStaff', totalStaff); set('activeStaff', active); set('clockInsToday', inToday); set('clockOutsToday', outToday); set('absentToday', absent); set('inactiveStaff', inactive); set('percentClockedIn', pctIn+'%'); set('percentClockedOut', pctOut+'%'); set('avgReportingTime', minutesToTime(avgIn)); set('avgDepartureTime', minutesToTime(avgOut));
      initChart('generalAttendanceChart','doughnut',{ data:{ labels:['Present','Absent'], datasets:[{ data:[inToday,absent], backgroundColor:['#48bb78','#e2e8f0'] }] } });
      initChart('reportingChart','doughnut',{ data:{ labels:['Before 10 AM','After 10 AM'], datasets:[{ data:[staffAttendanceData.filter(e=>timeToMinutes(e.timeIn)!==null && timeToMinutes(e.timeIn)<600).length, staffAttendanceData.filter(e=>timeToMinutes(e.timeIn)!==null && timeToMinutes(e.timeIn)>=600).length], backgroundColor:['#48bb78','#e2e8f0'] }] } });
      const clockedOut = staffAttendanceData.filter(e=>e.timeOut);
      initChart('departureChart','doughnut',{ data:{ labels:['Before 4 PM','After 4 PM'], datasets:[{ data:[clockedOut.filter(e=>timeToMinutes(e.timeOut)!==null && timeToMinutes(e.timeOut)<960).length, clockedOut.filter(e=>timeToMinutes(e.timeOut)!==null && timeToMinutes(e.timeOut)>=960).length], backgroundColor:['#48bb78','#e2e8f0'] }] } });
      initChart('clockingChart','doughnut',{ data:{ labels:['Full Clocks','Half Clocks'], datasets:[{ data:[both,partial], backgroundColor:['#48bb78','#ff9800'] }] } });
      const sortedDepts = depts.slice().sort();
      const deptTotal = sortedDepts.map(d=>allStaff.filter(s=>s.department===d).length);
      const deptIn = sortedDepts.map(d=>staffAttendanceData.filter(e=>e.department===d && e.timeIn).length);
      const deptOut = sortedDepts.map(d=>staffAttendanceData.filter(e=>e.department===d && e.timeOut).length);
      initChart('departmentChart','bar',{ data:{ labels: sortedDepts, datasets:[ { label:'Total Staff', data: deptTotal, backgroundColor: 'rgba(45,55,72,0.2)' }, { label:'Clock In', data: deptIn, backgroundColor:'#48bb78' }, { label:'Clock Out', data: deptOut, backgroundColor:'#f56565' } ] }, options:{ scales:{ y:{ beginAtZero:true } } } });
      try { const locData = await fetchJSON(`${backendURL}/locations`); locationsCache = (locData.locations||[]).map(l=>l.name).sort(); } catch(e){ log('Could not fetch locations: '+e.message); locationsCache = [] }
      const locCounts = locationsCache.map(l=>staffAttendanceData.filter(e=>e.clockInLocation===l).length);
      initChart('locationChart','bar',{ data:{ labels: locationsCache, datasets:[{ label:'Attendance Count', data: locCounts, backgroundColor:'#48bb78' }] }, options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } } });
      let trendObj = { trend: [] };
      try {
        const start90 = new Date(); start90.setDate(start90.getDate()-89);
        const r = await fetchRangeStats(start90,new Date());
        if (Array.isArray(r.trend) && r.trend.length) trendObj = r;
        else if (Array.isArray(r.data) && r.data.length) trendObj.trend = r.data;
        else if (Array.isArray(r.staffAttendance) && r.staffAttendance.length) {
          const map = {};
          r.staffAttendance.forEach(e=>{ map[e.date] = (map[e.date]||0) + (e.timeIn?1:0); });
          trendObj.trend = Object.entries(map).map(([date,present])=>({date,present}));
        }
      } catch(e){ log('90d trend failed: '+e.message); }
      const trendMap = {};
      (trendObj.trend||[]).forEach(item => {
        if (!item) return;
        if (item.date && /^\d{4}-\d{2}-\d{2}$/.test(item.date)) { trendMap[item.date] = item.present||0; }
        else if (item.date && /\d{1,2}\s+[A-Za-z]{3}/.test(item.date)) {
          const parts = item.date.split(' '); const day = parseInt(parts[0]); const mon = parts[1]; const monthNames = {Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12}; const m = monthNames[mon]; if (m) { const y = new Date().getFullYear(); const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`; trendMap[dateStr] = item.present||0; }
        }
      });
      const today = new Date(); const trendLabels = []; const trendData = [];
      for (let i=89;i>=0;i--) { const d = new Date(today); d.setDate(d.getDate()-i); const s = d.toISOString().split('T')[0]; trendLabels.push(s); trendData.push(trendMap[s]||0); }
      initChart('trendChart','line',{ data:{ labels: trendLabels, datasets:[{ label:'Daily Present', data: trendData, borderColor:'#48bb78', backgroundColor:'rgba(72,187,120,0.15)', tension:0.4, fill:true, pointRadius:2 }] }, options:{ scales:{ y:{ beginAtZero:true, ticks:{ stepSize:5 } }, x:{ ticks:{ maxTicksLimit:12 } } } } });
      updateTable(staffAttendanceData);
      const dateStr = new Date(selected).toLocaleDateString('en-US', { month:'long', day:'numeric', year:'numeric' });
      document.getElementById('attendance-title').textContent = `Attendance Details - ${dateStr}`;
      log('Dashboard refreshed');
    } catch (err) { log('ERROR loading dashboard: '+err.message); console.error(err); }
    finally { if (showLoader) document.getElementById('table-loader').classList.remove('active'); }
  }

  // --- TABLE, SORT & FILTER ---
  let sortConfig = { key:null, dir:'asc' };
  function updateTable(data) {
    const tbody = document.getElementById('attendance-body');
    const dept = document.getElementById('department-select').value;
    const search = document.getElementById('name-search').value.trim().toLowerCase();
    const enriched = (data||[]).map(r=>{ const staff = allStaff.find(s=>s.name===r.name) || {}; return {...r, userId: r.userId || staff.userId || 'N/A'} });
    const filtered = enriched.filter(r => (!dept || r.department===dept) && (r.name.toLowerCase().includes(search) || (r.userId||'').toString().toLowerCase().includes(search)));
    const sorted = sortConfig.key ? filtered.slice().sort((a,b)=>{ let aVal = a[sortConfig.key]||''; let bVal = b[sortConfig.key]||''; if (sortConfig.key==='timeIn' || sortConfig.key==='timeOut') { aVal = timeToMinutes(aVal)||0; bVal = timeToMinutes(bVal)||0; } if (aVal < bVal) return sortConfig.dir==='asc'?-1:1; if (aVal > bVal) return sortConfig.dir==='asc'?1:-1; return 0; }) : filtered;
    tbody.innerHTML = sorted.map(r=>`<tr><td>${r.userId}</td><td>${r.name||'--'}</td><td>${r.department||'--'}</td><td>${r.timeIn||'--'}</td><td>${r.timeOut||'--'}</td><td>${calculateWorkTime(r.timeIn,r.timeOut)}</td><td>${r.clockInLocation||'Unknown'}</td></tr>`).join('');
    document.getElementById('attendance-count').textContent = `Showing ${sorted.length} of ${data.length} entries`;
  }

  // --- STAFF ANALYSIS (FAST) ---
  async function analyzeStaff() {
    const btn = document.getElementById('analyze-staff'); btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...'; document.getElementById('staff-loader').classList.add('active');
    try {
      const search = document.getElementById('staff-search').value.trim().toLowerCase(); const days = parseInt(document.getElementById('period-select').value,10)||7;
      log(`Analyze staff: "${search}" for ${days} days`);
      if (!search || !allStaff.length) { alert('Enter staff name or ID'); return; }
      let target = allStaff.find(s => (s.userId||'').toString().toLowerCase()===search) || allStaff.find(s => s.name && s.name.toLowerCase().includes(search));
      if (!target) {
        const nameMatches = Object.keys(attendanceIndexByName).find(n => n.includes(search));
        if (nameMatches) { const sample = attendanceIndexByName[nameMatches][0]; target = allStaff.find(s=>s.name===sample.name) || { name: sample.name, userId: sample.userId } }
      }
      if (!target) { alert('Staff not found'); log('No matching staff'); return; }
      log(`Target staff: ${target.name} (${target.userId})`);
      const endDate = new Date(); const startDate = new Date(); startDate.setDate(startDate.getDate()-days+1);
      let rangeData = null;
      try { rangeData = await fetchRangeStats(startDate,endDate); } catch(e){ log('Range fetch failed: '+e.message); }
      let staffEntries = [];
      if (rangeData && Array.isArray(rangeData.staffAttendance) && rangeData.staffAttendance.length) {
        staffEntries = rangeData.staffAttendance.filter(e => (e.userId && e.userId.toString()=== (target.userId||'').toString()) || (e.name && e.name===target.name)).map(e=>({ ...e, date: e.date||e.attendanceDate || e.dateRecorded }));
      } else {
        const uid = (target.userId||'').toString(); if (uid && attendanceIndexByUserId[uid]) {
          staffEntries = attendanceIndexByUserId[uid].filter(e=>{ const d = new Date(e.date||e.attendanceDate||e.createdAt); return !isNaN(d) && d>=startDate && d<=endDate && (e.timeIn||e.timeOut); }).map(e=>({...e, date: (e.date||e.attendanceDate||e.createdAt).toString().split('T')[0]}));
        } else if (attendanceIndexByName[target.name.toLowerCase()]) {
          staffEntries = attendanceIndexByName[target.name.toLowerCase()].filter(e=>{ const d=new Date(e.date||e.attendanceDate||e.createdAt); return !isNaN(d) && d>=startDate && d<=endDate && (e.timeIn||e.timeOut); }).map(e=>({...e, date: (e.date||e.attendanceDate||e.createdAt).toString().split('T')[0]}));
        } else {
          const fetched = await fetchRangeStats(startDate,endDate);
          staffEntries = (fetched.staffAttendance||[]).filter(e => (e.userId && e.userId.toString()=== (target.userId||'').toString()) || (e.name && e.name===target.name)).map(e=>({...e, date: e.date||e.attendanceDate}));
        }
      }
      log(`Staff entries found: ${staffEntries.length}`);
      if (!staffEntries.length) { alert('No attendance records found in this period'); return; }
      const inTimes = staffEntries.map(e=>timeToMinutes(e.timeIn)).filter(t=>t!==null);
      const outTimes = staffEntries.map(e=>timeToMinutes(e.timeOut)).filter(t=>t!==null);
      const avgIn = avgTime(inTimes); const avgOut = avgTime(outTimes);
      const workingDays = []; const presentSet = new Set(); const cur = new Date(startDate);
      while (cur <= endDate) { const day = cur.getDay(); if (day>=1 && day<=5) { const s = cur.toISOString().split('T')[0]; workingDays.push(s); if (staffEntries.some(e=>e.date===s && e.timeIn)) presentSet.add(s); } cur.setDate(cur.getDate()+1); }
      const daysPresent = presentSet.size; const totalWorkingDays = workingDays.length; const attendancePct = totalWorkingDays? Math.round(daysPresent/totalWorkingDays*100):0;
      const dateMap = {}; staffEntries.forEach(e=>{ if (!dateMap[e.date]) dateMap[e.date]={in:null,out:null}; if(e.timeIn) dateMap[e.date].in = timeToMinutes(e.timeIn); if(e.timeOut) dateMap[e.date].out = timeToMinutes(e.timeOut); });
      const inData = workingDays.map(d => dateMap[d]?.in ?? null);
      const outData = workingDays.map(d => dateMap[d]?.out ?? null);
      document.getElementById('staff-chart-title').textContent = `${target.name} - Clock Times`;
      document.getElementById('avgClockIn').textContent = minutesToTime(avgIn);
      document.getElementById('avgClockOut').textContent = minutesToTime(avgOut);
      document.getElementById('daysPresent').textContent = `${daysPresent} / ${totalWorkingDays}`;
      document.getElementById('attendancePercent').textContent = `${attendancePct}%`;
      document.getElementById('staff-chart-tile').style.display = 'block'; document.getElementById('staff-stats').style.display = 'grid';
      if (charts['staffTrendChart']) charts['staffTrendChart'].destroy();
      charts['staffTrendChart'] = new Chart(document.getElementById('staffTrendChart').getContext('2d'), {
        type: 'line', data: { labels: workingDays.map(d=>new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric'})), datasets: [ { label:'Clock In', data: inData, borderColor:'#48bb78', backgroundColor:'rgba(72,187,120,0.08)', tension:0.3, spanGaps:true, pointRadius:3 }, { label:'Clock Out', data: outData, borderColor:'#f56565', backgroundColor:'rgba(245,101,101,0.08)', tension:0.3, spanGaps:true, pointRadius:3 } ] },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins: {
            tooltip: { callbacks: { label: function(ctx){ const m = ctx.parsed.y; return ctx.dataset.label + ': ' + (m===null? 'N/A' : minutesToClock(m)); } } },
            legend: { labels: { usePointStyle:true, pointStyle:'circle' } }
        }, scales: { y: { beginAtZero:true, ticks: { callback: v => { if (v===null) return ''; const hh = Math.floor(v/60); const mm = v%60; return `${hh}:${String(mm).padStart(2,'0')}` } } } }
        }
      });
    } catch(e){ log('Analyze staff error: '+e.message); console.error(e); alert('Error analyzing staff: '+e.message); }
    finally { document.getElementById('staff-loader').classList.remove('active'); document.getElementById('analyze-staff').disabled = false; document.getElementById('analyze-staff').innerHTML = 'Analyze'; }
  }

  // --- PDF EXPORT (robust) ---
  async function exportToPDF() {
    try {
      const dept = document.getElementById('department-select-pdf').value;
      const start = document.getElementById('start-date').value; const end = document.getElementById('end-date').value; const month = document.getElementById('month-select').value;
      if ((!start || !end) && !month) { alert('Select a date range or month'); return; }
      let startDate, endDate; if (month) { const year=new Date().getFullYear(); startDate=new Date(year,parseInt(month)-1,1); endDate=new Date(year,parseInt(month),0); } else { startDate=new Date(start); endDate=new Date(end); }
      document.getElementById('table-loader').classList.add('active');
      const fetched = await fetchRangeStats(startDate,endDate);
      const rawData = fetched.staffAttendance||[];
      const map = {};
      rawData.forEach(dayEntry=>{ const name = dayEntry.name||'Unknown'; if (dept && dayEntry.department!==dept) return; if (!map[name]) map[name]={ userId:dayEntry.userId||'N/A', department: dayEntry.department||'--', days:{}, present:0}; const d = dayEntry.date || dayEntry.attendanceDate || new Date().toISOString().split('T')[0]; map[name].days[d] = { ti: dayEntry.timeIn||'--', to: dayEntry.timeOut||'--' }; if (dayEntry.timeIn) map[name].present++; });
      const workingDays=[]; const cur = new Date(startDate); while (cur<=endDate) { const day = cur.getDay(); if (day>=1 && day<=5) workingDays.push(cur.toISOString().split('T')[0]); cur.setDate(cur.getDate()+1); }
      const totalWorkingDays = workingDays.length;
      const headRow1 = ['User ID','Name','Dep\'t']; const headRow2=['','','']; workingDays.forEach((d,i)=>{ headRow1.push({content:`Date ${i+1}`, colSpan:2}); headRow2.push('CI','CO'); }); headRow1.push({content:'Avg.', colSpan:2}); headRow2.push('CI','CO'); headRow1.push('Days Present','% Present'); headRow2.push('','');
      const head=[headRow1, headRow2]; const body=[];
      Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([name,info])=>{ const inTimes=Object.values(info.days).map(d=>timeToMinutes(d.ti)).filter(t=>t!==null); const outTimes=Object.values(info.days).map(d=>timeToMinutes(d.to)).filter(t=>t!==null); const avgIn=minutesToTime(avgTime(inTimes)); const avgOut=minutesToTime(avgTime(outTimes)); const pct = totalWorkingDays? Math.round(info.present/totalWorkingDays*100):0; const row=[info.userId, name, info.department, ...workingDays.flatMap(d=>[info.days[d]?.ti||'--', info.days[d]?.to||'--']), avgIn, avgOut, `${info.present}/${totalWorkingDays}`, `${pct}%`]; body.push(row); });
      const { jsPDF } = window.jspdf; const doc = new jsPDF('landscape'); doc.setFontSize(12); doc.text('Geofence Attendance Management System', 10,10); doc.text(`Period: ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`, 10,18);
      doc.autoTable({ startY:22, head, body, styles:{ fontSize:8, cellPadding:2 }, margin:{ left:8 } }); doc.save('attendance_report.pdf');
    } catch(e){ log('PDF export failed: '+e.message); alert('PDF export failed: '+e.message); }
    finally { document.getElementById('table-loader').classList.remove('active'); }
  }

  // --- INIT ---
  document.addEventListener('DOMContentLoaded', ()=>{
    if (!isLoggedIn()) { window.location.href='index.html'; return; }
    document.getElementById('date-select').value = currentDate;
    document.getElementById('logoutBtn').addEventListener('click', ()=>{ log('Logout'); logout(); });
    document.getElementById('clear-logs').addEventListener('click', ()=>{ document.getElementById('log').innerHTML=''; log('Logs cleared'); });
    document.getElementById('clear-filter-btn').addEventListener('click', ()=>{ document.getElementById('date-select').value=currentDate; document.getElementById('department-select').value=''; document.getElementById('name-search').value=''; loadDashboardData(true); });
    document.getElementById('export-btn').addEventListener('click', ()=>{
      const enriched = staffAttendanceData.map(r=>{ const staff = allStaff.find(s=>s.name===r.name) || {}; return {...r, userId: r.userId || staff.userId || 'N/A'} });
      const csv = "data:text/csv;charset=utf-8,User ID,Name,Department,Time In,Time Out,Work Time,Location\n" + enriched.map(r=>`${r.userId},"${r.name}",${r.department},${r.timeIn},${r.timeOut},${calculateWorkTime(r.timeIn,r.timeOut)},${r.clockInLocation||'Unknown'}`).join('\n'); const a=document.createElement('a'); a.href=encodeURI(csv); a.download='attendance.csv'; a.click();
    });
    document.getElementById('date-select').addEventListener('change', ()=>loadDashboardData(true));
    document.getElementById('department-select').addEventListener('change', ()=>updateTable(staffAttendanceData));
    document.getElementById('name-search').addEventListener('input', ()=>updateTable(staffAttendanceData));
    document.getElementById('analyze-staff').addEventListener('click', analyzeStaff);
    document.getElementById('pdf-export-btn').addEventListener('click', exportToPDF);
    document.querySelectorAll('.sortable').forEach(th=>th.addEventListener('click', ()=>{ const key = th.dataset.sort; sortConfig.dir = sortConfig.key===key && sortConfig.dir==='asc' ? 'desc' : 'asc'; sortConfig.key = key; document.querySelectorAll('.sortable').forEach(t=>t.classList.remove('asc','desc')); th.classList.add(sortConfig.dir); updateTable(staffAttendanceData); }));
    ['mousemove','keypress','click','scroll'].forEach(ev=>document.addEventListener(ev, resetTimeout, {passive:true})); resetTimeout(); loadDashboardData(); setInterval(()=>loadDashboardData(false), 30000);
  });
  </script>
</body>
</html>
