<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Dashboard</title>
  <link rel="icon" href="favicon.ico" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f0f4f8 0%, #e9f7ef 100%);
      color: #1a202c;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    header {
      background: linear-gradient(90deg, #009245, #006837);
      color: white;
      padding: 1.5rem;
      text-align: center;
      font-size: 2rem;
      font-weight: 700;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    #summary-tiles {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      padding: 2rem;
    }
    .tile {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      text-align: center;
      transition: transform 0.2s;
    }
    .tile:hover { transform: translateY(-5px); }
    .tile h3 { color: #006837; font-size: 1.2rem; margin-bottom: 0.5rem; }
    .tile p { font-size: 2rem; font-weight: 700; margin: 0; color: #009245; }
    .tile.error p { color: #f56565; }

    #stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 1.5rem;
      padding: 2rem;
    }
    .chart-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
    }
    .chart-card h3 {
      text-align: center;
      color: #006837;
      margin-bottom: 1rem;
      font-size: 1.3rem;
      font-weight: 600;
    }

    canvas { width: 100% !important; height: 300px !important; }

    #log {
      background: #1a202c;
      color: #48bb78;
      font-family: 'Courier New', monospace;
      padding: 1rem;
      height: 180px;
      overflow-y: auto;
      margin: 2rem;
      border-radius: 8px;
    }

    #filters {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin: 2rem;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    #attendance-table {
      margin: 2rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
    }

    #attendance-table table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    th {
      background: #009245;
      color: white;
      cursor: pointer;
    }

    tr:nth-child(even) { background: #f7fafc; }

    #export-btn {
      background: #009245;
      color: white;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    #export-btn:hover { background: #006837; }
  </style>
</head>

<body>
  <header>Attendance Dashboard</header>

  <!-- Summary Tiles -->
  <section id="summary-tiles">
    <div class="tile"><h3>Total Staff</h3><p id="totalStaff">--</p></div>
    <div class="tile"><h3>Active Staff</h3><p id="activeStaff">--</p></div>
    <div class="tile"><h3>Present Today</h3><p id="presentToday">--</p></div>
    <div class="tile"><h3>Absent Today</h3><p id="absentToday">--</p></div>
  </section>

  <!-- Charts -->
  <section id="stats-container">
    <div class="chart-card"><h3>Attendance Summary</h3><canvas id="summaryChart"></canvas></div>
    <div class="chart-card"><h3>Active vs Inactive</h3><canvas id="activeChart"></canvas></div>
    <div class="chart-card"><h3>Monthly Trend</h3><canvas id="trendChart"></canvas></div>
    <div class="chart-card"><h3>Location Attendance</h3><canvas id="locationChart"></canvas></div>
  </section>

  <!-- Filters -->
  <section id="filters">
    <label>Date:</label>
    <input type="date" id="date-select" onchange="loadDashboardData()" />
    <label>Department:</label>
    <select id="department-select" onchange="filterTable()">
      <option value="">All</option>
    </select>
    <button id="export-btn" onclick="exportToCSV()">Export CSV</button>
  </section>

  <!-- Attendance Table -->
  <section id="attendance-table">
    <h3 id="attendance-title" class="text-xl font-semibold text-gray-800">Staff Attendance Details</h3>
    <table>
      <thead>
        <tr>
          <th>Name</th><th>Department</th><th>Time In</th><th>Time Out</th><th>Work Time</th><th>Clock In Location</th>
        </tr>
      </thead>
      <tbody id="attendance-body"></tbody>
    </table>
  </section>

  <div id="log"></div>

  <script>
    const backendURL = "https://tolon-attendance.proodentit.com/api";
    const logBox = document.getElementById("log");
    const log = (msg) => {
      const time = new Date().toLocaleTimeString();
      logBox.innerHTML += `[${time}] ${msg}<br>`;
      logBox.scrollTop = logBox.scrollHeight;
    };

    let summaryChart, activeChart, trendChart, locationChart;
    let staffData = [], staffAttendanceData = [];

    const calculateWorkTime = (inT, outT) => {
      if (!inT || !outT) return "N/A";
      const [ih, im] = inT.split(":").map(Number);
      const [oh, om] = outT.split(":").map(Number);
      const diff = (oh * 60 + om) - (ih * 60 + im);
      const h = Math.floor(diff / 60);
      const m = diff % 60;
      return `${h}h ${m}m`;
    };

    const fetchJSON = async (url) => {
      const res = await fetch(url);
      const txt = await res.text();
      try { return JSON.parse(txt); }
      catch { throw new Error("Response not JSON: " + txt.slice(0, 80)); }
    };

    async function loadDashboardData() {
      const date = document.getElementById("date-select").value || new Date().toISOString().split("T")[0];
      try {
        log("⏳ Loading dashboard...");

        const staff = await fetchJSON(`${backendURL}/staff`);
        staffData = staff.staff || [];
        const totalStaff = staffData.length;
        const activeStaff = staffData.filter(s => s.Active === "Yes").length;
        const inactiveStaff = totalStaff - activeStaff;

        const stats = await fetchJSON(`${backendURL}/stats?date=${date}`);
        staffAttendanceData = stats.staffAttendance || [];

        const present = stats.clockIns?.today || 0;
        const absent = Math.max(0, activeStaff - present);

        const locations = await fetchJSON(`${backendURL}/locations`);
        const locLabels = locations.locations.map(l => l.name);
        const locCounts = locLabels.map(name => staffAttendanceData.filter(a => a.clockInLocation === name).length);

        document.getElementById("totalStaff").textContent = totalStaff;
        document.getElementById("activeStaff").textContent = activeStaff;
        document.getElementById("presentToday").textContent = present;
        document.getElementById("absentToday").textContent = absent;

        updateSummaryChart(present, absent);
        updateActiveChart(activeStaff, inactiveStaff);
        updateTrendChart(stats.trend || []);
        updateLocationChart(locLabels, locCounts);
        updateTable(staffAttendanceData);

        const departments = [...new Set(staffData.map(s => s.department))];
        const sel = document.getElementById("department-select");
        sel.innerHTML = '<option value="">All</option>' + departments.map(d => `<option>${d}</option>`).join("");

        log("✅ Dashboard updated successfully.");
      } catch (err) {
        log("❌ " + err.message);
      }
    }

    function updateTable(data) {
      const body = document.getElementById("attendance-body");
      const dept = document.getElementById("department-select").value;
      body.innerHTML = "";
      const filtered = dept ? data.filter(d => d.department === dept) : data;
      filtered.forEach(r => {
        body.innerHTML += `<tr>
          <td>${r.name}</td>
          <td>${r.department}</td>
          <td>${r.timeIn || "--"}</td>
          <td>${r.timeOut || "--"}</td>
          <td>${calculateWorkTime(r.timeIn, r.timeOut)}</td>
          <td>${r.clockInLocation || "--"}</td>
        </tr>`;
      });
    }

    function updateSummaryChart(present, absent) {
      const ctx = document.getElementById("summaryChart");
      if (summaryChart) summaryChart.destroy();
      summaryChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["Present", "Absent"],
          datasets: [{ data: [present, absent], backgroundColor: ["#009245", "#e2e8f0"] }]
        },
        options: { plugins: { legend: { position: "bottom" } } }
      });
    }

    function updateActiveChart(active, inactive) {
      const ctx = document.getElementById("activeChart");
      if (activeChart) activeChart.destroy();
      activeChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Active", "Inactive"],
          datasets: [{ label: "Staff", data: [active, inactive], backgroundColor: ["#009245", "#f56565"] }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
    }

    function updateTrendChart(trend) {
      const ctx = document.getElementById("trendChart");
      if (trendChart) trendChart.destroy();
      const labels = trend.map(t => t.date);
      const values = trend.map(t => t.present);
      trendChart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets: [{ label: "Daily Present", data: values, borderColor: "#009245", fill: false }] },
        options: { plugins: { legend: { position: "bottom" } }, scales: { y: { beginAtZero: true } } }
      });
    }

    function updateLocationChart(labels, counts) {
      const ctx = document.getElementById("locationChart");
      if (locationChart) locationChart.destroy();
      locationChart = new Chart(ctx, {
        type: "bar",
        data: { labels, datasets: [{ label: "Attendance Count", data: counts, backgroundColor: "#006837" }] },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
    }

    function exportToCSV() {
      const csv = "Name,Department,Time In,Time Out,Work Time,Clock In Location\n" +
        staffAttendanceData.map(a => `${a.name},${a.department},${a.timeIn},${a.timeOut},${calculateWorkTime(a.timeIn, a.timeOut)},${a.clockInLocation}`).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "attendance.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    loadDashboardData();
    setInterval(loadDashboardData, 10000);
  </script>
</body>
</html>
