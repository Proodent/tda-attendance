<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    /* [Your existing CSS remains unchanged] */
  </style>
</head>
<body>
  <header>Attendance Dashboard</header>

  <section id="summary-tiles">
    <!-- [Your existing summary tiles remain unchanged] -->
  </section>

  <section id="stats-container">
    <!-- [Your existing chart tiles remain unchanged] -->
  </section>

  <section id="filters">
    <!-- [Your existing filters remain unchanged] -->
  </section>

  <section id="attendance-table">
    <!-- [Your existing attendance table remains unchanged] -->
  </section>

  <div id="log"></div>

  <script>
    const backendURL = "https://tolon-attendance.proodentit.com/api";
    const currentDate = "2025-10-18";
    const SHEET_ID = "YOUR_GOOGLE_SHEET_ID"; // Replace with your actual Sheet ID
    const API_KEY = "YOUR_API_KEY"; // Replace with your actual API Key

    const log = (msg) => {
      const logBox = document.getElementById("log");
      const time = new Date().toLocaleTimeString();
      logBox.innerHTML += `[${time}] ${msg}<br>`;
      logBox.scrollTop = logBox.scrollHeight;
    };

    let generalAttendanceChart, reportingChart, departureChart, departmentChart, locationChart, trendChart;
    let sortConfig = { key: null, direction: "asc" };
    let departments = [];
    let staffAttendanceData = [];

    async function fetchJSON(url) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status} - ${res.statusText}`);
        const text = await res.text();
        log(`Fetched from ${url}: ${text.substring(0, 100)}${text.length > 100 ? "..." : ""}`);
        return JSON.parse(text);
      } catch (e) {
        log(`❌ Fetch error for ${url}: ${e.message}`);
        throw e;
      }
    }

    async function fetchGoogleSheetData(range) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status} - ${res.statusText}`);
        const data = await res.json();
        log(`Fetched Google Sheet data: ${JSON.stringify(data.values?.slice(0, 5) || []).substring(0, 100)}${JSON.stringify(data.values).length > 100 ? "..." : ""}`);
        return data.values || [];
      } catch (e) {
        log(`❌ Fetch error for Google Sheet: ${e.message}`);
        return [];
      }
    }

    function calculateWorkTime(timeIn, timeOut) {
      if (!timeIn || !timeOut) return "N/A";
      const [inH, inM] = timeIn.split(":").map(Number);
      const [outH, outM] = timeOut.split(":").map(Number);
      const inMinutes = inH * 60 + inM;
      const outMinutes = outH * 60 + outM;
      const workMinutes = outMinutes - inMinutes;
      const hours = Math.floor(workMinutes / 60);
      const minutes = workMinutes % 60;
      return `${hours}h ${minutes}m`;
    }

    function updateTable(data) {
      // [Your existing updateTable function remains unchanged]
    }

    function filterTable() {
      updateTable(staffAttendanceData);
    }

    function clearFilters() {
      document.getElementById("date-select").value = currentDate;
      document.getElementById("department-select").value = "";
      document.getElementById("name-search").value = "";
      loadDashboardData();
    }

    function exportToCSV() {
      // [Your existing exportToCSV function remains unchanged]
    }

    function updateGeneralAttendanceChart(present, absent) {
      // [Your existing updateGeneralAttendanceChart function remains unchanged]
    }

    function updateReportingChart(before10AM, after10AM) {
      // [Your existing updateReportingChart function remains unchanged]
    }

    function updateDepartureChart(before4PM, after4PM) {
      // [Your existing updateDepartureChart function remains unchanged]
    }

    function updateDepartmentChart(labels, clockInData, clockOutData, totalLabels) {
      // [Your existing updateDepartmentChart function remains unchanged]
    }

    function updateLocationChart(labels, values) {
      // [Your existing updateLocationChart function remains unchanged]
    }

    function updateTrendChart(trendData = [], year, month) {
      const ctx = document.getElementById("trendChart").getContext('2d');
      if (!ctx) return;
      if (trendChart) trendChart.destroy();
      const daysInMonth = new Date(year, month - 1, 0).getDate(); // Correct month index (0-based)
      const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1); // Day numbers only
      const presentData = labels.map(day => {
        const fullDate = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
        const entry = trendData.find(d => d[0].toLowerCase() === fullDate.toLowerCase()); // Use index 0 for date
        return entry ? parseInt(entry[1]) || 0 : 0; // Use index 1 for present
      });
      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Staff Present',
            data: presentData,
            borderColor: '#48bb78',
            backgroundColor: 'rgba(72, 187, 120, 0.2)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: '#48bb78',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Staff Present', color: '#2d3748', font: { size: 12 } },
              ticks: { color: '#2d3748', font: { size: 10 } }
            },
            x: {
              title: { display: true, text: 'Day of Month', color: '#2d3748', font: { size: 12 } },
              ticks: { color: '#2d3748', font: { size: 10 }, maxTicksLimit: 15 }
            }
          },
          plugins: {
            legend: { position: 'bottom', labels: { color: '#2d3748', font: { size: 12 } } },
            tooltip: {
              callbacks: {
                title: function(tooltipItems) {
                  return `Date: ${month}/${tooltipItems[0].label}/${year}`;
                },
                label: function(context) {
                  return `Staff Present: ${context.raw}`;
                }
              }
            }
          }
        }
      });
    }

    function handleSort(key) {
      // [Your existing handleSort function remains unchanged]
    }

    function sortData(data, key, direction) {
      // [Your existing sortData function remains unchanged]
    }

    async function loadDashboardData() {
      const dateSelect = document.getElementById("date-select");
      const selectedDate = dateSelect.value;
      try {
        log("⏳ Fetching data...");

        const staffData = await fetchJSON(`${backendURL}/staff`);
        const totalStaff = staffData.totalStaff || (staffData.staff ? staffData.staff.length : 0);
        const activeCount = staffData.staffCount || (staffData.staff ? staffData.staff.filter(s => s.active).length : 0);

        const statsUrl = `${backendURL}/stats?date=${selectedDate}`;
        const stats = await fetchJSON(statsUrl);
        staffAttendanceData = stats.staffAttendance || [];

        const clockedInToday = staffAttendanceData.filter(entry => entry.timeIn).length;
        const clockedOutToday = staffAttendanceData.filter(entry => entry.timeOut).length;
        const absentToday = activeCount > 0 ? Math.max(0, activeCount - clockedInToday) : 0;
        const percentClockedIn = activeCount > 0 ? Math.round((clockedInToday / activeCount) * 100) : 0;
        const percentClockedOut = clockedInToday > 0 ? Math.round((clockedOutToday / clockedInToday) * 100) : 0;

        const clockInsBefore10AM = staffAttendanceData.filter(entry => entry.timeIn && convertToMinutes(entry.timeIn) < 10 * 60).length;
        const clockInsAfter10AM = staffAttendanceData.filter(entry => entry.timeIn && convertToMinutes(entry.timeIn) >= 10 * 60).length;
        const clockOutsBefore4PM = staffAttendanceData.filter(entry => entry.timeOut && convertToMinutes(entry.timeOut) < 16 * 60).length;
        const clockOutsAfter4PM = staffAttendanceData.filter(entry => entry.timeOut && convertToMinutes(entry.timeOut) >= 16 * 60).length;

        const locationData = await fetchJSON(`${backendURL}/locations`);
        const locLabels = locationData.locations?.map(l => l.name) || [];
        const locAttendance = {};
        staffAttendanceData.forEach(entry => {
          const loc = entry.clockInLocation || "Unknown";
          locAttendance[loc] = (locAttendance[loc] || 0) + 1;
        });
        const locCounts = locLabels.map(loc => locAttendance[loc] || 0);

        departments = [...new Set(staffData.staff?.map(entry => entry.department) || [])];
        const departmentSelect = document.getElementById("department-select");
        departmentSelect.innerHTML = '<option value="">All Departments</option>';
        departments.forEach(dept => {
          const option = document.createElement("option");
          option.value = dept;
          option.textContent = dept;
          departmentSelect.appendChild(option);
        });

        const deptTotals = {};
        const deptClockIns = {};
        const deptClockOuts = {};
        (staffData.staff || []).forEach(entry => {
          const dept = entry.department;
          deptTotals[dept] = (deptTotals[dept] || 0) + 1;
        });
        staffAttendanceData.forEach(entry => {
          const dept = entry.department;
          if (entry.timeIn) deptClockIns[dept] = (deptClockIns[dept] || 0) + 1;
          if (entry.timeOut) deptClockOuts[dept] = (deptClockOuts[dept] || 0) + 1;
        });
        const deptLabels = departments;
        const deptClockInData = departments.map(dept => deptClockIns[dept] || 0);
        const deptClockOutData = departments.map(dept => deptClockOuts[dept] || 0);
        const deptTotalLabels = departments.map(dept => deptTotals[dept] || 0);

        const selectedDateObj = new Date(selectedDate);
        const trendYear = selectedDateObj.getFullYear();
        const trendMonth = selectedDateObj.getMonth() + 1;
        let trendData = await fetchGoogleSheetData(`${trendYear}!A2:B`); // Ensure sheet name matches
        trendData = trendData.map(row => [row[0], row[1]]); // Keep as array of [date, present]

        document.getElementById("totalStaff").innerText = totalStaff;
        document.getElementById("activeStaff").innerText = activeCount;
        document.getElementById("clockInsToday").innerText = clockedInToday;
        document.getElementById("clockOutsToday").innerText = clockedOutToday;
        document.getElementById("absentToday").innerText = absentToday;
        document.getElementById("percentClockedIn").innerText = percentClockedIn + '%';
        document.getElementById("percentClockedOut").innerText = percentClockedOut + '%';

        const attendanceTitle = document.getElementById("attendance-title");
        attendanceTitle.textContent = `Staff Attendance Details (${new Date(selectedDate).toLocaleDateString("en-US", { month: "long", day: "numeric", year: "numeric" })})`;
        updateTable(staffAttendanceData);

        updateGeneralAttendanceChart(clockedInToday, absentToday);
        updateReportingChart(clockInsBefore10AM, clockInsAfter10AM);
        updateDepartureChart(clockOutsBefore4PM, clockOutsAfter4PM);
        updateDepartmentChart(deptLabels, deptClockInData, deptClockOutData, deptTotalLabels);
        updateLocationChart(locLabels, locCounts);
        updateTrendChart(trendData, trendYear, trendMonth);

        log("✅ Dashboard updated");

      } catch (err) {
        log("❌ " + err.message);
        ["totalStaff", "activeStaff", "clockInsToday", "clockOutsToday", "absentToday", "percentClockedIn", "percentClockedOut"].forEach(id => {
          const tile = document.querySelector(`#${id}`).closest(".tile");
          if (tile) tile.classList.add("error");
        });
      }
    }

    function convertToMinutes(timeStr) {
      if (!timeStr) return 0;
      const [hours, minutes] = timeStr.split(":").map(Number);
      return hours * 60 + minutes;
    }

    document.querySelectorAll(".sortable").forEach(th => {
      th.addEventListener("click", () => {
        const key = th.getAttribute("data-sort");
        handleSort(key);
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
      loadDashboardData();
      setInterval(loadDashboardData, 30000); // Update every 30 seconds
    });
  </script>
</body>
</html>
