<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Dashboard</title>
  <link rel="icon" type="image/png" href="/assets/favicon.png"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {font-family:'Inter',sans-serif;background:linear-gradient(135deg,#f0f4f8 0%,#d9e2ec 100%);color:#1a202c;margin:0;padding:0;min-height:100vh;}
    header {background:linear-gradient(90deg,#48bb78 0%,#38a169 100%);color:#fff;padding:1rem;text-align:center;font-size:1.8rem;font-weight:700;box-shadow:0 4px 6px rgba(0,0,0,0.1);display:flex;align-items:center;justify-content:center;position:relative;flex-wrap:wrap;gap:1rem;}
    header img {height:2.5rem;}
    header .logout-icon {position:absolute;right:1rem;top:50%;transform:translateY(-50%);width:2.5rem;height:2.5rem;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.4rem;cursor:pointer;transition:all .2s;color:#fff;}
    header .logout-icon:hover {background:#e53e3e;}

    #summary-tiles {display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;padding:1.5rem;}
    .tile {background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);padding:1rem;text-align:center;transition:transform .2s;}
    .tile:hover {transform:translateY(-5px);}
    .tile h3 {color:#2d3748;font-size:.875rem;margin-bottom:.5rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .tile p {font-size:1.5rem;font-weight:700;margin:0;color:#48bb78;}
    .tile.error p {color:#f56565;}

    #avg-times {display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;padding:0 1.5rem 1.5rem;}
    .avg-tile {background:#fff;border-radius:12px;padding:1rem;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
    .avg-tile h3 {font-size:.9rem;color:#2d3748;margin-bottom:.5rem;}
    .avg-tile p {font-size:1.6rem;font-weight:700;color:#48bb78;}

    #stats-container {display:grid;grid-template-columns:repeat(4,1fr);gap:1.5rem;padding:1.5rem;}
    .chart-tile {background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);padding:1.25rem;transition:transform .2s;height:320px;display:flex;flex-direction:column;}
    .chart-tile:hover {transform:translateY(-5px);}
    .chart-tile h3 {text-align:center;color:#2d3748;margin-bottom:1rem;font-size:1.1rem;font-weight:600;height:40px;display:flex;align-items:center;justify-content:center;}
    .chart-container {flex:1;display:flex;align-items:center;justify-content:center;position:relative;min-height:0;}
    .chart-container canvas {max-width:100%!important;max-height:100%!important;}
    .full-width-chart {grid-column:1/-1;height:380px;}
    .full-width-chart .chart-container {height:280px;}

    #log {background:#1a202c;color:#25e876;font-family:'Courier New',monospace;padding:1rem;height:180px;overflow-y:auto;margin:1rem;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);font-size:.85rem;position:relative;}
    #clear-log-btn {position:absolute;top:8px;right:8px;background:#e53e3e;color:#fff;padding:4px 8px;border:none;border-radius:6px;font-size:.75rem;cursor:pointer;}
    #clear-log-btn:hover {background:#c53030;}

    #attendance-table {margin:1rem;padding:1.25rem;background:rgb(209,226,250);border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);overflow-x:auto;}
    #attendance-table table {width:100%;border-collapse:collapse;min-width:700px;}
    #attendance-table th,#attendance-table td {padding:.75rem;text-align:left;border-bottom:1px solid #e2e8f0;font-size:.9rem;}
    #attendance-table th {background:#2d3748;color:#fff;cursor:pointer;white-space:nowrap;position:relative;}
    #attendance-table th:hover {background:#4a5568;}
    #attendance-table tr:nth-child(even){background:#f7fafc;}
    .sort-icon {margin-left:4px;font-size:.7rem;}
    .sort-icon.asc::before {content:' up';}
    .sort-icon.desc::before {content:' down';}

    #filters {display:flex;gap:1rem;margin:1rem;padding:1.25rem;background:rgb(209,226,250);border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);flex-wrap:wrap;align-items:flex-end;}
    #filters label {font-weight:600;color:#2d3748;font-size:.875rem;margin-bottom:.5rem;display:block;}
    input,select {padding:.5rem .75rem;border-radius:6px;border:2px solid #e2e8f0;font-size:.875rem;width:100%;height:40px;}
    input:focus,select:focus {border-color:#48bb78;outline:none;}
    button {background:#48bb78;color:#fff;padding:0 1.5rem;border:none;border-radius:6px;cursor:pointer;font-size:.875rem;height:40px;transition:.2s;display:flex;align-items:center;gap:6px;min-width:100px;}
    button:hover {background:#38a169;}
    .filter-group {flex:1;min-width:180px;position:relative;}
    .filter-group i {position:absolute;left:10px;top:34px;color:#666;font-size:.9rem;z-index:1;}
    .filter-group input,.filter-group select {padding-left:2.2rem;}
    .button-group {display:flex;gap:.5rem;flex-wrap:wrap;}
    .button-group .filter-group {min-width:auto;flex:1;}

    #date-display {font-weight:600;color:#2d3748;margin-bottom:.5rem;text-align:center;}

    @media (max-width:1024px){
      #stats-container{grid-template-columns:repeat(2,1fr);}
    }
    @media (max-width:768px){
      header{font-size:1.4rem;padding:.75rem;}
      header img{height:2rem;}
      #summary-tiles{grid-template-columns:repeat(2,1fr);gap:.75rem;padding:1rem;}
      .tile h3{font-size:.8rem;}.tile p{font-size:1.25rem;}
      #avg-times{grid-template-columns:repeat(2,1fr);}
      .avg-tile h3{font-size:.8rem;}.avg-tile p{font-size:1.2rem;}
      #stats-container{grid-template-columns:1fr;gap:1rem;padding:1rem;}
      .chart-tile{height:280px;padding:1rem;}
      .full-width-chart{height:320px;}
      .full-width-chart .chart-container{height:220px;}
      #filters{flex-direction:column;padding:1rem;}
      .filter-group,.button-group .filter-group{min-width:100%;}
      .button-group{width:100%;justify-content:stretch;}
      button{flex:1;justify-content:center;}
    }
    @media (max-width:480px){
      header{font-size:1.2rem;flex-direction:column;text-align:center;}
      header img{height:1.8rem;}
      .logout-icon{position:static;transform:none;margin-top:.5rem;}
      #summary-tiles{grid-template-columns:repeat(2,1fr);gap:.75rem;}
      .tile h3{font-size:.85rem;}.tile p{font-size:1.3rem;}
      #attendance-table th,#attendance-table td{font-size:.75rem;padding:.5rem;}
      #log{height:120px;font-size:.75rem;}
    }

    /* Reduce legend box size by 60% */
    .chartjs-legend {font-size: 0.75rem !important;}
    .chartjs-legend .legend-label-text {font-size: 0.75rem !important;}
    .chartjs-legend .legend-scale {width: 8px !important; height: 8px !important; border-radius: 2px !important; margin-right: 6px !important;}
  </style>
</head>
<body>
  <header>
    <img src="/assets/favicon.png" alt="logo" />
    Attendance Dashboard
    <img src="/assets/favicon.png" alt="logo" />
    <span class="logout-icon" id="logoutBtn"><i class="fas fa-door-open"></i></span>
  </header>

  <!-- SUMMARY TILES -->
  <section id="summary-tiles">
    <div class="tile"><h3>Total Staff</h3><p id="totalStaff">--</p></div>
    <div class="tile"><h3>Active Staff</h3><p id="activeStaff">--</p></div>
    <div class="tile"><h3>Clock-Ins</h3><p id="clockInsToday">--</p></div>
    <div class="tile"><h3>Clock-Outs</h3><p id="clockOutsToday">--</p></div>
    <div class="tile"><h3>Absent</h3><p id="absentToday">--</p></div>
    <div class="tile"><h3>Inactive Staff</h3><p id="inactiveStaff">--</p></div>
    <div class="tile"><h3>Clock-In Rate</h3><p id="percentClockedIn">--%</p></div>
    <div class="tile"><h3>Clock-Out Rate</h3><p id="percentClockedOut">--%</p></div>
  </section>

  <!-- AVERAGE TIMES -->
  <section id="avg-times">
    <div class="avg-tile"><h3>Avg Reporting Time</h3><p id="avgReportingTime">--:--</p></div>
    <div class="avg-tile"><h3>Avg Departure Time</h3><p id="avgDepartureTime">--:--</p></div>
  </section>

  <!-- CHARTS ROW 1 -->
  <section id="stats-container">
    <div class="chart-tile"><h3>General Attendance</h3><div class="chart-container"><canvas id="generalAttendanceChart"></canvas></div></div>
    <div class="chart-tile"><h3>Reporting</h3><div class="chart-container"><canvas id="reportingChart"></canvas></div></div>
    <div class="chart-tile"><h3>Departure</h3><div class="chart-container"><canvas id="departureChart"></canvas></div></div>
    <div class="chart-tile"><h3>Clocking</h3><div class="chart-container"><canvas id="clockingChart"></canvas></div></div>

    <div class="chart-tile full-width-chart"><h3>Department Attendance</h3><div class="chart-container"><canvas id="departmentChart"></canvas></div></div>
    <div class="chart-tile full-width-chart"><h3>Location Attendance</h3><div class="chart-container"><canvas id="locationChart"></canvas></div></div>
    <div class="chart-tile full-width-chart"><h3>90 Days Clock-In Trend</h3><div class="chart-container"><canvas id="trendChart"></canvas></div></div>
  </section>

  <!-- FILTERS -->
  <section id="filters">
    <div class="filter-group">
      <label for="date-select"><i class="fas fa-calendar-alt"></i> Select Date:</label>
      <input type="date" id="date-select">
    </div>
    <div class="filter-group">
      <label for="department-select"><i class="fas fa-building"></i> Filter Department:</label>
      <select id="department-select"><option value="">All Departments</option></select>
    </div>
    <div class="filter-group">
      <label for="name-search"><i class="fas fa-search"></i> Search Name:</label>
      <input type="text" id="name-search" placeholder="Search name...">
    </div>
    <div class="button-group">
      <div class="filter-group">
        <label style="visibility:hidden;">.</label>
        <button id="clear-filter-btn"><i class="fas fa-broom"></i> Clear Filter</button>
      </div>
      <div class="filter-group">
        <label style="visibility:hidden;">.</label>
        <button id="export-btn"><i class="fas fa-file-csv"></i> Export CSV</button>
      </div>
    </div>
  </section>

  <!-- TABLE -->
  <section id="attendance-table">
    <div id="date-display">Attendance for <span id="selected-date-display">Today</span></div>
    <p id="attendance-count">Showing 0 of 0 entries</p>
    <h3 id="attendance-title" class="text-xl font-semibold text-green-600">Staff Attendance Details</h3>
    <table>
      <thead>
        <tr>
          <th class="sortable" data-sort="userId">User ID <span class="sort-icon"></span></th>
          <th class="sortable" data-sort="name">Name <span class="sort-icon"></span></th>
          <th class="sortable" data-sort="department">Department <span class="sort-icon"></span></th>
          <th class="sortable" data-sort="timeIn">Time In <span class="sort-icon"></span></th>
          <th class="sortable" data-sort="timeOut">Time Out <span class="sort-icon"></span></th>
          <th class="sortable" data-sort="workTime">Work Time <span class="sort-icon"></span></th>
          <th class="sortable" data-sort="clockInLocation">Clock In Location <span class="sort-icon"></span></th>
        </tr>
      </thead>
      <tbody id="attendance-body"></tbody>
    </table>
  </section>

  <!-- LOGS -->
  <div id="log">
    <button id="clear-log-btn"><i class="fas fa-trash-alt"></i> Clear</button>
  </div>

  <script>
    // ============================= CONFIG =============================
    const backendURL = "https://tolon-attendance.proodentit.com/api";
    const currentDate = new Date().toISOString().split('T')[0];
    const SESSION_TIMEOUT = 12 * 60 * 60 * 1000;
    let timeoutId;

    // ============================= SESSION =============================
    const isLoggedIn = () => localStorage.getItem('isLoggedIn') === 'true';
    const logout = () => {
      clearTimeout(timeoutId);
      ['mousemove','keypress','click','scroll'].forEach(e=>document.removeEventListener(e,resetTimeout));
      localStorage.removeItem('isLoggedIn'); localStorage.removeItem('lastActivity');
      window.location.href = 'index.html';
    };
    const resetTimeout = () => {
      localStorage.setItem('lastActivity', Date.now());
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => {
        log('Session expired (12 h)'); alert('Session expired. Please log in again.'); logout();
      }, SESSION_TIMEOUT);
    };
    const log = msg => {
      const box = document.getElementById('log');
      const t = new Date().toLocaleTimeString();
      box.innerHTML += `[${t}] ${msg}<br>`;
      box.scrollTop = box.scrollHeight;
    };

    // ============================= HELPERS =============================
    const fetchJSON = async url => {
      const r = await fetch(url);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const txt = await r.text();
      log(`Fetched ${url.split('?')[0]} (${txt.length} chars)`);
      return JSON.parse(txt);
    };

    const timeToMinutes = t => {
      if (!t || t === '--') return null;
      const [h, m] = t.split(':').map(Number);
      return h * 60 + m;
    };

    const minutesToTime = mins => {
      if (mins === null || isNaN(mins)) return '--:--';
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    };

    const avgTime = times => {
      const valid = times.filter(t => t !== null);
      if (valid.length === 0) return null;
      const sum = valid.reduce((a, b) => a + b, 0);
      return Math.round(sum / valid.length);
    };

    const calculateWorkTime = (inT, outT) => {
      if (!inT || !outT) return 'N/A';
      const diff = timeToMinutes(outT) - timeToMinutes(inT);
      return `${Math.floor(diff/60)}h ${diff%60}m`;
    };

    // ============================= CHARTS =============================
    let charts = {};
    const initChart = (id, type, cfg) => {
      const ctx = document.getElementById(id)?.getContext('2d');
      if (!ctx) return;
      if (charts[id]) charts[id].destroy();
      charts[id] = new Chart(ctx, { type, ...cfg });
    };

    // ============================= MAIN LOAD =============================
    let staffAttendanceData = [];
    let allDepartments = [];

    const loadDashboardData = async () => {
      if (!isLoggedIn()) { logout(); return; }
      const selected = document.getElementById('date-select').value || currentDate;
      try {
        const staff = await fetchJSON(`${backendURL}/staff`);
        const totalStaff = staff.totalStaff ?? staff.staff?.length ?? 0;
        const active = staff.staffCount ?? staff.staff?.filter(s => s.active).length ?? 0;
        const inactive = totalStaff - active;

        const stats = await fetchJSON(`${backendURL}/stats?date=${selected}`);
        staffAttendanceData = stats.staffAttendance || [];

        // Populate departments
        allDepartments = [...new Set(staff.staff?.map(s => s.department) || [])];
        const deptSelect = document.getElementById('department-select');
        deptSelect.innerHTML = '<option value="">All Departments</option>' + allDepartments.map(d => `<option value="${d}">${d}</option>`).join('');

        const inToday = staffAttendanceData.filter(e => e.timeIn).length;
        const outToday = staffAttendanceData.filter(e => e.timeOut).length;
        const both = staffAttendanceData.filter(e => e.timeIn && e.timeOut).length;
        const partial = inToday - both;
        const absent = active - inToday;
        const pctIn = active ? Math.round(inToday / active * 100) : 0;
        const pctOut = inToday ? Math.round(outToday / inToday * 100) : 0;

        const inMins = staffAttendanceData.map(e => timeToMinutes(e.timeIn));
        const outMins = staffAttendanceData.map(e => timeToMinutes(e.timeOut));
        const avgIn = avgTime(inMins);
        const avgOut = avgTime(outMins);

        // Update summary
        const set = (id, v) => document.getElementById(id).innerText = v;
        set('totalStaff', totalStaff);
        set('activeStaff', active);
        set('clockInsToday', inToday);
        set('clockOutsToday', outToday);
        set('absentToday', absent);
        set('inactiveStaff', inactive);
        set('percentClockedIn', pctIn + '%');
        set('percentClockedOut', pctOut + '%');
        set('avgReportingTime', minutesToTime(avgIn));
        set('avgDepartureTime', minutesToTime(avgOut));

        // Update date display
        const dateObj = new Date(selected);
        document.getElementById('selected-date-display').textContent = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

        // Charts
        initChart('generalAttendanceChart', 'doughnut', {
          data: { labels: ['Present', 'Absent'], datasets: [{ data: [inToday, absent], backgroundColor: ['#48bb78', '#e2e8f0'] }] },
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
        initChart('reportingChart', 'doughnut', {
          data: { labels: ['Before 10 AM', 'After 10 AM'], datasets: [{ data: [
            staffAttendanceData.filter(e => timeToMinutes(e.timeIn) < 600).length,
            staffAttendanceData.filter(e => timeToMinutes(e.timeIn) >= 600).length
          ], backgroundColor: ['#48bb78', '#e2e8f0'] }] },
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
        initChart('departureChart', 'doughnut', {
          data: { labels: ['Before 4 PM', 'After 4 PM'], datasets: [{ data: [
            staffAttendanceData.filter(e => timeToMinutes(e.timeOut) < 960).length,
            staffAttendanceData.filter(e => timeToMinutes(e.timeOut) >= 960).length
          ], backgroundColor: ['#48bb78', '#e2e8f0'] }] },
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });
        initChart('clockingChart', 'doughnut', {
          data: { labels: ['Full Clocks', 'Half Clocks'], datasets: [{ data: [both, partial], backgroundColor: ['#48bb78', '#ff9800'] }] },
          options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
        });

        // Department & Location charts
        const deptTotal = allDepartments.map(d => staff.staff?.filter(s => s.department === d).length || 0);
        const deptIn = allDepartments.map(d => staffAttendanceData.filter(e => e.department === d && e.timeIn).length);
        const deptOut = allDepartments.map(d => staffAttendanceData.filter(e => e.department === d && e.timeOut).length);
        initChart('departmentChart', 'bar', {
          data: { labels: allDepartments, datasets: [
            { label: 'Total Staff', data: deptTotal, backgroundColor: 'rgba(45,55,72,0.2)' },
            { label: 'Clock In', data: deptIn, backgroundColor: '#48bb78' },
            { label: 'Clock Out', data: deptOut, backgroundColor: '#f56565' }
          ]},
          options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { position: 'bottom' } } }
        });

        const locData = await fetchJSON(`${backendURL}/locations`);
        const allLocs = locData.locations?.map(l => l.name) || [];
        const locCounts = allLocs.map(l => staffAttendanceData.filter(e => e.clockInLocation === l).length);
        initChart('locationChart', 'bar', {
          data: { labels: allLocs, datasets: [{ label: 'Attendance Count', data: locCounts, backgroundColor: '#48bb78' }] },
          options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });

        // 90-Day Trend
        const trendRaw = await fetchJSON(`${backendURL}/stats?days=90`);
        const trendMap = {};
        trendRaw.forEach(day => {
          const date = day.date;
          const count = day.staffAttendance?.filter(e => e.timeIn).length || 0;
          trendMap[date] = count;
        });
        const today = new Date();
        const labels = [];
        const data = [];
        for (let i = 89; i >= 0; i--) {
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          const dateStr = d.toISOString().split('T')[0];
          labels.push(dateStr);
          data.push(trendMap[dateStr] || 0);
        }
        initChart('trendChart', 'line', {
          data: { labels, datasets: [{ label: 'Daily Clock-Ins', data, borderColor: '#48bb78', backgroundColor: 'rgba(72,187,120,0.1)', tension: 0.3, fill: true }] },
          options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { position: 'bottom' } } }
        });

        updateTable(staffAttendanceData);
        log('Dashboard refreshed');
      } catch (e) { log('ERROR: ' + e.message); }
    };

    // ============================= TABLE & FILTERS =============================
    let sortConfig = { key: null, dir: 'asc' };
    const updateTable = data => {
      const tbody = document.getElementById('attendance-body');
      const dept = document.getElementById('department-select').value;
      const name = document.getElementById('name-search').value.toLowerCase();
      const filtered = data.filter(r => (dept ? r.department === dept : true) && r.name.toLowerCase().includes(name));
      const sorted = sortConfig.key ? [...filtered].sort((a, b) => {
        const A = a[sortConfig.key] || '';
        const B = b[sortConfig.key] || '';
        return A.localeCompare(B) * (sortConfig.dir === 'asc' ? 1 : -1);
      }) : filtered;

      tbody.innerHTML = sorted.map(r => `<tr>
        <td>${r.userId || '--'}</td>
        <td>${r.name || '--'}</td>
        <td>${r.department || '--'}</td>
        <td>${r.timeIn || '--'}</td>
        <td>${r.timeOut || '--'}</td>
        <td>${calculateWorkTime(r.timeIn, r.timeOut)}</td>
        <td>${r.clockInLocation || 'Unknown'}</td>
      </tr>`).join('');
      document.getElementById('attendance-count').textContent = `Showing ${sorted.length} of ${staffAttendanceData.length} entries`;
    };

    // ============================= INIT =============================
    document.addEventListener('DOMContentLoaded', () => {
      if (!isLoggedIn()) { window.location.href = 'index.html'; return; }

      document.getElementById('date-select').value = currentDate;

      // Event Listeners
      document.getElementById('logoutBtn').addEventListener('click', () => { log('Logout'); logout(); });
      document.getElementById('clear-filter-btn').addEventListener('click', () => {
        document.getElementById('date-select').value = currentDate;
        document.getElementById('department-select').value = '';
        document.getElementById('name-search').value = '';
        loadDashboardData();
      });
      document.getElementById('export-btn').addEventListener('click', () => {
        const csv = "data:text/csv;charset=utf-8,UserID,Name,Department,Time In,Time Out,Work Time,Location\n" +
          staffAttendanceData.map(r => `${r.userId || ''},${r.name},${r.department},${r.timeIn},${r.timeOut},${calculateWorkTime(r.timeIn, r.timeOut)},${r.clockInLocation || 'Unknown'}`).join('\n');
        const a = document.createElement('a'); a.href = encodeURI(csv); a.download = 'attendance.csv'; a.click();
      });
      document.getElementById('date-select').addEventListener('change', loadDashboardData);
      document.getElementById('department-select').addEventListener('change', () => updateTable(staffAttendanceData));
      document.getElementById('name-search').addEventListener('input', () => updateTable(staffAttendanceData));
      document.getElementById('clear-log-btn').addEventListener('click', () => {
        document.getElementById('log').innerHTML = '<button id="clear-log-btn"><i class="fas fa-trash-alt"></i> Clear</button>';
        document.getElementById('clear-log-btn').addEventListener('click', arguments.callee);
      });

      document.querySelectorAll('.sortable').forEach(th => th.addEventListener('click', () => {
        const key = th.dataset.sort;
        sortConfig.dir = sortConfig.key === key && sortConfig.dir === 'asc' ? 'desc' : 'asc';
        sortConfig.key = key;
        document.querySelectorAll('.sortable .sort-icon').forEach(icon => icon.className = 'sort-icon');
        const icon = th.querySelector('.sort-icon');
        icon.className = `sort-icon ${sortConfig.dir}`;
        updateTable(staffAttendanceData);
      }));

      ['mousemove', 'keypress', 'click', 'scroll'].forEach(ev => document.addEventListener(ev, resetTimeout, { passive: true }));
      resetTimeout();

      loadDashboardData();
      setInterval(loadDashboardData, 30000);
    });
  </script>
</body>
</html>
