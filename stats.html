<script>
  // CONFIG
  const backendURL = "https://tolon-attendance.proodentit.com/api";
  const currentDate = new Date().toISOString().split('T')[0];
  const SESSION_TIMEOUT = 12 * 60 * 60 * 1000;
  let timeoutId;

  // ADVANCED LOGGING SYSTEM
  const log = (msg, type = 'info') => {
    const box = document.getElementById('log');
    const timestamp = new Date().toLocaleTimeString('en-GB', { hour12: false });
    const icons = { info: 'ℹ️', success: 'Success', error: 'Error', warning: 'Warning', debug: 'Debug' };
    const colors = { info: '#60a5fa', success: '#48bb78', error: '#f56565', warning: '#f6ad55', debug: '#a0aec0' };
    box.innerHTML += `<div style="color:${colors[type]};font-weight:500;">[${timestamp}] ${icons[type]} ${msg}</div>`;
    box.scrollTop = box.scrollHeight;
    console[type === 'error' ? 'error' : type](msg);
  };

  // SESSION HANDLING
  const isLoggedIn = () => localStorage.getItem('isLoggedIn') === 'true';
  const logout = () => {
    log('User logged out', 'warning');
    clearTimeout(timeoutId);
    ['mousemove','keypress','click','scroll'].forEach(e => document.removeEventListener(e, resetTimeout));
    localStorage.removeItem('isLoggedIn'); localStorage.removeItem('lastActivity');
    window.location.href = 'index.html';
  };
  const resetTimeout = () => {
    localStorage.setItem('lastActivity', Date.now());
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => {
      log('Session expired after 12 hours of inactivity', 'error');
      alert('Session expired. Please log in again.');
      logout();
    }, SESSION_TIMEOUT);
  };

  // ROBUST FETCH WITH DETAILED ERRORS
  const fetchJSON = async (url, description = 'data') => {
    log(`Fetching ${description} → ${url}`, 'debug');
    try {
      const response = await fetch(url, { credentials: 'include' });
      if (!response.ok) {
        const text = await response.text();
        log(`HTTP ${response.status} ${response.statusText} → ${description}`, 'error');
        log(`Response body: ${text.substring(0, 200)}${text.length > 200 ? '...' : ''}`, 'error');
        throw new Error(`HTTP ${response.status}`);
      }
      const data = await response.json();
      log(`Received ${description}: ${Array.isArray(data) ? data.length + ' records' : 'single object'}`, 'success');
      return data;
    } catch (err) {
      log(`Fetch failed for ${description}: ${err.message}`, 'error');
      if (err.name === 'TypeError') log('Possible causes: No internet, CORS, or backend down', 'error');
      throw err;
    }
  };

  // TIME HELPERS
  const timeToMinutes = t => t && t !== '--' && t.includes(':') ? t.split(':').reduce((h,m) => h*60 + +m, 0) : null;
  const minutesToTime = m => m === null ? '--:--' : `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
  const avgTime = times => {
    const valid = times.filter(t => t !== null);
    return valid.length ? Math.round(valid.reduce((a,b) => a + b, 0) / valid.length) : null;
  };
  const calculateWorkTime = (inT, outT) => {
    if (!inT || !outT || inT === '--' || outT === '--') return 'N/A';
    const diff = timeToMinutes(outT) - timeToMinutes(inT);
    return diff > 0 ? `${Math.floor(diff/60)}h ${diff%60}m` : 'N/A';
  };

  // UNIVERSAL RANGE FETCHER (works every time)
  const fetchRange = async (start, end, purpose = 'data') => {
    const url = `${backendURL}/stats?start=${start}&end=${end}`;
    try {
      const data = await fetchJSON(url, `${purpose} (${start} to ${end})`);
      return Array.isArray(data) ? data : [data];
    } catch (e) {
      log(`Range fetch failed. Trying day-by-day fallback...`, 'warning');
      const result = [];
      let cur = new Date(start);
      const endDate = new Date(end);
      while (cur <= endDate) {
        const ds = cur.toISOString().split('T')[0];
        try {
          const day = await fetchJSON(`${backendURL}/stats?date=${ds}`, `day ${ds}`);
          result.push({ ...day, date: ds });
          log(`Success: Fetched day ${ds} via fallback`, 'success');
        } catch {
          log(`Failed: No data for ${ds}`, 'warning');
        }
        cur.setDate(cur.getDate() + 1);
      }
      return result;
    }
  };

  // GLOBAL DATA
  let allStaff = [];
  let staffAttendanceData = [];

  // ==================== PDF EXPORT - ULTRA DETAILED LOGGING ====================
  const exportToPDF = async () => {
    log('PDF Export button clicked', 'info');
    const dept = document.getElementById('department-select-pdf').value;
    const startInput = document.getElementById('start-date').value;
    const endInput = document.getElementById('end-date').value;
    const month = document.getElementById('month-select').value;

    if (!month && (!startInput || !endInput)) {
      log('PDF export aborted: No date range or month selected', 'error');
      alert('Please select either a month OR start + end dates');
      return;
    }

    let startDate, endDate, periodName;
    if (month) {
      const year = new Date().getFullYear();
      startDate = `${year}-${month}-01`;
      endDate = new Date(year, month, 0).toISOString().split('T')[0];
      periodName = `Month ${year}-${month}`;
    } else {
      startDate = startInput;
      endDate = endInput;
      periodName = `${startDate} to ${endDate}`;
    }

    log(`Starting PDF generation → ${periodName} | Dept: ${dept || 'All'}`, 'info');

    try {
      const rawData = await fetchRange(startDate, endDate, 'PDF data');
      log(`Successfully collected ${rawData.length} days of data for PDF`, 'success');

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l');

      // Logo
      try {
        const logo = await fetch('/assets/favicon.png').then(r => r.blob()).then(b => new Promise((res, rej) => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.onerror = rej;
          reader.readAsDataURL(b);
        }));
        doc.addImage(logo, 'PNG', 10, 8, 20, 20);
        log('Logo added to PDF', 'success');
      } catch (e) {
        log('Could not load logo (continuing without it)', 'warning');
      }

      doc.setFontSize(16).text('TOLON DISTRICT ASSEMBLY', 35, 18);
      doc.setFontSize(14).text('Monthly Staff Attendance Report', 35, 26);
      doc.setFontSize(10).text(`Period: ${periodName} | Department: ${dept || 'All'}`, 160, 18);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 160, 25);

      // Working days only (Mon–Fri)
      const workingDays = [];
      let cur = new Date(startDate);
      while (cur <= new Date(endDate)) {
        if (cur.getDay() >= 1 && cur.getDay() <= 5) workingDays.push(cur.toISOString().split('T')[0]);
        cur.setDate(cur.getDate() + 1);
      }
      log(`Found ${workingDays.length} working days (Mon–Fri)`, 'info');

      // Build staff map
      const staffMap = {};
      const targetStaff = dept ? allStaff.filter(s => s.department === dept) : allStaff;
      targetStaff.forEach(s => {
        staffMap[s.name] = { id: s.userId || 'N/A', dept: s.department || '--', days: {}, present: 0 };
      });

      rawData.forEach(day => {
        (day.staffAttendance || []).forEach(e => {
          if (staffMap[e.name]) {
            staffMap[e.name].days[day.date] = { in: e.timeIn || '--', out: e.timeOut || '--' };
            if (e.timeIn && e.timeIn !== '--') staffMap[e.name].present++;
          }
        });
      });

      // Table
      const head = [['ID', 'Name', 'Dept', ...workingDays.flatMap(d => [d.slice(5), ''])], ['', ''], 'Present', '%'];
      const body = Object.entries(staffMap).sort((a,b) => a[0].localeCompare(b[0])).map(([name, info]) => {
        const row = [info.id, name, info.dept];
        const inTimes = [], outTimes = [];
        workingDays.forEach(d => {
          const rec = info.days[d] || {};
          row.push(rec.in || '--');
          row.push(rec.out || '--');
          if (rec.in && rec.in !== '--') inTimes.push(timeToMinutes(rec.in));
          if (rec.out && rec.out !== '--') outTimes.push(timeToMinutes(rec.out));
        });
        row.push(minutesToTime(avgTime(inTimes)));
        row.push(minutesToTime(avgTime(outTimes)));
        row.push(`${info.present}/${workingDays.length}`);
        row.push(`${workingDays.length ? Math.round(info.present / workingDays.length * 100) : 0}%`);
        return row;
      });

      doc.autoTable({
        head: [head[0], head[1].concat(['Avg In', 'Avg Out', '', ''])],
        body,
        startY: 35,
        theme: 'grid',
        styles: { fontSize: 7, cellPadding: 1.5 },
        headStyles: { fillColor: [34, 139, 34] },
      });

      const filename = `Attendance_${startDate}_to_${endDate}.pdf`;
      doc.save(filename);
      log(`PDF successfully created and downloaded: ${filename}`, 'success');
    } catch (err) {
      log(`PDF generation failed completely: ${err.message}`, 'error');
      alert('PDF export failed. Check System Logs for details.');
    }
  };

  // ==================== STAFF ANALYSIS - DETAILED LOGGING ====================
  let staffAnalysisChart = null;
  const analyzeStaff = async () => {
    const btn = document.getElementById('analyze-staff');
861    btn.disabled = true;
    btn.innerHTML = 'Analyzing...';
    log('Staff analysis started', 'info');

    const search = document.getElementById('staff-search').value.trim();
    const days = parseInt(document.getElementById('period-select').value);

    if (!search) {
      log('Analysis aborted: Search field empty', 'error');
      alert('Please type a staff name or ID');
      btn.disabled = false; btn.innerHTML = 'Analyze'; return;
    }

    const staff = allStaff.find(s =>
      s.name.toLowerCase().includes(search.toLowerCase()) ||
      (s.userId && s.userId.toLowerCase().includes(search.toLowerCase()))
    );

    if (!staff) {
      log(`No staff found matching "${search}"`, 'error');
      alert('Staff not found. Try full name or correct ID.');
      btn.disabled = false; btn.innerHTML = 'Analyze'; return;
    }

    log(`Found staff: ${staff.name} (ID: ${staff.userId || 'N/A'})`, 'success');

    const end = new Date();
    const start = new Date();
    start.setDate(start.getDate() - days);

    try {
      const data = await fetchRange(
        start.toISOString().split('T')[0],
        end.toISOString().split('T')[0],
        `analysis for ${staff.name}`
      );

      const entries = data.flatMap(d =>
        (d.staffAttendance || []).filter(e => e.name === staff.name).map(e => ({...e, date: d.date}))
      );
      log(`Found ${entries.length} attendance records for ${staff.name}`, 'info');

      const workingDates = [];
      const inData = [], outData = [];
      let cur = new Date(start);
      while (cur <= end) {
        if (cur.getDay() >= 1 && cur.getDay() <= 5) {
          const ds = cur.toISOString().split('T')[0];
          workingDates.push(ds);
          const rec = entries.find(e => e.date === ds);
          inData.push(rec && rec.timeIn ? timeToMinutes(rec.timeIn) : null);
          outData.push(rec && rec.timeOut ? timeToMinutes(rec.timeOut) : null);
        }
        cur.setDate(cur.getDate() + 1);
      }

      const present = inData.filter(t => t !== null).length;
      const pct = Math.round(present / workingDates.length * 100);

      document.getElementById('staff-chart-title').textContent = `${staff.name} - Attendance Trend`;
      document.getElementById('avgClockIn').textContent = minutesToTime(avgTime(inData));
      document.getElementById('avgClockOut').textContent = minutesToTime(avgTime(outData));
      document.getElementById('daysPresent').textContent = `${present} / ${workingDates.length}`;
      document.getElementById('attendancePercent').textContent = `${pct}%`;

      document.getElementById('staff-chart-tile').style.display = 'block';
      document.getElementById('staff-stats').style.display = 'grid';

      if (staffAnalysisChart) staffAnalysisChart.destroy();
      staffAnalysisChart = new Chart(document.getElementById('staffTrendChart'), {
        type: 'line',
        data: {
          labels: workingDates.map(d => new Date(d).toLocaleDateString('en-US', {month:'short', day:'numeric'})),
          datasets: [
            { label: 'Clock In', data: inData, borderColor: '#48bb78', tension: 0.3, fill: false, pointRadius: 4 },
            { label: 'Clock Out', data: outData, borderColor: '#f56565', tension: 0.3, fill: false, pointRadius: 4 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { ticks: { callback: v => v === null ? '' : minutesToTime(v) } } }
        }
      });

      log(`Staff analysis completed successfully for ${staff.name} (${pct}% attendance)`, 'success');
    } catch (err) {
      log(`Staff analysis failed: ${err.message}`, 'error');
      alert('Analysis failed. See System Logs.');
    }

    btn.disabled = false;
    btn.innerHTML = 'Analyze';
  };

  // ==================== INITIALIZATION ====================
  document.addEventListener('DOMContentLoaded', () => {
    if (!isLoggedIn()) { log('Not logged in → redirecting', 'error'); window.location.href = 'index.html'; return; }

    log('Dashboard loaded successfully', 'success');
    document.getElementById('date-select').value = currentDate;

    // Button bindings
    document.getElementById('logoutBtn').onclick = () => { log('Logout clicked', 'info'); logout(); };
    document.getElementById('clear-logs').onclick = () => { document.getElementById('log').innerHTML = ''; log('Logs cleared by user', 'info'); };
    document.getElementById('analyze-staff').onclick = analyzeStaff;
    document.getElementById('pdf-export-btn').onclick = exportToPDF;

    // Other buttons (unchanged)
    document.getElementById('clear-filter-btn').onclick = () => {
      document.getElementById('date-select').value = currentDate;
      document.getElementById('department-select').value = '';
      document.getElementById('name-search').value = '';
      loadDashboardData(true);
    };

    document.getElementById('date-select').onchange = () => loadDashboardData(true);
    document.getElementById('department-select').onchange = () => updateTable(staffAttendanceData);
    document.getElementById('name-search').oninput = () => updateTable(staffAttendanceData);

    // Session & auto-refresh
    ['mousemove', 'keypress', 'click', 'scroll'].forEach(ev => document.addEventListener(ev, resetTimeout, { passive: true }));
    resetTimeout();
    loadDashboardData();
    setInterval(() => { log('Auto-refresh triggered', 'debug'); loadDashboardData(); }, 30000);
  });
</script>
