// ──────────────────────────────────────────────────────────────
// 1. FIXED STAFF ANALYSIS (Now 100% working)
// ──────────────────────────────────────────────────────────────
const analyzeStaff = async () => {
  const button = document.getElementById('analyze-staff');
  const search = document.getElementById('staff-search').value.trim();
  const days = parseInt(document.getElementById('period-select').value);

  if (!search) return alert('Please enter staff name or ID');

  button.disabled = true;
  button.innerHTML = 'Analyzing...';

  try {
    const staff = allStaff.find(s => 
      s.name?.toLowerCase().includes(search.toLowerCase()) ||
      s.userId?.toLowerCase().includes(search.toLowerCase())
    );

    if (!staff) throw new Error('Staff not found');

    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - days);

    // Fetch day by day (this endpoint is stable)
    const promises = [];
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
      const dateStr = d.toISOString().split('T')[0];
      promises.push(fetchJSON(`${backendURL}/stats?date=${dateStr}`).catch(() => ({ staffAttendance: [] })));
    }

    const dailyData = await Promise.all(promises);

    const entries = dailyData.flatMap((day, i) => {
      const date = new Date(start);
      date.setDate(date.getDate() + i);
      const dateStr = date.toISOString().split('T')[0];
      return (day.staffAttendance || [])
        .filter(e => e.name === staff.name)
        .map(e => ({ ...e, date: dateStr }));
    });

    // Working days only (Mon-Fri)
    const working = [];
    const present = new Set();
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
      if (d.getDay() >= 1 && d.getDay() <= 5) {
        const ds = d.toISOString().split('T')[0];
        working.push(ds);
        if (entries.some(e => e.date === ds && e.timeIn)) present.add(ds);
      }
    }

    const inMins = entries.map(e => timeToMinutes(e.timeIn)).filter(Boolean);
    const outMins = entries.map(e => timeToMinutes(e.timeOut)).filter(Boolean);

    document.getElementById('staff-chart-title').textContent = `${staff.name} - Attendance Trend`;
    document.getElementById('avgClockIn').textContent = minutesToTime(avgTime(inMins)) || '--:--';
    document.getElementById('avgClockOut').textContent = minutesToTime(avgTime(outMins)) || '--:--';
    document.getElementById('daysPresent').textContent = `${present.size} / ${working.length}`;
    document.getElementById('attendancePercent').textContent = working.length ? Math.round((present.size / working.length) * 100) + '%' : '0%';

    document.getElementById('staff-chart-tile').style.display = 'block';
    document.getElementById('staff-stats').style.display = 'grid';

    if (staffAnalysisChart) staffAnalysisChart.destroy();
    staffAnalysisChart = new Chart(document.getElementById('staffTrendChart'), {
      type: 'line',
      data: {
        labels: working.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
        datasets: [
          { label: 'Clock In', data: working.map(d => timeToMinutes(entries.find(e => e.date === d)?.timeIn) || null), borderColor: '#48bb78', tension: 0.3 },
          { label: 'Clock Out', data: working.map(d => timeToMinutes(entries.find(e => e.date === d)?.timeOut) || null), borderColor: '#f56565', tension: 0.3 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { ticks: { callback: v => `${Math.floor(v/60)}:${String(v%60).padStart(2,'0')}` } } }
      }
    });

  } catch (err) {
    alert(err.message || 'Analysis failed');
    console.error(err);
  } finally {
    button.disabled = false;
    button.innerHTML = 'Analyze';
  }
};

// ──────────────────────────────────────────────────────────────
// 2. FIXED PDF EXPORT (Now works even for full month)
// ──────────────────────────────────────────────────────────────
const exportToPDF = async () => {
  const dept = document.getElementById('department-select-pdf').value;
  const startInput = document.getElementById('start-date').value;
  const endInput = document.getElementById('end-date').value;
  const month = document.getElementById('month-select').value;

  if (!month && (!startInput || !endInput)) return alert('Select date range or month');

  let start = new Date();
  let end = new Date();

  if (month) {
    const y = new Date().getFullYear();
    start = new Date(y, month - 1, 1);
    end = new Date(y, month, 0);
  } else {
    start = new Date(startInput);
    end = new Date(endInput);
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l', 'mm', 'a4'); // landscape

  // Header
  doc.setFontSize(16);
  doc.text('Tolon District Assembly - Attendance Report', 148, 15, { align: 'center' });
  doc.setFontSize(12);
  doc.text(month 
    ? `${document.getElementById('month-select').options[document.getElementById('month-select').selectedIndex].text} ${new Date().getFullYear()}`
    : `${startInput} to ${endInput}`, 148, 23, { align: 'center' });

  // Fetch all days
  const dayPromises = [];
  for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
    const ds = d.toISOString().split('T')[0];
    dayPromises.push(fetchJSON(`${backendURL}/stats?date=${ds}`).catch(() => ({ staffAttendance: [], date: ds })));
  }
  const daysData = await Promise.all(dayPromises);

  const staffMap = {};
  allStaff.forEach(s => {
    if (!dept || s.department === dept) {
      staffMap[s.name] = { userId: s.userId || 'N/A', dept: s.department || '--', present: 0, days: {} };
    }
  });

  daysData.forEach(day => {
    (day.staffAttendance || []).forEach(e => {
      if (staffMap[e.name]) {
        staffMap[e.name].days[day.date] = { in: e.timeIn || '--', out: e.timeOut || '--' };
        if (e.timeIn) staffMap[e.name].present++;
      }
    });
  });

  const dates = Object.keys(staffMap[Object.keys(staffMap)[0]]?.days || {}).sort();
  const head = [['User ID', 'Name', 'Dept', ...dates, 'Present', '%']];
  const body = Object.entries(staffMap).map(([name, info]) => {
    const row = [info.userId, name, info.dept];
    dates.forEach(d => row.push(info.days[d]?.in || '--'));
    const pct = dates.length ? Math.round((info.present / dates.length) * 100) : 0;
    row.push(`${info.present}/${dates.length}`, `${pct}%`);
    return row;
  });

  doc.autoTable({
    head,
    body,
    startY: 35,
    theme: 'grid',
    styles: { fontSize: 8, cellPadding: 1.5 },
    headStyles: { fillColor: [72, 187, 120] },
    columnStyles: { 0: { cellWidth: 15 }, 1: { cellWidth: 30 }, 2: { cellWidth: 20 } }
  });

  doc.save(`Attendance_${month ? document.getElementById('month-select').options[document.getElementById('month-select').selectedIndex].text : startInput + '_to_' + endInput}.pdf`);
};
