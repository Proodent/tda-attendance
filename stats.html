<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Dashboard</title>
  <link rel="icon" type="image/png" href="/assets/favicon.png"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#f0f4f8 0%,#d9e2ec 100%);margin:0;padding:0;min-height:100vh;color:#1a202c}
    header{background:linear-gradient(90deg,#48bb78 0%,#38a169 100%);color:#fff;padding:1.5rem;text-align:center;font-size:2rem;font-weight:700;box-shadow:0 4px 6px rgba(0,0,0,.1);display:flex;align-items:center;justify-content:center;position:relative}
    header img{height:5rem;margin:0 5rem}
    header .logout-icon{position:absolute;right:0;top:50%;transform:translateY(-50%);width:2.5rem;height:2.5rem;background:transparent;border:none;color:#fff;font-size:1.4rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:color .2s}
    header .logout-icon:hover{color:#e53e3e}

    #summary-tiles{display:grid;grid-template-columns:repeat(7,1fr);gap:1.5rem;padding:2rem}
    .tile{background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,.1);padding:1rem;text-align:center;transition:transform .2s}
    .tile:hover{transform:translateY(-5px)}
    .tile h3{color:#2d3748;font-size:1rem;margin-bottom:.5rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tile p{font-size:1.75rem;font-weight:700;margin:0;color:#48bb78}
    .tile.error p{color:#f56565}

    #stats-container{display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem;padding:2rem}
    .chart-tile{background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,.1);padding:1.5rem;transition:transform .2s;height:350px;display:flex;flex-direction:column}
    .chart-tile:hover{transform:translateY(-5px)}
    .chart-tile h3{text-align:center;color:#2d3748;margin-bottom:1rem;font-size:1.25rem;font-weight:600;height:40px;display:flex;align-items:center;justify-content:center}
    .chart-container{flex:1;position:relative;min-height:0}
    .chart-container canvas{width:100%!important;height:100%!important}
    .full-width-chart{grid-column:1/-1;height:400px}
    .full-width-chart .chart-container{height:300px}

    #attendance-section{margin:1rem;background:rgb(209,226,250);border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,.1);overflow:hidden}
    .table-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;background:#2d3748;color:#fff;flex-wrap:wrap;gap:.75rem}
    .table-header h3{margin:0;font-size:1.25rem;font-weight:600}
    .filters-inline{display:flex;gap:.75rem;align-items:center;flex-wrap:nowrap}
    .filters-inline .filter-group{display:flex;flex-direction:column}
    .filters-inline label{font-size:.75rem;color:#fff;margin-bottom:.25rem;white-space:nowrap}
    .filters-inline input,.filters-inline select{padding:.35rem .5rem;font-size:.8rem;border-radius:6px;border:1px solid #cbd5e0;height:32px;background:#fff;color:#000}
    .filters-inline button{background:#48bb78;color:#fff;padding:0 .75rem;border:none;border-radius:6px;cursor:pointer;font-size:.75rem;height:32px;transition:background .2s;white-space:nowrap;min-width:60px}
    .filters-inline button:hover{background:#38a169}

    #attendance-table-content{padding:0 1.5rem 1.5rem}
    #attendance-table-content table{width:100%;border-collapse:collapse;margin-top:1rem}
    #attendance-table-content th,#attendance-table-content td{padding:.75rem;text-align:left;border-bottom:1px solid #e2e8f0;color:#1a202c}
    #attendance-table-content th{background:#2d3748;color:#fff;cursor:pointer;font-size:.9rem}
    #attendance-table-content th:hover{background:#4a5568}
    #attendance-table-content tr:nth-child(even){background:#f7fafc}

    #log{background:#1a202c;color:#25e876;font-family:'Courier New',monospace;padding:1.5rem;height:200px;overflow-y:auto;margin:1rem;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,.1);position:relative}
    #clear-log-btn{position:absolute;top:.5rem;right:.5rem;background:#e53e3e;color:#fff;border:none;padding:.35rem .75rem;font-size:.75rem;border-radius:6px;cursor:pointer}
    #clear-log-btn:hover{background:#c53030}

    #pdf-export{margin:1rem;padding:1.5rem;background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,.1);display:flex;gap:1rem;align-items:flex-start;flex-wrap:wrap}
    #pdf-export label{font-weight:600;color:#2d3748;white-space:nowrap;font-size:.9rem;margin-bottom:.5rem;display:block}
    #department-select-pdf,#start-date,#end-date,#month-select{padding:.5rem;border-radius:6px;border:2px solid #e2e8f0;font-size:.9rem;width:100%;height:2.5rem}
    #pdf-export-btn{background:#48bb78;color:#fff;padding:.5rem 1.5rem;border:none;border-radius:6px;cursor:pointer;font-size:.9rem;height:2.5rem;transition:background .2s;white-space:nowrap;align-self:flex-end}
    #pdf-export-btn:hover{background:#38a169}
    .pdf-filter-group{flex:1;min-width:18.75%;display:flex;flex-direction:column}

    @media(max-width:1024px){
      #summary-tiles{grid-template-columns:repeat(4,1fr)}
      #stats-container{grid-template-columns:repeat(2,1fr)}
      .chart-tile{height:300px}
      .full-width-chart{height:350px}
      .full-width-chart .chart-container{height:250px}
    }
    @media(max-width:768px){
      header{font-size:1.5rem;padding:.75rem}
      header img{height:1.5rem;margin:0 .5rem}
      #summary-tiles{grid-template-columns:repeat(2,1fr)}
      #stats-container{grid-template-columns:1fr}
      .chart-tile{height:250px}
      .full-width-chart{height:300px}
      .full-width-chart .chart-container{height:200px}
      .table-header{flex-direction:column;align-items:stretch}
      .filters-inline{justify-content:center;flex-wrap:wrap;gap:.5rem}
    }
  </style>
</head>
<body>

<header>
  <img src="/assets/favicon.png" alt="logo"/>
  Attendance Dashboard
  <img src="/assets/favicon.png" alt="logo"/>
  <button class="logout-icon" id="logoutBtn" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
</header>

<section id="summary-tiles">
  <div class="tile"><h3>Total Staff</h3><p id="totalStaff">--</p></div>
  <div class="tile"><h3>Active Staff</h3><p id="activeStaff">--</p></div>
  <div class="tile"><h3>Clock-Ins</h3><p id="clockInsToday">--</p></div>
  <div class="tile"><h3>Clock-Outs</h3><p id="clockOutsToday">--</p></div>
  <div class="tile"><h3>Absent</h3><p id="absentToday">--</p></div>
  <div class="tile"><h3>Clock-In Rate</h3><p id="percentClockedIn">--%</p></div>
  <div class="tile"><h3>Clock-Out Rate</h3><p id="percentClockedOut">--%</p></div>
</section>

<section id="stats-container">
  <div class="chart-tile"><h3>General Attendance</h3><div class="chart-container"><canvas id="generalAttendanceChart"></canvas></div></div>
  <div class="chart-tile"><h3>Reporting</h3><div class="chart-container"><canvas id="reportingChart"></canvas></div></div>
  <div class="chart-tile"><h3>Departure</h3><div class="chart-container"><canvas id="departureChart"></canvas></div></div>
  <div class="chart-tile full-width-chart"><h3>Department Attendance</h3><div class="chart-container"><canvas id="departmentChart"></canvas></div></div>
  <div class="chart-tile full-width-chart"><h3>Location Attendance</h3><div class="chart-container"><canvas id="locationChart"></canvas></div></div>
  <div class="chart-tile full-width-chart"><h3>90-Day Trend</h3><div class="chart-container"><canvas id="trendChart"></canvas></div></div>
  <div class="chart-tile full-width-chart"><h3>7-Day Trend</h3><div class="chart-container"><canvas id="weeklyChart"></canvas></div></div>
</section>

<section id="attendance-section">
  <div class="table-header">
    <h3 id="attendance-title">Staff Attendance Details</h3>
    <div class="filters-inline">
      <div class="filter-group"><label for="date-select">Date</label><input type="date" id="date-select" onchange="loadDashboardData()"></div>
      <div class="filter-group"><label for="department-select">Department</label>
        <select id="department-select" onchange="filterTable()"><option value="">All</option></select>
      </div>
      <div class="filter-group"><label for="name-search">Name</label><input type="text" id="name-search" onkeyup="filterTable()" placeholder="Search..."></div>
      <button id="clear-filter-btn" onclick="clearFilters()">Clear</button>
      <button id="export-btn" onclick="exportToCSV()">Export CSV</button>
    </div>
  </div>

  <div id="attendance-table-content">
    <p id="attendance-count">Showing 0 of 0 entries</p>
    <table>
      <thead>
        <tr>
          <th class="sortable" data-sort="name">Name</th>
          <th class="sortable" data-sort="department">Department</th>
          <th class="sortable" data-sort="timeIn">Time In</th>
          <th class="sortable" data-sort="timeOut">Time Out</th>
          <th class="sortable" data-sort="workTime">Work Time</th>
          <th class="sortable" data-sort="clockInLocation">Clock In Location</th>
        </tr>
      </thead>
      <tbody id="attendance-body"></tbody>
    </table>
  </div>
</section>

<section id="pdf-export">
  <div class="pdf-filter-group"><label for="department-select-pdf">Select Department:</label>
    <select id="department-select-pdf"><option value="">All Departments</option></select>
  </div>
  <div class="pdf-filter-group"><label for="start-date">Start Date:</label><input type="date" id="start-date"></div>
  <div class="pdf-filter-group"><label for="end-date">End Date:</label><input type="date" id="end-date"></div>
  <div class="pdf-filter-group"><label for="month-select">Select Month:</label>
    <select id="month-select">
      <option value="">All Months</option>
      <option value="01">January</option><option value="02">February</option>
      <option value="03">March</option><option value="04">April</option><option value="05">May</option>
      <option value="06">June</option><option value="07">July</option><option value="08">August</option>
      <option value="09">September</option><option value="10">October</option>
      <option value="11">November</option><option value="12">December</option>
    </select>
  </div>
  <div class="pdf-filter-group"><label style="visibility:hidden;">Export</label>
    <button id="pdf-export-btn" onclick="exportToPDF()">Export PDF</button>
  </div>
</section>

<div id="log"><button id="clear-log-btn" onclick="clearLogs()">Clear Logs</button></div>

<script>
  const backendURL = "https://tolon-attendance.proodentit.com/api";
  const SHEET_ID = "1hGuj1yAy2zB1n8xQq_soIq8lMl_TYmz6x0KgTNtjP2A";
  const API_KEY = "AIzaSyCTFfZAlX_eKUU3UY6mQknUUQyUWZiRLKw";
  const SESSION_TIMEOUT = 900000;
  let timeoutId;

  const isLoggedIn = () => localStorage.getItem('isLoggedIn') === 'true';
  const logout = () => {
    clearTimeout(timeoutId);
    ['mousemove','keypress','click'].forEach(ev=>document.removeEventListener(ev,resetTimeout));
    localStorage.removeItem('isLoggedIn'); localStorage.removeItem('lastActivity');
    window.location.href='index.html';
  };
  const log = m=>{const b=document.getElementById('log');if(b){b.innerHTML+=`[${new Date().toLocaleTimeString()}] ${m}<br>`;b.scrollTop=b.scrollHeight;}}
  const clearLogs = ()=>{document.getElementById('log').innerHTML='';log('Logs cleared');}
  const resetTimeout = ()=>{localStorage.setItem('lastActivity',Date.now());clearTimeout(timeoutId);timeoutId=setTimeout(()=>{alert('Session expired');logout();},SESSION_TIMEOUT);};

  let generalAttendanceChart,reportingChart,departureChart,departmentChart,locationChart,trendChart,weeklyChart;
  let sortConfig={key:null,direction:"asc"};
  let departments=[],staffAttendanceData=[],trendData=[];

  document.addEventListener('DOMContentLoaded',()=>{if(!isLoggedIn()){window.location.href='index.html';return;}
    resetTimeout();document.getElementById('date-select').value=new Date().toISOString().split('T')[0];
    loadDashboardData();setInterval(loadDashboardData,30000);populateDepartmentDropdown();
    ['mousemove','keypress','click'].forEach(ev=>document.addEventListener(ev,resetTimeout));
  });

  async function fetchJSON(u){try{const r=await fetch(u);if(!r.ok)throw new Error(`HTTP ${r.status}`);return await r.json();}catch(e){log(`Fetch error: ${e.message}`);throw e;}}
  async function fetchGoogleSheetData(r){const u=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${r}?key=${API_KEY}`;
    try{const res=await fetch(u,{mode:'cors'});if(!res.ok)throw new Error(`Sheet ${res.status}`);const d=await res.json();return d.values||[];}catch(e){log(`Sheet error: ${e.message}`);return [];}
  }

  const calculateWorkTime=(i,o)=>{if(!i||!o)return"N/A";const[hi,mi]=i.split(":").map(Number);const[ho,mo]=o.split(":").map(Number);
    const m=ho*60+mo-(hi*60+mi);return `${Math.floor(m/60)}h ${m%60}m`;}

  const updateTable=d=>{const b=document.getElementById("attendance-body");b.innerHTML="";
    const dept=document.getElementById("department-select").value;
    const name=document.getElementById("name-search").value.toLowerCase();
    const f=d.filter(e=>(!dept||e.department===dept)&&e.name.toLowerCase().includes(name));
    const s=sortConfig.key?sortData(f,sortConfig.key,sortConfig.direction):f;
    s.forEach(e=>b.innerHTML+=`<tr><td>${e.name||'--'}</td><td>${e.department||'--'}</td><td>${e.timeIn||'--'}</td><td>${e.timeOut||'--'}</td><td>${calculateWorkTime(e.timeIn,e.timeOut)}</td><td>${e.clockInLocation||'Unknown'}</td></tr>`);
    document.getElementById("attendance-count").textContent=`Showing ${s.length} of ${d.length} entries`;}

  const filterTable=()=>{updateTable(staffAttendanceData);}
  const clearFilters=()=>{document.getElementById("date-select").value=new Date().toISOString().split('T')[0];
    document.getElementById("department-select").value="";document.getElementById("name-search").value="";loadDashboardData();}

  const exportToCSV=()=>{const csv="data:text/csv;charset=utf-8,Name,Department,Time In,Time Out,Work Time,Location\n"+
    staffAttendanceData.map(e=>`${e.name},${e.department},${e.timeIn},${e.timeOut},${calculateWorkTime(e.timeIn,e.timeOut)},${e.clockInLocation}`).join("\n");
    const a=Object.assign(document.createElement("a"),{href:encodeURI(csv),download:"attendance.csv"});a.click();}

  async function populateDepartmentDropdown(){const d=await fetchJSON(`${backendURL}/staff`);
    departments=[...new Set(d.staff?.map(s=>s.department)||[])];
    ['department-select','department-select-pdf'].forEach(id=>{const s=document.getElementById(id);s.innerHTML='<option value="">All</option>';
      departments.forEach(de=>s.innerHTML+=`<option value="${de}">${de}</option>`);});}

  const updateChart=(id,cfg)=>{const ctx=document.getElementById(id)?.getContext('2d');if(!ctx)return;
    const c=window[id.replace('Chart','')+'Chart'];if(c)c.destroy();
    window[id.replace('Chart','')+'Chart']=new Chart(ctx,{...cfg,options:{...cfg.options,responsive:true,maintainAspectRatio:false}});}
  
  async function loadDashboardData(){
    if(!isLoggedIn())return logout();
    const date=document.getElementById("date-select").value||new Date().toISOString().split('T')[0];
    try{
      const [staff,stats,locations,sheet]=await Promise.all([
        fetchJSON(`${backendURL}/staff`),
        fetchJSON(`${backendURL}/stats?date=${date}`),
        fetchJSON(`${backendURL}/locations`),
        fetchGoogleSheetData(`Attendance Sheet!A2:G`)
      ]);

      staffAttendanceData=stats.staffAttendance||[];
      const total=staff.totalStaff||staff.staff.length;
      const active=staff.staffCount||staff.staff.filter(s=>s.active).length;
      const inToday=staffAttendanceData.filter(e=>e.timeIn).length;
      const outToday=staffAttendanceData.filter(e=>e.timeOut).length;
      const absent=active-inToday;

      ['totalStaff','activeStaff','clockInsToday','clockOutsToday','absentToday'].forEach((id,i)=>document.getElementById(id).innerText=[total,active,inToday,outToday,absent][i]);
      document.getElementById("percentClockedIn").innerText=active?Math.round(inToday/active*100)+'%':'0%';
      document.getElementById("percentClockedOut").innerText=inToday?Math.round(outToday/inToday*100)+'%':'0%';

      updateChart('generalAttendanceChart',{type:'doughnut',data:{labels:['Present','Absent'],datasets:[{data:[inToday,absent],backgroundColor:['#48bb78','#e2e8f0']}]}});
      updateChart('reportingChart',{type:'doughnut',data:{labels:['Before 10AM','After 10AM'],datasets:[{data:[staffAttendanceData.filter(e=>e.timeIn&&e.timeIn<"10:00").length,staffAttendanceData.filter(e=>e.timeIn&&e.timeIn>="10:00").length],backgroundColor:['#48bb78','#e2e8f0']}]}});
      updateChart('departureChart',{type:'doughnut',data:{labels:['Before 4PM','After 4PM'],datasets:[{data:[staffAttendanceData.filter(e=>e.timeOut&&e.timeOut<"16:00").length,staffAttendanceData.filter(e=>e.timeOut&&e.timeOut>="16:00").length],backgroundColor:['#48bb78','#e2e8f0']}]}});

      const deptMap={},deptIn={},deptOut={};
      staff.staff.forEach(s=>deptMap[s.department]=(deptMap[s.department]||0)+1);
      staffAttendanceData.forEach(e=>{if(e.timeIn)deptIn[e.department]=(deptIn[e.department]||0)+1;if(e.timeOut)deptOut[e.department]=(deptOut[e.department]||0)+1;});
      updateChart('departmentChart',{type:'bar',data:{labels:departments,datasets:[
        {label:'Total',data:departments.map(d=>deptMap[d]||0),backgroundColor:'rgba(45,55,72,0.2)'},
        {label:'In',data:departments.map(d=>deptIn[d]||0),backgroundColor:'#48bb78'},
        {label:'Out',data:departments.map(d=>deptOut[d]||0),backgroundColor:'#f56565'}
      ]}});

      const locMap={};
      staffAttendanceData.forEach(e=>locMap[e.clockInLocation||'Unknown']=(locMap[e.clockInLocation||'Unknown']||0)+1);
      const locLabels=locations.locations?.map(l=>l.name)||Object.keys(locMap);
      updateChart('locationChart',{type:'bar',data:{labels:locLabels,datasets:[{label:'Count',data:locLabels.map(l=>locMap[l]||0),backgroundColor:'#48bb78'}]}});

      // ---------- 90-DAY TREND (fixed â€“ uses real today) ----------
      const dateCount={};
      sheet.forEach(r=>{let d=r[0];if(d){
        const pd=new Date(d);if(!isNaN(pd))d=pd.toISOString().split('T')[0];
        else if(d.includes('/')){const[m,dd,y]=d.split('/');d=`${y}-${m.padStart(2,'0')}-${dd.padStart(2,'0')}`;}
        if(d&&r[3])dateCount[d]=(dateCount[d]||0)+1;
      }});
      const today=new Date();               // <-- REAL TODAY
      const trendLabels=[],trendValues=[];
      for(let i=89;i>=0;i--){const dd=new Date(today);dd.setDate(dd.getDate()-i);const ds=dd.toISOString().split('T')[0];
        trendLabels.push(ds);trendValues.push(dateCount[ds]||0);}
      updateChart('trendChart',{type:'line',data:{labels:trendLabels,datasets:[{label:'Attendance',data:trendValues,borderColor:'#48bb78',fill:true}]}});

      // ---------- 7-DAY TREND ----------
      const weekLabels=[],weekValues=[];
      for(let i=6;i>=0;i--){const dd=new Date(today);dd.setDate(dd.getDate()-i);const ds=dd.toISOString().split('T')[0];
        weekLabels.push(dd.toLocaleDateString('en-US',{weekday:'short'}));
        weekValues.push(dateCount[ds]||0);}
      updateChart('weeklyChart',{type:'bar',data:{labels:weekLabels,datasets:[{label:'Daily',data:weekValues,backgroundColor:'#48bb78'}]}});

      updateTable(staffAttendanceData);
      log("Dashboard loaded");
    }catch(e){log("Load error: "+e.message);}
  }

  const handleSort=k=>{sortConfig.direction=sortConfig.key===k&&sortConfig.direction==="asc"?"desc":"asc";sortConfig.key=k;
    document.querySelectorAll(".sortable").forEach(el=>el.classList.remove("asc","desc"));
    document.querySelector(`th[data-sort="${k}"]`)?.classList.add(sortConfig.direction);updateTable(staffAttendanceData);}
  const sortData=(d,k,dir)=>[...d].sort((a,b)=>(a[k]||'').localeCompare(b[k]||'')*(dir==="asc"?1:-1));

  document.querySelectorAll(".sortable").forEach(th=>th.addEventListener("click",()=>handleSort(th.dataset.sort)));
  document.getElementById('logoutBtn').addEventListener('click',logout);

  // ---------- PDF EXPORT (unchanged, works) ----------
  async function exportToPDF(){
    if(!isLoggedIn()){window.location.href='index.html';return;}
    const dept=document.getElementById("department-select-pdf").value;
    const start=document.getElementById("start-date").value;
    const end=document.getElementById("end-date").value;
    const month=document.getElementById("month-select").value;
    let dates=[];
    if(start&&end){const s=new Date(start),e=new Date(end);for(let d=new Date(s);d<=e;d.setDate(d.getDate()+1))
      if(d.getDay()!==0&&d.getDay()!==6)dates.push(d.toISOString().split('T')[0]);}
    else if(month){const y=new Date().getFullYear();const days=new Date(y,month,0).getDate();
      for(let d=1;d<=days;d++){const dt=new Date(`${y}-${month}-${d.toString().padStart(2,'0')}`);
        if(dt.getDay()!==0&&dt.getDay()!==6)dates.push(dt.toISOString().split('T')[0]);}}
    else{log("Select range or month");return;}
    const staff=await fetchJSON(`${backendURL}/staff`);
    const raw=await fetchGoogleSheetData(`Attendance Sheet!A2:G`);
    const map={};raw.forEach(r=>{let date=r[0];if(date){
      const pd=new Date(date);if(!isNaN(pd))date=pd.toISOString().split('T')[0];
      else if(date.includes('/')){const[m,d,y]=date.split('/');date=`${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;}
      if(date&&r[2]&&(r[3]||r[4])){if(!map[r[2]])map[r[2]]={};map[r[2]][date]={in:r[3],out:r[4]};}}});
    const tbl=document.createElement('table');tbl.style.width='100%';tbl.style.borderCollapse='collapse';
    const thead=`<tr><th>Name</th><th>Dept</th>${dates.map(d=>`<th>${new Date(d).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}<br>In/Out</th>`).join('')}<th>Total</th><th>Present</th><th>Absent</th><th>%</th></tr>`;
    let tbody='';staff.staff.forEach(s=>{if(dept&&s.department!==dept)return;
      const att=map[s.name]||{};const pres=dates.filter(d=>att[d]?.in).length;const tot=dates.length;const abs=tot-pres;const pct=tot?Math.round(pres/tot*100):0;
      tbody+=`<tr><td>${s.name}</td><td>${s.department}</td>${dates.map(d=>`<td>${att[d]?.in||'--'} / ${att[d]?.out||'--'}</td>`).join('')}<td>${tot}</td><td>${pres}</td><td>${abs}</td><td>${pct}%</td></tr>`;});
    tbl.innerHTML=`<thead>${thead}</thead><tbody>${tbody}</tbody>`;document.body.appendChild(tbl);
    const {jsPDF}=window.jspdf;const doc=new jsPDF({orientation:'landscape',unit:'mm',format:'a4'});
    await html2canvas(tbl).then(c=>{const img=c.toDataURL('image/png');const w=doc.internal.pageSize.getWidth()-20;
      const h=(c.height*w)/c.width;doc.addImage(img,'PNG',10,10,w,h);doc.save('attendance_report.pdf');});
    document.body.removeChild(tbl);log("PDF exported");
  }
</script>
</body>
</html>
