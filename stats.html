<script>
/* --------------------------------------------------------------
   PATCH – insert/replace the two functions below in the existing
   <script> block (keep everything else unchanged)
   -------------------------------------------------------------- */

/* ---------- 1. STAFF ANALYSIS CHART (fixed) ---------- */
let staffAnalysisChart = null;
const analyzeStaff = async () => {
  const button = document.getElementById('analyze-staff');
  button.disabled = true;
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';

  const search = document.getElementById('staff-search').value.trim().toLowerCase();
  const days   = parseInt(document.getElementById('period-select').value);

  document.getElementById('staff-chart-tile').style.display = 'none';
  document.getElementById('staff-stats').style.display      = 'none';

  if (!search || !allStaff.length) { alert('Enter staff name or ID'); button.disabled = false; button.innerHTML = 'Analyze'; return; }

  const targetStaff = allStaff.find(s =>
    s.name.toLowerCase().includes(search) ||
    (s.userId && s.userId.toLowerCase().includes(search))
  );
  if (!targetStaff) { alert('Staff not found'); button.disabled = false; button.innerHTML = 'Analyze'; return; }

  const endDate   = new Date();
  const startDate = new Date(); startDate.setDate(startDate.getDate() - days);

  let rawData = [];
  try {
    const s = startDate.toISOString().split('T')[0];
    const e = endDate.toISOString().split('T')[0];
    rawData = await fetchJSON(`${backendURL}/stats?start=${s}&end=${e}`);
    rawData = Array.isArray(rawData) ? rawData : [rawData];
  } catch (e) {
    log('Analysis fetch error: ' + e.message);
    button.disabled = false; button.innerHTML = 'Analyze';
    return;
  }

  const staffEntries = rawData.flatMap(day =>
    (day.staffAttendance || []).filter(e => e.name === targetStaff.name && (e.timeIn || e.timeOut))
      .map(e => ({ ...e, date: day.date }))
  );

  const inMins  = staffEntries.map(e => timeToMinutes(e.timeIn)).filter(v => v !== null);
  const outMins = staffEntries.map(e => timeToMinutes(e.timeOut)).filter(v => v !== null);
  const avgIn   = avgTime(inMins);
  const avgOut  = avgTime(outMins);

  /* ----- working days (Mon-Fri) ----- */
  const working = [], present = new Set();
  const cur = new Date(startDate);
  while (cur <= endDate) {
    if (cur.getDay() >= 1 && cur.getDay() <= 5) {
      const ds = cur.toISOString().split('T')[0];
      working.push(ds);
      if (staffEntries.some(e => e.date === ds && e.timeIn)) present.add(ds);
    }
    cur.setDate(cur.getDate() + 1);
  }
  const daysPresent = present.size, totalWD = working.length;
  const pct = totalWD ? Math.round(daysPresent / totalWD * 100) : 0;

  /* ----- chart data ----- */
  const map = {};
  staffEntries.forEach(e => {
    map[e.date] = map[e.date] || {in:null, out:null};
    if (e.timeIn)  map[e.date].in  = timeToMinutes(e.timeIn);
    if (e.timeOut) map[e.date].out = timeToMinutes(e.timeOut);
  });
  const inData  = working.map(d => map[d]?.in  ?? null);
  const outData = working.map(d => map[d]?.out ?? null);

  /* ----- update UI ----- */
  document.getElementById('staff-chart-title').textContent = `${targetStaff.name} - Clock Times`;
  document.getElementById('avgClockIn').textContent      = minutesToTime(avgIn);
  document.getElementById('avgClockOut').textContent     = minutesToTime(avgOut);
  document.getElementById('daysPresent').textContent     = `${daysPresent} / ${totalWD}`;
  document.getElementById('attendancePercent').textContent = `${pct}%`;

  document.getElementById('staff-chart-tile').style.display = 'block';
  document.getElementById('staff-stats').style.display      = 'grid';

  if (staffAnalysisChart) staffAnalysisChart.destroy();
  staffAnalysisChart = new Chart(document.getElementById('staffTrendChart'), {
    type: 'line',
    data: {
      labels: working.map(d => new Date(d).toLocaleDateString('en-US', {month:'short', day:'numeric'})),
      datasets: [
        { label:'Clock In',  data:inData,  borderColor:'#48bb78', backgroundColor:'rgba(72,187,120,0.1)', tension:0.3, fill:false },
        { label:'Clock Out', data:outData, borderColor:'#f56565', backgroundColor:'rgba(245,101,101,0.1)', tension:0.3, fill:false }
      ]
    },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      scales:{ y:{ min:0, max:1440,
        ticks:{ callback:v=> {
          const h=Math.floor(v/60), m=v%60;
          return `${h}:${String(m).padStart(2,'0')}`;
        }}
      }},
      plugins:{ tooltip:{ callbacks:{ label:c=> {
        const mins = c.parsed.y;
        if (mins===null) return 'No data';
        const h=Math.floor(mins/60), m=mins%60;
        return `${c.dataset.label}: ${h}:${String(m).padStart(2,'0')}`;
      }}}}}
    }
  });

  button.disabled = false;
  button.innerHTML = 'Analyze';
};

/* ---------- 2. PDF EXPORT (fixed) ---------- */
const exportToPDF = async () => {
  const dept   = document.getElementById('department-select-pdf').value;
  const start  = document.getElementById('start-date').value;
  const end    = document.getElementById('end-date').value;
  const month  = document.getElementById('month-select').value;

  if ((!start || !end) && !month) { alert('Select a date range or month'); return; }

  let startDate, endDate;
  if (month) {
    const y = new Date().getFullYear();
    startDate = new Date(y, parseInt(month)-1, 1);
    endDate   = new Date(y, parseInt(month), 0);
  } else {
    startDate = new Date(start);
    endDate   = new Date(end);
  }

  let rawData = [];
  try {
    const s = startDate.toISOString().split('T')[0];
    const e = endDate.toISOString().split('T')[0];
    rawData = await fetchJSON(`${backendURL}/stats?start=${s}&end=${e}`);
    rawData = Array.isArray(rawData) ? rawData : [rawData];
  } catch (e) {
    log('PDF fetch error: ' + e.message);
    alert('Failed to fetch attendance data');
    return;
  }

  if (!rawData.length) { alert('No attendance data for the selected period'); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('landscape');
  doc.setFontSize(14);
  doc.text('Attendance Report', 14, 15);
  doc.setFontSize(10);
  doc.text(`Period: ${startDate.toLocaleDateString()} – ${endDate.toLocaleDateString()}`, 14, 22);
  if (dept) doc.text(`Department: ${dept}`, 14, 29);

  /* ----- working days (Mon-Fri) ----- */
  const working = [];
  const cur = new Date(startDate);
  while (cur <= endDate) {
    if (cur.getDay() >= 1 && cur.getDay() <= 5) working.push(cur.toISOString().split('T')[0]);
    cur.setDate(cur.getDate() + 1);
  }
  const totalWD = working.length;

  /* ----- group by staff ----- */
  const staffMap = {};
  rawData.forEach(day => {
    (day.staffAttendance || []).forEach(entry => {
      if (dept && entry.department !== dept) return;
      const n = entry.name;
      if (!staffMap[n]) staffMap[n] = { userId: entry.userId || allStaff.find(s=>s.name===n)?.userId || 'N/A', days:{}, present:0 };
      staffMap[n].days[day.date] = { ti: entry.timeIn || '--', to: entry.timeOut || '--' };
      if (entry.timeIn) staffMap[n].present++;
    });
  });
  for (const n in staffMap) staffMap[n].absent = totalWD - staffMap[n].present;

  let y = 35;
  for (const [name, info] of Object.entries(staffMap)) {
    if (y > 180) { doc.addPage(); y = 20; }

    doc.setFontSize(11);
    doc.text(`${name} (ID: ${info.userId}) – Present: ${info.present}, Absent: ${info.absent}`, 14, y);
    y += 7;

    const body = Object.entries(info.days).map(([d, t]) => [d, t.ti, t.to]);
    if (!body.length) {
      doc.setFontSize(9);
      doc.text('No attendance records', 14, y);
      y += 10;
      continue;
    }

    doc.autoTable({
      startY: y,
      head: [['Date','Time In','Time Out']],
      body,
      theme: 'grid',
      styles: { fontSize:8, cellPadding:2 },
      headStyles: { fillColor:[72,187,120] },
      margin: { left:14, right:14 }
    });
    y = doc.lastAutoTable.finalY + 10;
  }

  doc.save('attendance_report.pdf');
  log('PDF exported');
};
</script>
