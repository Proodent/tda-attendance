<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Dashboard</title>
  <link rel="icon" type="image/png" href="/assets/favicon.png"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {font-family:'Inter',sans-serif;background:linear-gradient(135deg,#f0f4f8 0%,#d9e2ec 100%);color:#1a202c;margin:0;padding:0;min-height:100vh;}
    header {background:linear-gradient(90deg,#48bb78 0%,#38a169 100%);color:#fff;padding:0.75rem 1rem;font-size:1.4rem;font-weight:700;box-shadow:0 4px 6px rgba(0,0,0,0.1);display:flex;align-items:center;justify-content:space-between;}
    header img {height:2rem;}
    header .title {flex:1;text-align:center;font-size:1.2rem;}
    header .logout-icon {width:2rem;height:2rem;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.1rem;cursor:pointer;}
    header .logout-icon:hover {background:#e53e3e;color:#fff;}
    #summary-tiles {display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;padding:1.5rem;}
    .tile {background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);padding:1rem;text-align:center;transition:transform .2s;}
    .tile:hover {transform:translateY(-5px);}
    .tile h3 {color:#2d3748;font-size:.875rem;margin-bottom:.5rem;}
    .tile p {font-size:1.5rem;font-weight:700;margin:0;color:#48bb78;}
    #avg-times {display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;padding:0 1.5rem 1.5rem;}
    .avg-tile {background:#fff;border-radius:12px;padding:1rem;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
    .avg-tile h3 {font-size:.9rem;color:#2d3748;margin-bottom:.5rem;}
    .avg-tile p {font-size:1.6rem;font-weight:700;color:#48bb78;}
    #stats-container {display:grid;grid-template-columns:repeat(2,1fr);gap:1.5rem;padding:1.5rem;}
    .chart-tile {background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);padding:1.25rem;height:380px;display:flex;flex-direction:column;}
    .chart-tile h3 {text-align:center;color:#2d3748;margin-bottom:1rem;font-size:1.1rem;font-weight:600;}
    .chart-container {flex:1;display:flex;align-items:center;justify-content:center;position:relative;}
    .full-width-chart {grid-column:1/-1;height:420px;}
    #filters {display:flex;gap:1rem;flex-wrap:wrap;align-items:flex-end;margin:1rem;padding:1.25rem;background:rgb(209,226,250);border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
    #filters label {font-weight:600;color:#2d3748;font-size:.875rem;margin-bottom:.5rem;display:block;}
    input,select {padding:.5rem;border-radius:6px;border:2px solid #e2e8f0;font-size:.875rem;width:100%;height:40px;}
    input:focus,select:focus {border-color:#48bb78;outline:none;}
    button {background:#48bb78;color:#fff;padding:0 1.5rem;border:none;border-radius:6px;cursor:pointer;font-size:.875rem;height:40px;transition:.2s;}
    button:hover {background:#38a169;}
    .filter-group {flex:1;min-width:180px;}
    #attendance-header {display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;}
    #attendance-count {font-size:0.9rem;color:#4a5568;}
    #attendance-table {margin:1rem;padding:1.25rem;background:rgb(209,226,250);border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);overflow-x:auto;position:relative;}
    #attendance-table table {width:100%;border-collapse:collapse;min-width:600px;}
    #attendance-table th,#attendance-table td {padding:.75rem;text-align:left;border-bottom:1px solid #e2e8f0;font-size:.9rem;}
    #attendance-table th {background:#2d3748;color:#fff;cursor:pointer;}
    #attendance-table tr:nth-child(even){background:#f7fafc;}
    .loader {display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);z-index:10;justify-content:center;align-items:center;}
    .loader.active {display:flex;}
    .spinner {border:4px solid #f3f3f3;border-top:4px solid #48bb78;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;}
    @keyframes spin {0% {transform:rotate(0deg);} 100% {transform:rotate(360deg);}}
    @media (max-width:1024px){#stats-container{grid-template-columns:1fr;}}
    @media (max-width:768px){#summary-tiles{grid-template-columns:repeat(2,1fr);}#avg-times{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <header>
    <img src="/assets/favicon.png" alt="logo" />
    <div class="title">Attendance Dashboard</div>
    <span class="logout-icon" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></span>
  </header>

  <section id="summary-tiles">
    <div class="tile"><h3>Total Staff</h3><p id="totalStaff">--</p></div>
    <div class="tile"><h3>Active Staff</h3><p id="activeStaff">--</p></div>
    <div class="tile"><h3>Clock-Ins Today</h3><p id="clockInsToday">--</p></div>
    <div class="tile"><h3>Clock-Outs Today</h3><p id="clockOutsToday">--</p></div>
    <div class="tile"><h3>Absent Today</h3><p id="absentToday">--</p></div>
    <div class="tile"><h3>Attendance Rate %</h3><p id="attendanceRate">--%</p></div>
    <div class="tile"><h3>Avg Clock-In</h3><p id="avgClockIn">--</p></div>
    <div class="tile"><h3>Avg Clock-Out</h3><p id="avgClockOut">--</p></div>
  </section>

  <section id="avg-times">
    <div class="avg-tile"><h3>Avg Reporting Time</h3><p id="avgReportingTime">--:--</p></div>
    <div class="avg-tile"><h3>Avg Departure Time</h3><p id="avgDepartureTime">--:--</p></div>
  </section>

  <section id="stats-container">
    <div class="chart-tile full-width-chart">
      <h3>90 Days Attendance Trend</h3>
      <div class="chart-container"><canvas id="trendChart"></canvas></div>
    </div>
    <div class="chart-tile full-width-chart">
      <h3>Department Attendance</h3>
      <div class="chart-container"><canvas id="departmentChart"></canvas></div>
    </div>
    <div class="chart-tile full-width-chart">
      <h3>Location Attendance</h3>
      <div class="chart-container"><canvas id="locationChart"></canvas></div>
    </div>
  </section>

  <section id="filters">
    <div class="filter-group"><label for="date-select">Select Date:</label><input type="date" id="date-select"></div>
    <div class="filter-group"><label for="department-select">Filter Department:</label><select id="department-select"><option value="">All Departments</option></select></div>
    <div class="filter-group"><label for="name-search">Search Name / User ID:</label><input type="text" id="name-search" placeholder="Search name or ID..."></div>
    <div class="filter-group"><label style="visibility:hidden;">.</label><button id="clear-filter-btn">Clear Filter</button></div>
    <div class="filter-group"><label style="visibility:hidden;">.</label><button id="export-btn">Export to CSV</button></div>
  </section>

  <section id="attendance-table">
    <div id="attendance-header">
      <h3 id="attendance-title" class="text-xl font-semibold text-green-600">Attendance Details</h3>
      <p id="attendance-count">Showing 0 of 0 entries</p>
    </div>
    <div class="loader" id="table-loader"><div class="spinner"></div></div>
    <table>
      <thead>
        <tr>
          <th class="sortable" data-sort="userId">User ID</th>
          <th class="sortable" data-sort="name">Name</th>
          <th class="sortable" data-sort="department">Department</th>
          <th class="sortable" data-sort="timeIn">Time In</th>
          <th class="sortable" data-sort="timeOut">Time Out</th>
          <th class="sortable" data-sort="workTime">Work Time</th>
          <th class="sortable" data-sort="clockInLocation">Clock In Location</th>
        </tr>
      </thead>
      <tbody id="attendance-body"></tbody>
    </table>
  </section>

  <script>
    const backendURL = "https://tolon-attendance.proodentit.com/api";
    const currentDate = new Date().toISOString().split('T')[0];
    let staffAttendanceData = [];
    let allStaff = [];
    let charts = {};

    const fetchJSON = async url => {
      const r = await fetch(url);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    };

    const initChart = (id, type, cfg) => {
      const ctx = document.getElementById(id)?.getContext('2d');
      if (!ctx) return;
      if (charts[id]) charts[id].destroy();
      charts[id] = new Chart(ctx, {
        type,
        data: cfg.data,
        options: { responsive: true, maintainAspectRatio: false, ...cfg.options }
      });
    };

    const loadDashboardData = async () => {
      try {
        const stats = await fetchJSON(`${backendURL}/stats-sheet`);

        // Summary tiles from "Stats Sheet"
        const set = (id, key) => document.getElementById(id).innerText = stats.summary[key] || '--';
        set('totalStaff', 'Total Staff');
        set('activeStaff', 'Active Staff');
        set('clockInsToday', 'Clocked Ins Today');
        set('clockOutsToday', 'Clock Outs Today');
        set('absentToday', 'Absent Today');
        set('attendanceRate', 'Attendance Rate %');
        set('avgClockIn', 'Avg Clock-In Time');
        set('avgClockOut', 'Avg Clock-Out Time');

        // 90-Day Trend from Stats Sheet (A:B)
        const trendLabels = stats.trend.map(r => r[0]);
        const trendData = stats.trend.map(r => r[1]);
        initChart('trendChart', 'line', {
          data: {
            labels: trendLabels,
            datasets: [{
              label: 'Staff Present',
              data: trendData,
              borderColor: '#48bb78',
              backgroundColor: 'rgba(72,187,120,0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: { scales: { y: { beginAtZero: true } } }
        });

        // Department Chart from Stats Sheet (H:K)
        const deptLabels = stats.departments.map(r => r[0]);
        const deptTotal = stats.departments.map(r => r[1]);
        const deptIn = stats.departments.map(r => r[2]);
        const deptOut = stats.departments.map(r => r[3]);
        initChart('departmentChart', 'bar', {
          data: {
            labels: deptLabels,
            datasets: [
              { label: 'Total Active', data: deptTotal, backgroundColor: 'rgba(45,55,72,0.2)' },
              { label: 'Clock In', data: deptIn, backgroundColor: '#48bb78' },
              { label: 'Clock Out', data: deptOut, backgroundColor: '#f56565' }
            ]
          },
          options: { scales: { y: { beginAtZero: true } } }
        });

        // Location Chart from Stats Sheet (L:O)
        const locLabels = stats.locations.map(r => r[0]);
        const locAssigned = stats.locations.map(r => r[1]);
        const locIn = stats.locations.map(r => r[2]);
        const locOut = stats.locations.map(r => r[3]);
        initChart('locationChart', 'bar', {
          data: {
            labels: locLabels,
            datasets: [
              { label: 'Staff Assigned', data: locAssigned, backgroundColor: 'rgba(45,55,72,0.2)' },
              { label: 'Clock In', data: locIn, backgroundColor: '#48bb78' },
              { label: 'Clock Out', data: locOut, backgroundColor: '#f56565' }
            ]
          },
          options: { scales: { y: { beginAtZero: true } } }
        });

        // Today's attendance table (still from Attendance Sheet)
        const selected = document.getElementById('date-select').value || currentDate;
        const attStats = await fetchJSON(`${backendURL}/stats?date=${selected}`);
        staffAttendanceData = attStats.staffAttendance || [];
        allStaff = (await fetchJSON(`${backendURL}/staff`)).staff || [];
        updateTable(staffAttendanceData);
        document.getElementById('attendance-title').textContent = `Attendance Details - ${new Date(selected).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;

      } catch (e) {
        console.error(e);
        alert('Failed to load dashboard. Check connection.');
      }
    };

    const updateTable = data => {
      const tbody = document.getElementById('attendance-body');
      const dept = document.getElementById('department-select').value;
      const search = document.getElementById('name-search').value.toLowerCase();
      const filtered = data.filter(r =>
        (!dept || r.department === dept) &&
        (r.name.toLowerCase().includes(search) || (r.userId || '').toLowerCase().includes(search))
      );
      tbody.innerHTML = filtered.map(r => `<tr>
        <td>${r.userId || '--'}</td>
        <td>${r.name || '--'}</td>
        <td>${r.department || '--'}</td>
        <td>${r.timeIn || '--'}</td>
        <td>${r.timeOut || '--'}</td>
        <td>${calculateWorkTime(r.timeIn, r.timeOut)}</td>
        <td>${r.clockInLocation || 'Unknown'}</td>
      </tr>`).join('');
      document.getElementById('attendance-count').textContent = `Showing ${filtered.length} of ${data.length} entries`;
    };

    const calculateWorkTime = (inT, outT) => {
      if (!inT || !outT) return 'N/A';
      const [h1, m1] = inT.split(':').map(Number);
      const [h2, m2] = outT.split(':').map(Number);
      const diff = (h2 * 60 + m2) - (h1 * 60 + m1);
      return `${Math.floor(diff/60)}h ${diff%60}m`;
    };

    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('isLoggedIn') !== 'true') window.location.href = 'index.html';
      document.getElementById('date-select').value = currentDate;
      document.getElementById('logoutBtn').onclick = () => { localStorage.removeItem('isLoggedIn'); window.location.href = 'index.html'; };
      document.getElementById('clear-filter-btn').onclick = () => {
        document.getElementById('department-select').value = '';
        document.getElementById('name-search').value = '';
        updateTable(staffAttendanceData);
      };
      document.getElementById('export-btn').onclick = () => {
        const csv = "User ID,Name,Department,Time In,Time Out,Work Time,Location\n" +
          staffAttendanceData.map(r => `${r.userId || '--'},${r.name || '--'},${r.department || '--'},${r.timeIn || '--'},${r.timeOut || '--'},${calculateWorkTime(r.timeIn, r.timeOut)},${r.clockInLocation || 'Unknown'}`).join('\n');
        const a = document.createElement('a');
        a.href = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
        a.download = 'attendance.csv';
        a.click();
      };
      document.getElementById('date-select').onchange = () => loadDashboardData();
      document.getElementById('department-select').onchange = () => updateTable(staffAttendanceData);
      document.getElementById('name-search').oninput = () => updateTable(staffAttendanceData);
      loadDashboardData();
      setInterval(loadDashboardData, 120000); // Refresh every 2 mins
    });
  </script>
</body>
</html>
