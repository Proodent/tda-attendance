<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tolon District Assembly Staff Attendance Portal</title>
  <link rel="icon" type="image/png" href="/assets/favicon.png" />
  <style>
    /* Your original styles â€“ unchanged */
    body {font-family: Arial, sans-serif;background: #e8f5e8;text-align: center;margin: 0;padding: 20px;min-height: 100vh;display: flex;flex-direction: column;justify-content: center;align-items: center;overflow-x: hidden;}
    .container {padding: 20px;border-radius: 12px;box-shadow: 0 8px 24px rgba(0,0,0,.15);max-width: 600px;width: 90%;text-align: center;margin: auto 0;display: flex;flex-direction: column;align-items: center;position: relative;z-index: 1;background: rgba(255, 255, 255, 0.92);}
    .logo {width: 60px;height: 60px;margin-bottom: 8px;border-radius: 50%;object-fit: contain;box-shadow: 0 2px 8px rgba(0,0,0,0.1);border: 1.8px solid #009245;z-index: 2;}
    h1 {color: #009245;margin-bottom: 15px;font-size: 1.4em;width: 100%;position: relative;z-index: 2;}
    h1 span {font-size: 1em;}
    h1 .subtitle {color: #242424;font-size: .65em;}
    .input-group {margin: 20px 0 8px;text-align: center;width: 100%;max-width: 300px;display: flex;flex-direction: column;align-items: center;position: relative;z-index: 2;}
    .input-group input {width: 100%;padding: 10px 12px;font-size: 15px;border: 1.5px solid #ccc;border-radius: 8px;text-align: center;font-weight: 600;box-sizing: border-box;background: rgba(255,255,255,0.95);}
    .input-group input::placeholder {color: #aaa;font-weight: 500;}
    .input-group input:focus {outline: none;border-color: #009245;box-shadow: 0 0 6px rgba(0,146,69,0.3);}
    .input-group input:disabled {background: #f0f0f0;color: #999;cursor: not-allowed;}
    #userIdStatus {font-size: 0.85em;font-weight: 600;margin-top: 8px;padding: 8px 12px;border-radius: 8px;width: 100%;max-width: 300px;box-sizing: border-box;min-height: 40px;display: flex !important;align-items: center;justify-content: center;line-height: 1.4;background: rgba(255,255,255,0.95);}
    #userIdStatus.valid {color: #155724;background: #d4edda;border: 1.5px solid #c3e6cb;}
    #userIdStatus.inactive {color: #856404;background: #fff3cd;border: 1.5px solid #ffeaa7;}
    #userIdStatus.invalid {color: #721c24;background: #f8d7da;border: 1.5px solid #f5c6cb;}
    #userIdStatus.loading {color: #856404;background: #fff3cd;border: 1.5px solid #ffeaa7;}
    #userIdStatus.placeholder {color: #666;background: #f8f9fa;border: 1.5px dashed #ccc;}
    .status-box {margin: 18px 0 8px;width: 100%;max-width: 300px;text-align: center;position: relative;z-index: 2;}
    #gpsCoords {font-size: 0.8em;color: #006837;font-weight: 500;background: #d4edda;padding: 6px 14px;border-radius: 8px;display: inline-block;margin-bottom: 8px;}
    #status {font-size: 1.3em;color: #009245;font-weight: 700;margin: 0;}
    .time-box {margin: 20px 0 12px;width: 100%;max-width: 300px;position: relative;z-index: 2;}
    #liveClock {font-size: 1em;font-weight: 700;letter-spacing: 2px;color: #009245;background: #d4edda;padding: 6px 8px;border-radius: 8px;display: inline-block;min-width: 150px;}
    #liveClock span {display: inline-block;min-width: 1.2ch;text-align: center;}
    .colon {color: #006837;font-weight: 600;}
    #liveDate {font-size: .8em;color: #444;margin-top: 7px;font-weight: 600;}
    .button-group {display: flex;gap: 12px;justify-content: center;margin-top: 20px;width: 100%;max-width: 300px;position: relative;z-index: 2;}
    button {flex: 1;padding: 14px;font-size: 16px;background: #009245;color: #fff;border: none;border-radius: 8px;cursor: pointer;transition: background .3s, transform .2s;font-weight: 600;}
    #clockIn {background: #4CAF50;}
    #clockOut {background: #F44336;}
    button:hover:not(:disabled) {transform: scale(1.05);}
    #clockIn:hover:not(:disabled) {background: #45a049;}
    #clockOut:hover:not(:disabled) {background: #d32f2f;}
    button:disabled {background: #ccc;cursor: not-allowed;opacity: .6;}
    #adminDashboard {background: #009245;color: #fff;border: none;padding: 6px 12px;font-size: 0.8em;font-weight: 600;border-radius: 6px;cursor: pointer;margin-bottom: 8px;transition: background .3s;}
    #adminDashboard:hover {background: #007a3d;}
    #faceModal {display: none;position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0,0,0,.6);z-index: 3000;justify-content: center;align-items: center;}
    #faceModal.show {display: flex;}
    #faceModal .popup-content {background: #fff;padding: 20px;border-radius: 14px;max-width: 380px;width: 90%;text-align: center;box-shadow: 0 10px 30px rgba(0,0,0,.3);}
    #faceModal .popup-header {background: #009245;color: #fff;padding: 10px;border-radius: 8px;font-weight: bold;margin-bottom: 15px;}
    #faceModal .video-container {position: relative;margin: 15px auto;width: 280px;height: 210px;border: 3px solid #009245;border-radius: 12px;overflow: hidden;}
    #faceModal video {width: 100%;height: 100%;object-fit: cover;transform: scaleX(-1);}
    #faceModal .face-guide {position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%);width: 140px;height: 180px;border: 2px dashed #fff;border-radius: 50%;opacity: 0.7;}
    #faceModal .capture-status {margin: 15px 0;font-weight: 600;color: #009245;}
    #loaderOverlay {display: none;position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(255,255,255,.95);z-index: 3000;justify-content: center;align-items: center;flex-direction: column;backdrop-filter: blur(3px);}
    .loader {border: 6px solid #f3f3f3;border-top: 6px solid #009245;border-radius: 50%;width: 55px;height: 55px;animation: spin 1s linear infinite;margin-bottom: 15px;}
    @keyframes spin {100% {transform: rotate(360deg);}}
    .popup {display: none;position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0,0,0,.4);justify-content: center;align-items: center;z-index: 2000;}
    .popup.show {display: flex;}
    .popup-content {background: #fff;padding: 25px;border-radius: 12px;width: 90%;max-width: 380px;text-align: center;box-shadow: 0 5px 20px rgba(0,0,0,.2);}
    .popup-header {font-size: 1.2em;font-weight: bold;margin-bottom: 10px;padding: 8px;border-radius: 6px;}
    .popup-header.success {background: linear-gradient(135deg,#4CAF50,#45a049);color: #fff;}
    .popup-header.error {background: linear-gradient(135deg,#F44336,#d32f2f);color: #fff;}
    #adminPopup {display: none;position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0,0,0,.5);z-index: 2500;justify-content: center;align-items: center;}
    #adminPopup.show {display: flex;}
    #adminPopup .popup-content {background: #fff;padding: 25px;border-radius: 12px;max-width: 360px;width: 90%;box-shadow: 0 8px 25px rgba(0,0,0,.2);position: relative;}
    #adminPopup h2 {margin: 0 0 15px;color: #009245;font-size: 1.3em;}
    #adminPopup input {width: 100%;padding: 10px;margin: 8px 0;border: 1.5px solid #ccc;border-radius: 8px;font-size: 15px;box-sizing: border-box;}
    #adminLoginBtn {width: 100%;padding: 12px;background: #009245;color: #fff;border: none;border-radius: 8px;font-weight: 600;cursor: pointer;margin-top: 10px;position: relative;transition: background .3s;}
    #adminLoginBtn:disabled {background: #ccc;cursor: not-allowed;}
    #adminLoginBtn .spinner {display: none;width: 16px;height: 16px;border: 2px solid #fff;border-top: 2px solid transparent;border-radius: 50%;animation: spin 1s linear infinite;position: absolute;right: 12px;top: 50%;transform: translateY(-50%);}
    #adminLoginBtn.loading .spinner {display: block;}
    #adminError {color: #d32f2f;margin-top: 8px;font-size: 0.9em;}
    .popup-close {position: absolute;top: 8px;right: 8px;background: transparent;color: #999;border: none;width: 28px;height: 28px;border-radius: 50%;font-size: 18px;font-weight: bold;cursor: pointer;display: flex;align-items: center;justify-content: center;transition: color .2s;}
    .popup-close:hover {color: #d32f2f;}
    .footer {margin-top: auto;font-size: .9em;color: #666;padding: 10px 0;border-top: 1px solid #eee;width: 100%;max-width: 600px;text-align: center;position: relative;z-index: 2;}
    .footer a {color: #009245;text-decoration: none;}
  </style>
</head>
<body>
  <div class="container">
    <img src="/assets/client-logo.jpg" alt="Logo" class="logo" />
    <h1><span>Tolon District Assembly</span><br><span class="subtitle">Staff Attendance Portal</span></h1>
    <div class="status-box">
      <div id="gpsCoords">GPS: Waiting for signal...</div>
      <p id="status">Checking location...</p>
    </div>
    <div class="time-box">
      <div id="liveClock">00 : 00 : 00</div>
      <div id="liveDate"></div>
    </div>
    <div class="input-group">
      <input type="number" id="userId" placeholder="Enter User ID" maxlength="10" autocomplete="off" disabled />
      <div id="userIdStatus" class="placeholder">Enter User ID to validate</div>
    </div>
    <div class="button-group">
      <button id="clockIn" disabled>Clock In</button>
      <button id="clockOut" disabled>Clock Out</button>
    </div>
  </div>

  <!-- FACE MODAL WITH LIVENESS -->
  <div id="faceModal">
    <div class="popup-content">
      <div class="popup-header">Face Verification (Liveness Check)</div>
      <p style="margin:12px 0 8px;font-weight:600;">Please blink twice</p>
      <div class="video-container">
        <video id="video" autoplay playsinline></video>
        <div class="face-guide"></div>
      </div>
      <div class="capture-status" id="captureStatus">Blink detection active...</div>
    </div>
  </div>

  <!-- LOADER & POPUP (unchanged) -->
  <div id="loaderOverlay">
    <div class="loader"></div>
    <p>Verifying face...</p>
  </div>
  <div id="popup" class="popup">
    <div class="popup-content">
      <div class="popup-header" id="popupHeader">Title</div>
      <div id="popupMessage">Message</div>
      <button id="popupCloseBtn">Close</button>
    </div>
  </div>
  <div id="adminPopup">
    <div class="popup-content">
      <button class="popup-close" id="adminCloseBtn">X</button>
      <h2>Admin Login</h2>
      <p style="font-size:0.8em;color:#666;margin-bottom:15px;">(Check with server)</p>
      <input type="email" id="adminEmail" placeholder="Email" />
      <input type="password" id="adminPassword" placeholder="Password" />
      <button id="adminLoginBtn">Login <span class="spinner"></span></button>
      <p id="adminError" class="error"></p>
    </div>
  </div>

  <div class="footer">
    <div><button id="adminDashboard">Admin</button></div>
    <div>Developed by: <a href="https://proodentit.com" target="_blank">Proodent IT Solutions</a></div>
  </div>

  <!-- MediaPipe Face Mesh + TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection"></script>

  <script>
    // === ALL YOUR ORIGINAL CODE + LIVENESS DETECTION ===
    const successSound = new Audio('/assets/success-sound.mp3');
    const errorSound = new Audio('/assets/error-sound.mp3');
    let soundPlayed = false;
    const unlockAudio = () => {
      successSound.load(); errorSound.load();
      const silent = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA');
      silent.play().catch(() => {});
      document.removeEventListener('touchstart', unlockAudio);
      document.removeEventListener('click', unlockAudio);
    };
    document.addEventListener('touchstart', unlockAudio);
    document.addEventListener('click', unlockAudio);

    // Live Clock
    function updateClockAndDate() {
      const now = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const dateStr = now.toLocaleDateString(undefined, options);
      const h = now.getHours().toString().padStart(2, '0');
      const m = now.getMinutes().toString().padStart(2, '0');
      const s = now.getSeconds().toString().padStart(2, '0');
      document.getElementById('liveClock').innerHTML = `<span>${h}</span><span class="colon">:</span><span>${m}</span><span class="colon">:</span><span>${s}</span>`;
      document.getElementById('liveDate').textContent = dateStr;
    }
    updateClockAndDate();
    setInterval(updateClockAndDate, 1000);

    // === LIVENESS DETECTION WITH MEDIAPIPE ===
    let faceModel;
    let blinkCount = 0;
    let lastEAR = 0.3;
    let livenessPassed = false;
    let livenessTimer;

    async function loadFaceModel() {
      faceModel = await faceLandmarksDetection.createDetector(
        faceLandmarksDetection.SupportedModels.MediaPipeFaceMesh,
        { runtime: 'tfjs', refineLandmarks: true }
      );
    }

    function eyeAspectRatio(eye) {
      const v1 = Math.hypot(eye[1].x - eye[5].x, eye[1].y - eye[5].y);
      const v2 = Math.hypot(eye[2].x - eye[4].x, eye[2].y - eye[4].y);
      const h = Math.hypot(eye[0].x - eye[3].x, eye[0].y - eye[3].y);
      return (v1 + v2) / (2.0 * h);
    }

    async function runLivenessCheck(video) {
      if (!faceModel) return;
      const faces = await faceModel.estimateFaces(video);
      if (faces.length === 0) {
        document.getElementById('captureStatus').textContent = "No face detected";
        return;
      }
      const landmarks = faces[0].keypoints;
      const leftEye = [landmarks[33], landmarks[160], landmarks[158], landmarks[133], landmarks[153], landmarks[144]];
      const rightEye = [landmarks[362], landmarks[385], landmarks[387], landmarks[263], landmarks[373], landmarks[380]];
      const leftEAR = eyeAspectRatio(leftEye);
      const rightEAR = eyeAspectRatio(rightEye);
      const avgEAR = (leftEAR + rightEAR) / 2;

      // Blink detection
      if (avgEAR < 0.22 && lastEAR > 0.3) {
        blinkCount++;
        document.getElementById('captureStatus').textContent = `Blink ${blinkCount}/2 detected!`;
      }
      lastEAR = avgEAR;

      if (blinkCount >= 2) {
        livenessPassed = true;
        clearInterval(livenessTimer);
        document.getElementById('captureStatus').textContent = "Liveness passed! Capturing...";
        setTimeout(() => captureAndVerify(staff, action), 800);
      }
    }

    // === MODIFIED showFaceModal WITH LIVENESS ===
    let staff, action;
    const showFaceModal = async (s, a) => {
      staff = s; action = a;
      const modal = document.getElementById('faceModal');
      const video = document.getElementById('video');
      const status = document.getElementById('captureStatus');
      modal.classList.add('show');
      blinkCount = 0; livenessPassed = false;
      status.textContent = "Loading liveness model...";

      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
      video.srcObject = stream;
      video.play();

      if (!faceModel) await loadFaceModel();
      status.textContent = "Please blink twice";

      livenessTimer = setInterval(() => runLivenessCheck(video), 100);
      setTimeout(() => {
        if (!livenessPassed) {
          clearInterval(livenessTimer);
          hideFaceModal();
          showPopup('Liveness Failed', 'No blinks detected. Please try again.', false);
        }
      }, 12000); // 12 sec timeout
    };

    const hideFaceModal = () => {
      document.getElementById('faceModal').classList.remove('show');
      clearInterval(livenessTimer);
      const video = document.getElementById('video');
      if (video && video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.stop());
      }
    };

    // === CAPTURE & VERIFY (unchanged except called after liveness) ===
    const captureAndVerify = async (staff, action) => {
      const video = document.getElementById('video');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0);
      const base64 = canvas.toDataURL('image/jpeg').split(',')[1];
      hideFaceModal();
      showLoader(`Verifying ${staff.name}...`);
      const result = await validateFaceWithSubject(base64, staff.name);
      hideLoader();
      if (!result.ok) {
        showPopup('Face Verification Failed', result.error || 'Face not recognized', false);
        return;
      }
      if (!soundPlayed) { successSound.play().catch(() => {}); soundPlayed = true; }
      showPopup('Success', `Face verified! Recording ${action}...`, true);
      await submitAttendance(action, staff);
    };

    // === REST OF YOUR ORIGINAL CODE (unchanged) ===
    // ... (all the functions you already have: startLocationWatch, handleClock, etc.) ...

    // Keep all your existing functions exactly as they are
    // Just make sure showFaceModal is replaced with the new version above

    document.addEventListener('DOMContentLoaded', () => {
      loadFaceModel(); // Preload model
      startLocationWatch();
    });
  </script>
</body>
</html>
