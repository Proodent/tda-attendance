<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tolon Attendance Dashboard</title>
  <link rel="icon" type="image/png" href="/assets/favicon.png"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {font-family:'Inter',sans-serif;background:linear-gradient(135deg,#f0f4f8 0%,#d9e2ec 100%);color:#1a202c;margin:0;padding:0;min-height:100vh;}
    header {
      background:linear-gradient(90deg,#48bb78 0%,#38a169 100%);
      color:#fff;padding:0.75rem 1rem;font-size:1.4rem;font-weight:700;
      box-shadow:0 4px 6px rgba(0,0,0,0.1);display:flex;align-items:center;justify-content:space-between;
    }
    header img {height:2rem;}
    header .title {flex:1;text-align:center;font-size:1.2rem;}
    header .logout-icon {width:2.2rem;height:2.2rem;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;}
    header .logout-icon:hover {background:#e53e3e;}
    #summary-tiles {display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;padding:1.5rem;}
    .tile {background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);padding:1rem;text-align:center;transition:transform .2s;}
    .tile:hover {transform:translateY(-5px);}
    .tile h3 {color:#2d3748;font-size:.875rem;margin-bottom:.5rem;}
    .tile p {font-size:1.5rem;font-weight:700;margin:0;color:#48bb78;}
    .tile.error p {color:#f56565;}
    #avg-times {display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;padding:0 1.5rem 1.5rem;}
    .avg-tile {background:#fff;border-radius:12px;padding:1rem;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
    .avg-tile h3 {font-size:.9rem;color:#2d3748;margin-bottom:.5rem;}
    .avg-tile p {font-size:1.6rem;font-weight:700;color:#48bb78;}
    #stats-container {display:grid;grid-template-columns:repeat(4,1fr);gap:1.5rem;padding:1.5rem;}
    .chart-tile {background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);padding:1.25rem;height:320px;display:flex;flex-direction:column;}
    .chart-tile:hover {transform:translateY(-5px);}
    .chart-tile h3 {text-align:center;color:#2d3748;margin-bottom:1rem;font-size:1.1rem;font-weight:600;height:40px;display:flex;align-items:center;justify-content:center;}
    .chart-container {flex:1;position:relative;}
    .full-width-chart {grid-column:1/-1;height:380px;}
    #filters,#pdf-export {display:flex;gap:1rem;margin:1rem;padding:1.25rem;background:#e0f2fe;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);flex-wrap:wrap;align-items:flex-end;}
    #filters label,#pdf-export label {font-weight:600;color:#2d3748;font-size:.875rem;margin-bottom:.5rem;display:block;}
    input,select {padding:.5rem;border-radius:6px;border:2px solid #e2e8f0;font-size:.875rem;height:40px;}
    input:focus,select:focus {border-color:#48bb78;outline:none;}
    button {background:#48bb78;color:#fff;padding:0 1.5rem;border:none;border-radius:6px;cursor:pointer;font-size:.875rem;height:40px;transition:.2s;}
    button:hover {background:#38a169;}
    .filter-group,.pdf-filter-group {flex:1;min-width:180px;}
    #attendance-table {margin:1rem;padding:1.25rem;background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);overflow-x:auto;}
    #attendance-table table {width:100%;border-collapse:collapse;min-width:600px;}
    #attendance-table th,#attendance-table td {padding:.75rem;text-align:left;border-bottom:1px solid #e2e8f0;font-size:.9rem;}
    #attendance-table th {background:#2d3748;color:#fff;cursor:pointer;position:relative;}
    #attendance-table th:hover {background:#4a5568;}
    #attendance-table tr:nth-child(even){background:#f7fafc;}
    #log-container {margin:1rem;padding:0;background:#1a202c;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);overflow:hidden;}
    #log-header {display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1rem;background:#2d3748;color:#fff;font-weight:600;}
    #clear-logs {background:#e53e3e;color:#fff;padding:0.25rem 0.75rem;border:none;border-radius:6px;font-size:0.8rem;cursor:pointer;}
    #log {background:#1a202c;color:#25e876;font-family:'Courier New',monospace;padding:1rem;height:180px;overflow-y:auto;font-size:.85rem;}
    .loader {display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9);z-index:10;justify-content:center;align-items:center;}
    .loader.active {display:flex;}
    .spinner {border:4px solid #f3f3f3;border-top:4px solid #48bb78;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;}
    @keyframes spin {0% {transform:rotate(0deg);} 100% {transform:rotate(360deg);}}
    @media (max-width:1024px){#stats-container{grid-template-columns:repeat(2,1fr);}}
    @media (max-width:768px){#summary-tiles{grid-template-columns:repeat(2,1fr);}#stats-container{grid-template-columns:1fr;}#filters,#pdf-export{flex-direction:column;}}
  </style>
</head>
<body>
  <header>
    <img src="/assets/favicon.png" alt="logo" />
    <div class="title">Tolon Attendance Dashboard</div>
    <span class="logout-icon" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></span>
  </header>

  <section id="summary-tiles">
    <div class="tile"><h3>Total Staff</h3><p id="totalStaff">--</p></div>
    <div class="tile"><h3>Active Staff</h3><p id="activeStaff">--</p></div>
    <div class="tile"><h3>Clock-Ins Today</h3><p id="clockInsToday">--</p></div>
    <div class="tile"><h3>Clock-Outs Today</h3><p id="clockOutsToday">--</p></div>
    <div class="tile"><h3>Absent Today</h3><p id="absentToday">--</p></div>
    <div class="tile"><h3>Inactive Staff</h3><p id="inactiveStaff">--</p></div>
    <div class="tile"><h3>Clock-In Rate</h3><p id="percentClockedIn">--%</p></div>
    <div class="tile"><h3>Clock-Out Rate</h3><p id="percentClockedOut">--%</p></div>
  </section>

  <section id="avg-times">
    <div class="avg-tile"><h3>Avg Clock-In</h3><p id="avgReportingTime">--:--</p></div>
    <div class="avg-tile"><h3>Avg Clock-Out</h3><p id="avgDepartureTime">--:--</p></div>
  </section>

  <section id="stats-container">
    <div class="chart-tile"><h3>General Attendance</h3><div class="chart-container"><canvas id="generalAttendanceChart"></canvas></div></div>
    <div class="chart-tile"><h3>Reporting Time</h3><div class="chart-container"><canvas id="reportingChart"></canvas></div></div>
    <div class="chart-tile"><h3>Departure Time</h3><div class="chart-container"><canvas id="departureChart"></canvas></div></div>
    <div class="chart-tile"><h3>Clocking Status</h3><div class="chart-container"><canvas id="clockingChart"></canvas></div></div>
    <div class="chart-tile full-width-chart"><h3>Department Attendance</h3><div class="chart-container"><canvas id="departmentChart"></canvas></div></div>
    <div class="chart-tile full-width-chart"><h3>Location Attendance</h3><div class="chart-container"><canvas id="locationChart"></canvas></div></div>
    <div class="chart-tile full-width-chart"><h3>90 Days Trend</h3><div class="chart-container"><canvas id="trendChart"></canvas></div></div>
  </section>

  <section id="filters">
    <div class="filter-group"><label>Select Date:</label><input type="date" id="date-select"></div>
    <div class="filter-group"><label>Department:</label><select id="department-select"><option value="">All</option></select></div>
    <div class="filter-group"><label>Search Name/ID:</label><input type="text" id="name-search" placeholder="Search..."></div>
    <div class="filter-group"><button id="clear-filter-btn">Clear</button></div>
    <div class="filter-group"><button id="export-btn">Export CSV</button></div>
  </section>

  <section id="attendance-table">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
      <h3 class="text-xl font-semibold text-green-600" id="attendance-title">Attendance Details</h3>
      <p id="attendance-count">Showing 0 of 0</p>
    </div>
    <div class="loader" id="table-loader"><div class="spinner"></div></div>
    <table>
      <thead>
        <tr>
          <th class="sortable" data-sort="userId">User ID</th>
          <th class="sortable" data-sort="name">Name</th>
          <th class="sortable" data-sort="department">Department</th>
          <th class="sortable" data-sort="timeIn">Time In</th>
          <th class="sortable" data-sort="timeOut">Time Out</th>
          <th>Work Time</th>
          <th>Location</th>
        </tr>
      </thead>
      <tbody id="attendance-body"></tbody>
    </table>
  </section>

  <section id="pdf-export">
    <h3 class="text-xl font-semibold text-green-600 mb-4">Export PDF Report</h3>
    <div class="pdf-filter-group"><label>Department:</label><select id="department-select-pdf"><option value="">All</option></select></div>
    <div class="pdf-filter-group"><label>Start Date:</label><input type="date" id="start-date"></div>
    <div class="pdf-filter-group"><label>End Date:</label><input type="date" id="end-date"></div>
    <div class="pdf-filter-group"><label>Or Select Month:</label>
      <select id="month-select">
        <option value="">Choose Month</option>
        <option value="01">January</option><option value="02">February</option><option value="03">March</option>
        <option value="04">April</option><option value="05">May</option><option value="06">June</option>
        <option value="07">July</option><option value="08">August</option><option value="09">September</option>
        <option value="10">October</option><option value="11">November</option><option value="12">December</option>
      </select>
    </div>
    <div class="pdf-filter-group"><button id="pdf-export-btn">Generate PDF</button></div>
  </section>

  <div id="log-container">
    <div id="log-header"><span>System Logs</span><button id="clear-logs">Clear</button></div>
    <div id="log"></div>
  </div>

  <script>
    const backendURL = "https://tolon-attendance.proodentit.com/api";
    const currentDate = new Date().toISOString().split('T')[0];
    let staffAttendanceData = [], allStaff = [], charts = {}, sortConfig = { key: null, dir: 'asc' };

    const log = msg => {
      const box = document.getElementById('log');
      box.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
      box.scrollTop = box.scrollHeight;
    };

    const fetchJSON = async url => {
      log(`Fetching: ${url}`);
      const r = await fetch(url);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    };

    const timeToMinutes = t => t && t !== '--' ? t.split(':').reduce((h,m) => h*60 + +m) : null;
    const minutesToTime = mins => mins === null ? '--:--' : `${String(Math.floor(mins/60)).padStart(2,'0')}:${String(mins%60).padStart(2,'0')}`;
    const avgTime = times => {
      const valid = times.filter(t => t !== null);
      return valid.length ? Math.round(valid.reduce((a,b)=>a+b,0)/valid.length) : null;
    };
    const calculateWorkTime = (inT, outT) => {
      if (!inT || !outT) return 'N/A';
      const diff = timeToMinutes(outT) - timeToMinutes(inT);
      return diff > 0 ? `${Math.floor(diff/60)}h ${diff%60}m` : 'N/A';
    };

    const initChart = (id, type, config) => {
      const ctx = document.getElementById(id)?.getContext('2d');
      if (!ctx) return;
      if (charts[id]) charts[id].destroy();
      charts[id] = new Chart(ctx, { type, ...config, options: { responsive: true, maintainAspectRatio: false, ...config.options } });
    };

    const loadDashboardData = async () => {
      const date = document.getElementById('date-select').value || currentDate;
      document.getElementById('table-loader').classList.add('active');
      try {
        const [staffRes, stats, trendRaw, locations] = await Promise.all([
          fetchJSON(`${backendURL}/staff`),
          fetchJSON(`${backendURL}/stats?date=${date}`),
          fetchJSON(`${backendURL}/stats?days=90`),
          fetchJSON(`${backendURL}/locations`)
        ]);

        allStaff = staffRes.staff || [];
        staffAttendanceData = stats.staffAttendance || [];
        const active = allStaff.filter(s => s.active).length;
        const total = allStaff.length;
        const inToday = staffAttendanceData.filter(e => e.timeIn).length;
        const outToday = staffAttendanceData.filter(e => e.timeOut).length;
        const absent = active - inToday;

        document.getElementById('totalStaff').textContent = total;
        document.getElementById('activeStaff').textContent = active;
        document.getElementById('clockInsToday').textContent = inToday;
        document.getElementById('clockOutsToday').textContent = outToday;
        document.getElementById('absentToday').textContent = absent;
        document.getElementById('inactiveStaff').textContent = total - active;
        document.getElementById('percentClockedIn').textContent = active ? Math.round(inToday/active*100) + '%' : '0%';
        document.getElementById('percentClockedOut').textContent = inToday ? Math.round(outToday/inToday*100) + '%' : '0%';
        document.getElementById('avgReportingTime').textContent = minutesToTime(avgTime(staffAttendanceData.map(e => timeToMinutes(e.timeIn))));
        document.getElementById('avgDepartureTime').textContent = minutesToTime(avgTime(staffAttendanceData.map(e => timeToMinutes(e.timeOut))));

        // Charts
        initChart('generalAttendanceChart', 'doughnut', { data: { labels: ['Present', 'Absent'], datasets: [{ data: [inToday, absent], backgroundColor: ['#48bb78', '#e2e8f0'] }] } });
        initChart('trendChart', 'line', {
          data: {
            labels: Array.from({length:90},(_,i)=> {
              const d = new Date(); d.setDate(d.getDate()-89+i); return d.toISOString().split('T')[0];
            }),
            datasets: [{
              label: 'Clock-Ins',
              data: Array.from({length:90},(_,i)=> {
                const d = new Date(); d.setDate(d.getDate()-89+i);
                const dateStr = d.toISOString().split('T')[0];
                const day = trendRaw.trend?.find(t => t.date.includes(dateStr.replace(/-/g,'')) || t.date === dateStr);
                return day?.present || 0;
              }),
              borderColor: '#48bb78', backgroundColor: 'rgba(72,187,120,0.1)', tension: 0.3, fill: true
            }]
          }
        });

        updateTable(staffAttendanceData);
        document.getElementById('attendance-title').textContent = `Attendance Details - ${new Date(date).toLocaleDateString('en-GB', { day:'numeric', month:'long', year:'numeric' })}`;
      } catch (e) {
        log('ERROR: ' + e.message);
      } finally {
        document.getElementById('table-loader').classList.remove('active');
      }
    };

    const updateTable = data => {
      const tbody = document.getElementById('attendance-body');
      const dept = document.getElementById('department-select').value;
      const search = document.getElementById('name-search').value.toLowerCase();
      let filtered = data.filter(r => (!dept || r.department === dept) && (r.name.toLowerCase().includes(search) || (r.userId||'').toLowerCase().includes(search)));
      if (sortConfig.key) {
        filtered.sort((a,b) => {
          let av = a[sortConfig.key] || '', bv = b[sortConfig.key] || '';
          if (sortConfig.key.includes('time')) { av = timeToMinutes(av) || 0; bv = timeToMinutes(bv) || 0; }
          return (av < bv ? -1 : 1) * (sortConfig.dir === 'asc' ? 1 : -1);
        });
      }
      tbody.innerHTML = filtered.map(r => {
        const staff = allStaff.find(s => s.name === r.name) || {};
        return `<tr>
          <td>${r.userId || staff.userId || 'N/A'}</td>
          <td>${r.name}</td>
          <td>${r.department || '--'}</td>
          <td>${r.timeIn || '--'}</td>
          <td>${r.timeOut || '--'}</td>
          <td>${calculateWorkTime(r.timeIn, r.timeOut)}</td>
          <td>${r.clockInLocation || 'Unknown'}</td>
        </tr>`;
      }).join('');
      document.getElementById('attendance-count').textContent = `Showing ${filtered.length} of ${data.length}`;
    };

    const exportToPDF = async () => {
      const dept = document.getElementById('department-select-pdf').value;
      const startInput = document.getElementById('start-date').value;
      const endInput = document.getElementById('end-date').value;
      const month = document.getElementById('month-select').value;

      if (!startInput && !endInput && !month) return alert('Select date range or month');

      let startDate, endDate;
      if (month) {
        const y = new Date().getFullYear();
        startDate = new Date(y, month-1, 1);
        endDate = new Date(y, month, 0);
      } else {
        startDate = new Date(startInput);
        endDate = new Date(endInput);
      }

      const days = [];
      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate()+1)) {
        days.push(d.toISOString().split('T')[0]);
      }

      const allData = [];
      for (const date of days) {
        try {
          const res = await fetchJSON(`${backendURL}/stats?date=${date}`);
          allData.push({ date, staffAttendance: res.staffAttendance || [] });
        } catch { allData.push({ date, staffAttendance: [] }); }
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l');
      try {
        const img = new Image(); img.src = '/assets/favicon.png';
        await new Promise(r => img.onload = r);
        doc.addImage(img, 'PNG', 15, 10, 20, 20);
      } catch {}

      doc.setFontSize(16); doc.text('Tolon District Assembly - Attendance Report', 40, 20);
      doc.setFontSize(10); doc.text(`Period: ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`, 200, 15, { align: 'right' });

      const staffMap = {};
      allData.forEach(day => {
        day.staffAttendance.forEach(e => {
          if (dept && e.department !== dept) return;
          if (!staffMap[e.name]) {
            const s = allStaff.find(x => x.name === e.name) || {};
            staffMap[e.name] = { id: e.userId || s.userId || 'N/A', dept: e.department || '--', records: {} };
          }
          staffMap[e.name].records[day.date] = { in: e.timeIn || '--', out: e.timeOut || '--' };
        });
      });

      const workingDays = days.filter(d => new Date(d).getDay() !== 0 && new Date(d).getDay() !== 6);
      const head = [['ID', 'Name', 'Dept', ...workingDays.flatMap(d => [d.slice(5).replace('-','/'), ''])]];
      head.push(['', '', '', ...workingDays.flatMap(() => ['In', 'Out'])]);
      const body = Object.entries(staffMap).sort(([a],[b])=>a.localeCompare(b)).map(([name, info]) => [
        info.id, name, info.dept, ...workingDays.flatMap(d => [info.records[d]?.in || '--', info.records[d]?.out || '--'])
      ]);

      doc.autoTable({ head, body, startY: 40, theme: 'grid', styles: { fontSize: 7 }, headStyles: { fillColor: [72,187,120] } });
      doc.save(`attendance_${startDate.toISOString().slice(0,10)}_to_${endDate.toISOString().slice(0,10)}.pdf`);
    };

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('date-select').value = currentDate;
      document.getElementById('logoutBtn').onclick = () => { localStorage.clear(); location.href = 'index.html'; };
      document.getElementById('clear-logs').onclick = () => document.getElementById('log').innerHTML = '';
      document.getElementById('clear-filter-btn').onclick = () => { document.getElementById('date-select').value = currentDate; document.getElementById('department-select').value = ''; document.getElementById('name-search').value = ''; loadDashboardData(); };
      document.getElementById('export-btn').onclick = () => {
        const csv = "data:text/csv;charset=utf-8,User ID,Name,Department,Time In,Time Out,Location\n" +
          staffAttendanceData.map(r => `${r.userId||'N/A'},${r.name},${r.department},${r.timeIn},${r.timeOut},${r.clockInLocation||'Unknown'}`).join('\n');
        const a = document.createElement('a'); a.href = encodeURI(csv); a.download = 'attendance.csv'; a.click();
      };
      document.getElementById('date-select').onchange = () => loadDashboardData();
      document.getElementById('department-select').onchange = () => updateTable(staffAttendanceData);
      document.getElementById('name-search').oninput = () => updateTable(staffAttendanceData);
      document.getElementById('pdf-export-btn').onclick = exportToPDF;
      document.querySelectorAll('.sortable').forEach(th => th.onclick = () => {
        const key = th.dataset.sort;
        sortConfig = { key, dir: sortConfig.key === key && sortConfig.dir === 'asc' ? 'desc' : 'asc' };
        document.querySelectorAll('.sortable').forEach(t => t.classList.remove('asc','desc'));
        th.classList.add(sortConfig.dir);
        updateTable(staffAttendanceData);
      });
      loadDashboardData();
      setInterval(loadDashboardData, 30000);
    });
  </script>
</body>
</html>
