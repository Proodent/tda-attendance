<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Dashboard</title>
  <link rel="icon" type="image/png" href="/assets/favicon.png"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf-autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {font-family:'Inter',sans-serif;background:linear-gradient(135deg,#f0f4f8 0%,#d9e2ec 100%);color:#1a202c;margin:0;padding:0;min-height:100vh;}
    header {background:linear-gradient(90deg,#48bb78 0%,#38a169 100%);color:#fff;padding:0.75rem 1rem;font-size:1.4rem;font-weight:700;box-shadow:0 4px 6px rgba(0,0,0,0.1);display:flex;align-items:center;justify-content:space-between;}
    header img {height:2rem;}
    header .title {flex:1;text-align:center;font-size:1.2rem;}
    header .logout-icon {width:2rem;height:2rem;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;}
    header .logout-icon:hover {background:#e53e3e;}
    #summary-tiles {display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;padding:1.5rem;}
    .tile {background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);padding:1rem;text-align:center;transition:transform .2s;}
    .tile:hover {transform:translateY(-5px);}
    .tile h3 {font-size:.875rem;color:#4a5568;margin-bottom:.5rem;}
    .tile p {font-size:1.5rem;font-weight:700;color:#48bb78;}
    #avg-times {display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;padding:0 1.5rem 1.5rem;}
    .avg-tile {background:#fff;border-radius:12px;padding:1rem;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
    .avg-tile p {font-size:1.6rem;color:#48bb78;}
    #stats-container {display:grid;grid-template-columns:repeat(4,1fr);gap:1.5rem;padding:1.5rem;}
    .chart-tile {background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);padding:1.25rem;height:320px;display:flex;flex-direction:column;}
    .chart-tile h3 {text-align:center;font-size:1.1rem;margin-bottom:1rem;}
    .chart-container {flex:1;position:relative;}
    .full-width-chart {grid-column:1/-1;height:380px;}
    #log-container {margin:1rem;padding:0;background:#1a202c;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);overflow:hidden;}
    #log {background:#1a202c;color:#25e876;padding:1rem;height:180px;overflow-y:auto;font-family:monospace;font-size:.85rem;}
    #filters,#pdf-export {display:flex;gap:1rem;margin:1rem;padding:1.25rem;background:#d1e2fa;border-radius:12px;flex-wrap:wrap;align-items:flex-end;}
    input,select,button {padding:.5rem;border-radius:6px;border:2px solid #e2e8f0;height:40px;}
    button {background:#48bb78;color:#fff;border:none;cursor:pointer;min-width:120px;}
    button:hover {background:#38a169;}
    button:disabled {background:#aaa;cursor:not-allowed;}
    #staff-analysis {margin:1.5rem;padding:1.5rem;background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
    #staff-stats {display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem;margin-top:1rem;}
    .stat-box {background:#f0fdf4;padding:1rem;border-radius:8px;text-align:center;border:1px solid #86efac;}
    .loader {display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,0.95);padding:2rem;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.2);z-index:9999;}
    .loader.active {display:block;}
    @media (max-width:768px) {
      #summary-tiles,#stats-container {grid-template-columns:1fr;}
      #filters,#pdf-export {flex-direction:column;}
    }
  </style>
</head>
<body>
  <header>
    <img src="/assets/favicon.png" alt="logo" />
    <div class="title">Attendance Dashboard</div>
    <span class="logout-icon" id="logoutBtn">X</span>
  </header>

  <section id="summary-tiles">
    <div class="tile"><h3>Total Staff</h3><p id="totalStaff">--</p></div>
    <div class="tile"><h3>Active Staff</h3><p id="activeStaff">--</p></div>
    <div class="tile"><h3>Clock-Ins Today</h3><p id="clockInsToday">--</p></div>
    <div class="tile"><h3>Absent Today</h3><p id="absentToday">--</p></div>
  </section>

  <section id="avg-times">
    <div class="avg-tile"><h3>Avg Clock In</h3><p id="avgReportingTime">--:--</p></div>
    <div class="avg-tile"><h3>Avg Clock Out</h3><p id="avgDepartureTime">--:--</p></div>
  </section>

  <section id="stats-container">
    <div class="chart-tile full-width-chart"><h3>90 Days Attendance Trend</h3><div class="chart-container"><canvas id="trendChart"></canvas></div></div>
  </section>

  <!-- Individual Staff Analysis -->
  <section id="staff-analysis">
    <h3 class="text-xl font-bold mb-4">Individual Staff Analysis</h3>
    <div style="display:flex;gap:1rem;flex-wrap:wrap;align-items:end;">
      <input type="text" id="staff-search" placeholder="Enter Name or ID" style="flex:1;min-width:200px;">
      <select id="period-select">
        <option value="30">Last 30 Days</option>
        <option value="90" selected>Last 90 Days</option>
        <option value="180">Last 6 Months</option>
      </select>
      <button id="analyze-staff">Analyze</button>
    </div>
    <div id="staff-result" style="margin-top:1.5rem;display:none;">
      <h4 id="staff-name" class="text-lg font-bold mb-4"></h4>
      <div id="staff-stats">
        <div class="stat-box"><strong>Days Present:</strong> <span id="daysPresent">0</span></div>
        <div class="stat-box"><strong>Avg Clock In:</strong> <span id="avgIn">--:--</span></div>
        <div class="stat-box"><strong>Avg Clock Out:</strong> <span id="avgOut">--:--</span></div>
        <div class="stat-box"><strong>Attendance Rate:</strong> <span id="attendanceRate">0%</span></div>
      </div>
      <div class="chart-tile full-width-chart" style="margin-top:1rem;height:400px;">
        <div class="chart-container"><canvas id="staffChart"></canvas></div>
      </div>
    </div>
  </section>

  <!-- PDF Export -->
  <section id="pdf-export">
    <h3 class="text-xl font-bold mb-4">Export Monthly Report</h3>
    <div style="display:flex;gap:1rem;flex-wrap:wrap;align-items:end;">
      <select id="month-select">
        <option value="">Select Month</option>
      </select>
      <button id="pdf-export-btn">Download PDF Report</button>
    </div>
  </section>

  <div id="log-container"><div id="log"></div></div>
  <div class="loader" id="global-loader"><div class="spinner"></div><p>Loading... Please wait</p></div>

  <script>
    const api = "https://tolon-attendance.proodentit.com/api";
    const log = msg => {
      const l = document.getElementById('log');
      l.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
      l.scrollTop = l.scrollHeight;
    };

    let allStaff = [];
    let trendChart = null;
    let staffChart = null;

    const fetchJSON = async (url) => {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    };

    const timeToMins = t => t && t !== '--' ? t.split(':').reduce((h,m) => h*60 + +m, 0) : null;
    const minsToTime = m => m == null ? '--:--' : `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;

    // 90-Day Trend - FIXED & FAST
    const load90DayTrend = async () => {
      try {
        document.getElementById('global-loader').classList.add('active');
        const data = await fetchJSON(`${api}/stats?days=90`);
        const map = {};
        (data.trend || []).forEach(d => {
          const dateKey = d.date.includes('-') ? d.date : new Date().getFullYear() + '-' + 
            ('0' + (new Date(Date.parse(d.date + ' 2025')).getMonth() + 1)).slice(-2) + '-' + 
            ('0' + new Date(Date.parse(d.date + ' 2025')).getDate()).slice(-2);
          map[dateKey] = d.present || 0;
        });

        const labels = [];
        const values = [];
        const today = new Date();
        for (let i = 89; i >= 0; i--) {
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          const key = d.toISOString().split('T')[0];
          labels.push(d.toLocaleDateString('en-US', {month:'short', day:'numeric'}));
          values.push(map[key] || 0);
        }

        if (trendChart) trendChart.destroy();
        trendChart = new Chart(document.getElementById('trendChart'), {
          type: 'line',
          data: { 
            labels, 
            datasets: [{
              label: 'Staff Present',
              data: values,
              borderColor: '#48bb78',
              backgroundColor: 'rgba(72,187,120,0.2)',
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#48bb78',
              pointRadius: 4
            }]
          },
          options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { usePointStyle: true, pointStyle: 'circle' } }
            }
          }
        });
        log("90-day trend loaded");
      } catch (e) {
        log("Trend error: " + e.message);
      } finally {
        document.getElementById('global-loader').classList.remove('active');
      }
    };

    // Individual Staff Analysis - SUPER FAST & ACCURATE
    document.getElementById('analyze-staff').onclick = async () => {
      const btn = document.getElementById('analyze-staff');
      btn.disabled = true;
      btn.textContent = "Loading...";
      document.getElementById('global-loader').classList.add('active');

      const search = document.getElementById('staff-search').value.trim();
      const days = parseInt(document.getElementById('period-select').value);

      if (!search) {
        alert("Please enter staff name or ID");
        btn.disabled = false;
        btn.textContent = "Analyze";
        document.getElementById('global-loader').classList.remove('active');
        return;
      }

      const staff = allStaff.find(s => 
        s.name.toLowerCase().includes(search.toLowerCase()) || 
        (s.userId && s.userId.toLowerCase().includes(search.toLowerCase()))
      );

      if (!staff) {
        alert("Staff not found. Try partial name or ID.");
        btn.disabled = false;
        btn.textContent = "Analyze";
        document.getElementById('global-loader').classList.remove('active');
        return;
      }

      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - days);

      const records = [];
      const promises = [];
      let current = new Date(start);
      while (current <= end) {
        const dateStr = current.toISOString().split('T')[0];
        promises.push(
          fetchJSON(`${api}/stats?date=${dateStr}`).then(day => {
            const entry = (day.staffAttendance || []).find(e => 
              e.name.toLowerCase() === staff.name.toLowerCase()
            );
            if (entry) {
              records.push({
                date: dateStr,
                in: entry.timeIn,
                out: entry.timeOut
              });
            }
          }).catch(() => {})
        );
        current.setDate(current.getDate() + 1);
      }

      await Promise.all(promises);

      if (records.length === 0) {
        alert("No attendance records found for this staff in the selected period.");
        btn.disabled = false;
        btn.textContent = "Analyze";
        document.getElementById('global-loader').classList.remove('active');
        return;
      }

      const presentDays = records.filter(r => r.in).length;
      const inTimes = records.map(r => timeToMins(r.in)).filter(Boolean);
      const outTimes = records.map(r => timeToMins(r.out)).filter(Boolean);
      const avgIn = inTimes.length ? Math.round(inTimes.reduce((a,b)=>a+b,0)/inTimes.length) : null;
      const avgOut = outTimes.length ? Math.round(outTimes.reduce((a,b)=>a+b,0)/outTimes.length) : null;

      document.getElementById('staff-name').textContent = `${staff.name} (${staff.userId || 'No ID'})`;
      document.getElementById('daysPresent').textContent = presentDays;
      document.getElementById('avgIn').textContent = minsToTime(avgIn);
      document.getElementById('avgOut').textContent = minsToTime(avgOut);
      document.getElementById('attendanceRate').textContent = Math.round((presentDays / records.length) * 100) + '%';
      document.getElementById('staff-result').style.display = 'block';

      if (staffChart) staffChart.destroy();
      staffChart = new Chart(document.getElementById('staffChart'), {
        type: 'line',
        data: {
          labels: records.map(r => new Date(r.date).toLocaleDateString('en-US', {month:'short', day:'numeric'})),
          datasets: [
            { 
              label: 'Clock In', 
              data: records.map(r => timeToMins(r.in)), 
              borderColor: '#48bb78',
              tension: 0.3,
              pointRadius: 5
            },
            { 
              label: 'Clock Out', 
              data: records.map(r => timeToMins(r.out)), 
              borderColor: '#f56565',
              tension: 0.3,
              pointRadius: 5
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => {
                  const val = ctx.raw;
                  return ctx.dataset.label + ': ' + (val != null ? minsToTime(val) : 'No record');
                }
              }
            },
            legend: { labels: { usePointStyle: true, pointStyle: 'circle' } }
          },
          scales: { 
            y: { 
              ticks: { 
                callback: value => minsToTime(value)
              }
            }
          }
        }
      });

      log(`Analysis complete for ${staff.name}`);
      btn.disabled = false;
      btn.textContent = "Analyze";
      document.getElementById('global-loader').classList.remove('active');
    };

    // PDF Export - NOW WORKING
    document.getElementById('pdf-export-btn').onclick = async () => {
      const month = document.getElementById('month-select').value;
      if (!month) return alert("Select a month");

      document.getElementById('global-loader').classList.add('active');
      const [year, mon] = month.split('-');
      const start = new Date(year, mon-1, 1);
      const end = new Date(year, mon, 0);
      const days = [];
      let current = new Date(start);
      while (current <= end) {
        days.push(current.toISOString().split('T')[0]);
        current.setDate(current.getDate() + 1);
      }

      const data = [];
      for (const d of days) {
        try {
          const res = await fetchJSON(`${api}/stats?date=${d}`);
          res.date = d;
          data.push(res);
        } catch (e) { }
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l');
      doc.setFontSize(16);
      doc.text("Tolon District Assembly - Monthly Attendance Report", 14, 20);
      doc.setFontSize(12);
      doc.text(`Month: ${new Date(year, mon-1).toLocaleDateString('en-US', {year:'numeric', month:'long'})}`, 14, 30);

      const head = [['ID', 'Name', 'Dept', ...days.map(d => d.slice(8))]];
      const body = allStaff.map(s => {
        const row = [s.userId || '', s.name, s.department || ''];
        days.forEach(d => {
          const day = data.find(x => x.date === d);
          const entry = day?.staffAttendance?.find(e => e.name === s.name);
          row.push(entry?.timeIn || '--');
        });
        return row;
      });

      doc.autoTable({ head, body, startY: 40, styles: { fontSize: 8 } });
      doc.save(`Attendance_${month}.pdf`);
      document.getElementById('global-loader').classList.remove('active');
      log("PDF exported successfully");
    };

    // Initialize
    const init = async () => {
      try {
        const staffData = await fetchJSON(`${api}/staff`);
        allStaff = staffData.staff || [];

        // Populate months
        const now = new Date();
        const sel = document.getElementById('month-select');
        for (let i = 0; i < 12; i++) {
          const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const opt = document.createElement('option');
          opt.value = d.toISOString().slice(0,7);
          opt.textContent = d.toLocaleDateString('en-US', {year:'numeric', month:'long'});
          sel.appendChild(opt);
        }

        load90DayTrend();
        setInterval(load90DayTrend, 60000);
      } catch (e) {
        log("Init failed: " + e.message);
      }
    };

    document.getElementById('logoutBtn').onclick = () => {
      localStorage.removeItem('isLoggedIn');
      window.location.href = 'index.html';
    };

    init();
  </script>
</body>
</html>
