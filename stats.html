async function loadDashboardData() {
  const dateSelect = document.getElementById("date-select");
  const selectedDate = dateSelect?.value || currentDate; // 2025-10-19
  try {
    log("⏳ Fetching data...");

    const staffData = await fetchJSON(`${backendURL}/staff`);
    log(`Staff data: ${JSON.stringify(staffData).substring(0, 100)}${JSON.stringify(staffData).length > 100 ? "..." : ""}`);
    const totalStaff = staffData.totalStaff || (staffData.staff ? staffData.staff.length : 0);
    const activeCount = staffData.staffCount || (staffData.staff ? staffData.staff.filter(s => s.active).length : 0);
    log(`Parsed: totalStaff=${totalStaff}, activeCount=${activeCount}`);

    const statsUrl = `${backendURL}/stats?date=${selectedDate}`;
    const stats = await fetchJSON(statsUrl);
    staffAttendanceData = stats.staffAttendance || [];
    log(`Attendance data length: ${staffAttendanceData.length}`);

    const clockedInToday = staffAttendanceData.filter(entry => entry.timeIn).length;
    const clockedOutToday = staffAttendanceData.filter(entry => entry.timeOut).length;
    const absentToday = activeCount > 0 ? Math.max(0, activeCount - clockedInToday) : 0;
    const percentClockedIn = activeCount > 0 ? Math.round((clockedInToday / activeCount) * 100) : 0;
    const percentClockedOut = clockedInToday > 0 ? Math.round((clockedOutToday / clockedInToday) * 100) : 0;

    const clockInsBefore10AM = staffAttendanceData.filter(entry => entry.timeIn && convertToMinutes(entry.timeIn) < 10 * 60).length;
    const clockInsAfter10AM = staffAttendanceData.filter(entry => entry.timeIn && convertToMinutes(entry.timeIn) >= 10 * 60).length;
    const clockOutsBefore4PM = staffAttendanceData.filter(entry => entry.timeOut && convertToMinutes(entry.timeOut) < 16 * 60).length;
    const clockOutsAfter4PM = staffAttendanceData.filter(entry => entry.timeOut && convertToMinutes(entry.timeOut) >= 16 * 60).length;

    const locationData = await fetchJSON(`${backendURL}/locations`);
    log(`Location data: ${JSON.stringify(locationData).substring(0, 100)}${JSON.stringify(locationData).length > 100 ? "..." : ""}`);
    const locLabels = locationData.locations?.map(l => l.name) || [];
    const locAttendance = {};
    staffAttendanceData.forEach(entry => {
      const loc = entry.clockInLocation || "Unknown";
      locAttendance[loc] = (locAttendance[loc] || 0) + 1;
    });
    const locCounts = locLabels.map(loc => locAttendance[loc] || 0);

    departments = [...new Set(staffData.staff?.map(entry => entry.department) || [])];
    const departmentSelect = document.getElementById("department-select");
    if (departmentSelect) {
      departmentSelect.innerHTML = '<option value="">All Departments</option>';
      departments.forEach(dept => {
        const option = document.createElement("option");
        option.value = dept;
        option.textContent = dept;
        departmentSelect.appendChild(option);
      });
    }

    const deptTotals = {};
    const deptClockIns = {};
    const deptClockOuts = {};
    (staffData.staff || []).forEach(entry => {
      const dept = entry.department;
      deptTotals[dept] = (deptTotals[dept] || 0) + 1;
    });
    staffAttendanceData.forEach(entry => {
      const dept = entry.department;
      if (entry.timeIn) deptClockIns[dept] = (deptClockIns[dept] || 0) + 1;
      if (entry.timeOut) deptClockOuts[dept] = (deptClockOuts[dept] || 0) + 1;
    });
    const deptLabels = departments;
    const deptClockInData = departments.map(dept => deptClockIns[dept] || 0);
    const deptClockOutData = departments.map(dept => deptClockOuts[dept] || 0);
    const deptTotalLabels = departments.map(dept => deptTotals[dept] || 0);

    // Fetch and process trend data for the last 90 days
    let trendData = await fetchGoogleSheetData(`Attendance Sheet!A2:G`);
    log(`Raw attendance data length: ${trendData.length}, sample: ${JSON.stringify(trendData.slice(0, 5))}`);
    const trendMap = {};
    trendData.forEach(row => {
      const dateRaw = row[0];
      const name = row[2];
      const timeIn = row[3];
      let date = dateRaw;
      if (dateRaw) {
        const dateObj = new Date(dateRaw);
        if (isNaN(dateObj.getTime())) {
          const parts = dateRaw.split(/[\/-]/);
          if (parts.length === 3) {
            date = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`; // Convert to YYYY-MM-DD
          }
        } else {
          date = dateObj.toISOString().split('T')[0];
        }
      }
      if (date && name && timeIn) {
        if (!trendMap[date]) trendMap[date] = new Set();
        trendMap[date].add(name);
        log(`Processed date: ${dateRaw} -> ${date}, name: ${name}, timeIn: ${timeIn}`);
      } else {
        log(`⚠️ Invalid row skipped: ${JSON.stringify(row)}, reason: ${!date ? 'invalid date' : !name ? 'no name' : 'no timeIn'}`);
      }
    });
    trendData = Object.keys(trendMap).map(date => ({
      date,
      present: trendMap[date].size
    }));
    log(`Processed trend data length: ${trendData.length}, sample: ${JSON.stringify(trendData.slice(0, 2))}`);

    document.getElementById("totalStaff").innerText = totalStaff;
    document.getElementById("activeStaff").innerText = activeCount;
    document.getElementById("clockInsToday").innerText = clockedInToday;
    document.getElementById("clockOutsToday").innerText = clockedOutToday;
    document.getElementById("absentToday").innerText = absentToday;
    document.getElementById("percentClockedIn").innerText = percentClockedIn + '%';
    document.getElementById("percentClockedOut").innerText = percentClockedOut + '%';

    const attendanceTitle = document.getElementById("attendance-title");
    if (attendanceTitle) attendanceTitle.textContent = `Staff Attendance Details (${new Date(selectedDate).toLocaleDateString("en-US", { month: "long", day: "numeric", year: "numeric" })})`;
    updateTable(staffAttendanceData);

    updateGeneralAttendanceChart(clockedInToday, absentToday);
    updateReportingChart(clockInsBefore10AM, clockInsAfter10AM);
    updateDepartureChart(clockOutsBefore4PM, clockOutsAfter4PM);
    updateDepartmentChart(deptLabels, deptClockInData, deptClockOutData, deptTotalLabels);
    updateLocationChart(locLabels, locCounts);
    updateTrendChart(trendData);

    log("✅ Dashboard updated");
  } catch (err) {
    log("❌ " + err.message);
    ["totalStaff", "activeStaff", "clockInsToday", "clockOutsToday", "absentToday", "percentClockedIn", "percentClockedOut"].forEach(id => {
      const tile = document.querySelector(`#${id}`)?.closest(".tile");
      if (tile) tile.classList.add("error");
    });
  }
}

function updateTrendChart(trendData = []) {
  const ctx = document.getElementById("trendChart")?.getContext('2d');
  if (!ctx) {
    log("❌ Trend Chart context not found");
    return;
  }
  if (trendChart) trendChart.destroy();

  // Calculate the last 90 days from today (October 19, 2025)
  const today = new Date("2025-10-19T22:58:00Z"); // 10:58 PM GMT
  const labels = [];
  for (let i = 0; i < 90; i++) {
    const date = new Date(today);
    date.setDate(today.getDate() - i);
    labels.unshift(date.toISOString().split('T')[0]); // YYYY-MM-DD format
  }
  log(`Trend Chart: 90 days labels generated, sample: ${labels.slice(0, 5)}${labels.length > 5 ? "..." : ""}`);

  // Count occurrences of each date in trendData
  const dateCounts = {};
  trendData.forEach(entry => {
    const date = entry.date;
    if (labels.includes(date)) {
      dateCounts[date] = (dateCounts[date] || 0) + 1;
    }
  });
  const presentData = labels.map(date => dateCounts[date] || 0);
  log(`Trend Chart data: ${presentData.slice(0, 5)}${presentData.length > 5 ? "..." : ""}`);

  if (presentData.every(v => v === 0)) {
    log("⚠️ Warning: All trend data is zero, chart may appear empty");
  } else if (presentData.length === 0) {
    log("⚠️ Warning: No valid trend data available");
  }

  trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Staff Attendance Count',
        data: presentData,
        borderColor: '#48bb78',
        backgroundColor: 'rgba(72, 187, 120, 0.2)',
        tension: 0.4,
        fill: true,
        pointBackgroundColor: '#48bb78',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Attendance Count', color: '#2d3748', font: { size: 12 } },
          ticks: { color: '#2d3748', font: { size: 10 } }
        },
        x: {
          title: { display: true, text: 'Last 90 Days', color: '#2d3748', font: { size: 12 } },
          ticks: { color: '#2d3748', font: { size: 10 }, maxTicksLimit: 15 }
        }
      },
      plugins: {
        legend: { position: 'bottom', labels: { color: '#2d3748', font: { size: 12 } } },
        tooltip: {
          callbacks: {
            title: function(tooltipItems) {
              return `Date: ${tooltipItems[0].label}`;
            },
            label: function(context) {
              return `Attendance Count: ${context.raw}`;
            }
          }
        }
      }
    }
  });
}
