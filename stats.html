<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Dashboard</title>
  <link rel="icon" type="image/png" href="/assets/favicon.png"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* Your existing styles remain unchanged */
    body {font-family:'Inter',sans-serif;background:linear-gradient(135deg,#f0f4f8 0%,#d9e2ec 100%);color:#1a202c;margin:0;padding:0;min-height:100vh;}
    header {background:linear-gradient(90deg,#48bb78 0%,#38a169 100%);color:#fff;padding:0.75rem 1rem;font-size:1.4rem;font-weight:700;box-shadow:0 4px 6px rgba(0,0,0,0.1);display:flex;align-items:center;justify-content:space-between;flex-wrap:nowrap;gap:0.5rem;}
    header img {height:2rem;}
    header .title {flex:1;text-align:center;font-size:1.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    header .logout-icon {width:2rem;height:2rem;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.1rem;cursor:pointer;transition:all .2s;}
    header .logout-icon:hover {background:#e53e3e;color:#fff;}
    #summary-tiles {display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;padding:1.5rem;}
    .tile {background:#fff;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);padding:1rem;text-align:center;transition:transform .2s;}
    .tile:hover {transform:translateY(-5px);}
    .tile h3 {color:#2d3748;font-size:.875rem;margin-bottom:.5rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .tile p {font-size:1.5rem;font-weight:700;margin:0;color:#48bb78;}
    #filters,#pdf-export {display:flex;gap:1rem;margin:1rem;padding:1.25rem;background:rgb(209,226,250);border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1);flex-wrap:wrap;align-items:flex-end;}
    #pdf-export h2 {width:100%;font-size:1.5rem;color:#1a202c;margin:0 0 1rem 0;font-weight:700;}
    /* Rest of your styles... */
  </style>
</head>
<body>

  <!-- Your existing HTML up to PDF section -->

  <!-- PDF EXPORT SECTION WITH HEADING -->
  <section id="pdf-export">
    <h2 class="text-2xl font-bold text-green-700 mb-4">Export PDF</h2>
    <div class="pdf-filter-group"><label for="department-select-pdf">Select Department:</label><select id="department-select-pdf"><option value="">All Departments</option></select></div>
    <div class="pdf-filter-group"><label for="start-date">Start Date:</label><input type="date" id="start-date"></div>
    <div class="pdf-filter-group"><label for="end-date">End Date:</label><input type="date" id="end-date"></div>
    <div class="pdf-filter-group"><label for="month-select">Select Month:</label>
      <select id="month-select">
        <option value="">All Months</option><option value="01">January</option><option value="02">February</option><option value="03">March</option>
        <option value="04">April</option><option value="05">May</option><option value="06">June</option><option value="07">July</option>
        <option value="08">August</option><option value="09">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option>
      </select>
    </div>
    <div class="button-group">
      <div class="pdf-filter-group"><label style="visibility:hidden;">.</label>
        <button id="pdf-export-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded">
          Generate PDF Report
        </button>
      </div>
    </div>
  </section>

  <!-- Rest of your HTML -->

  <script>
    // Your existing code...

    // === NEW & IMPROVED PDF EXPORT FUNCTION ===
    const exportToPDF = async () => {
      const deptFilter = document.getElementById('department-select-pdf').value;
      const startInput = document.getElementById('start-date').value;
      const endInput = document.getElementById('end-date').value;
      const monthInput = document.getElementById('month-select').value;

      if ((!startInput || !endInput) && !monthInput) {
        alert("Please select a date range or month");
        return;
      }

      let startDate, endDate;
      if (monthInput) {
        const year = new Date().getFullYear();
        startDate = new Date(year, parseInt(monthInput) - 1, 1);
        endDate = new Date(year, parseInt(monthInput), 0);
      } else {
        startDate = new Date(startInput);
        endDate = new Date(endInput);
      }

      const startStr = startDate.toISOString().split('T')[0];
      const endStr = endDate.toISOString().split('T')[0];

      let rawData;
      try {
        rawData = await fetchJSON(`${backendURL}/stats?start=${startStr}&end=${endStr}`);
      } catch (e) {
        alert("Failed to fetch data: " + e.message);
        return;
      }

      // Normalize data
      let daysData = {};
      if (rawData.days) {
        daysData = rawData.days;
      } else if (Array.isArray(rawData)) {
        rawData.forEach(d => { if (d.date) daysData[d.date] = d; });
      } else if (rawData.date) {
        daysData[rawData.date] = rawData;
      }

      const allDates = Object.keys(daysData).sort();
      const workingDates = allDates.filter(date => {
        const d = new Date(date);
        return d.getDay() >= 1 && d.getDay() <= 5; // Mon-Fri
      });

      // Build staff attendance map
      const staffMap = {};
      workingDates.forEach(date => {
        const day = daysData[date];
        (day.staffAttendance || []).forEach(entry => {
          if (deptFilter && entry.department !== deptFilter) return;
          const name = entry.name;
          if (!staffMap[name]) {
            staffMap[name] = {
              userId: entry.userId || allStaff.find(s => s.name === name)?.userId || 'N/A',
              department: entry.department || 'N/A',
              records: {},
              ciTimes: [],
              coTimes: [],
              present: 0
            };
          }
          staffMap[name].records[date] = { ci: entry.timeIn || '--', co: entry.timeOut || '--' };
          if (entry.timeIn && entry.timeIn !== '--') {
            staffMap[name].ciTimes.push(timeToMinutes(entry.timeIn));
            staffMap[name].present++;
          }
          if (entry.timeOut && entry.timeOut !== '--') {
            staffMap[name].coTimes.push(timeToMinutes(entry.timeOut));
          }
        });
      });

      // Calculate averages
      Object.values(staffMap).forEach(s => {
        s.avgCI = s.ciTimes.length > 0 ? minutesToTime(avgTime(s.ciTimes)) : '--:--';
        s.avgCO = s.coTimes.length > 0 ? minutesToTime(avgTime(s.coTimes)) : '--:--';
        s.percent = workingDates.length > 0 ? Math.round((s.present / workingDates.length) * 100) : 0;
      });

      // Generate PDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape');

      // Header
      const logoUrl = "/assets/favicon.png";
      doc.addImage(logoUrl, 'PNG', 15, 10, 25, 25);
      doc.setFontSize(18);
      doc.setFont(undefined, 'bold');
      doc.text("Geofence Attendance Management System", 50, 20);
      doc.setFontSize(14);
      doc.text("Tolon District Assembly", 50, 30);
      doc.setFontSize(10);
      doc.text(`Date Printed: ${new Date().toLocaleString()}`, 200, 15);
      doc.text(`Period: ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`, 200, 22);

      // Table headers
      const head = [
        ["User ID", "Name", "Dep't", 
         ...workingDates.flatMap(d => [d.slice(5), ""]), 
         "Avg. CI", "Avg. CO", "Days Present", "% Present"]
      ];

      const body = Object.values(staffMap).map(staff => {
        const row = [
          staff.userId,
          staff.name,
          staff.department
        ];
        workingDates.forEach(date => {
          const rec = staff.records[date] || { ci: '--', co: '--' };
          row.push(rec.ci);
          row.push(rec.co);
        });
        row.push(staff.avgCI);
        row.push(staff.avgCO);
        row.push(`${staff.present}/${workingDates.length}`);
        row.push(`${staff.percent}%`);
        return row;
      });

      doc.autoTable({
        head: head,
        body: body,
        startY: 45,
        theme: 'grid',
        styles: { fontSize: 8, cellPadding: 2 },
        headStyles: { fillColor: [72, 187, 120], textColor: 255, fontStyle: 'bold' },
        alternateRowStyles: { fillColor: [240, 248, 255] },
        columnStyles: {
          0: { cellWidth: 18 },
          1: { cellWidth: 35 },
          2: { cellWidth: 15 }
        },
        margin: { top: 45, left: 10, right: 10 }
      });

      const periodStr = monthInput 
        ? new Date(new Date().getFullYear(), parseInt(monthInput)-1, 1).toLocaleString('default', { month: 'long', year: 'numeric' })
        : `${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`;
      doc.save(`Attendance_Report_${periodStr}.pdf`);
    };

    // Attach event
    document.getElementById('pdf-export-btn').addEventListener('click', exportToPDF);

    // Rest of your existing script...
  </script>
</body>
</html>
