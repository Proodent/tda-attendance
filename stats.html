<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Dashboard</title>
  <link rel="icon" type="image/png" href="/assets/favicon.png"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#f0f4f8 0%,#d9e2ec 100%);color:#1a202c;margin:0;padding:0;min-height:100vh;}
    header {background:linear-gradient(90deg,#48bb78 0%,#38a169 100%);color:#fff;padding:0.75rem 1rem;font-size:1.4rem;font-weight:700;box-shadow:0 4px 6px rgba(0,0,0,0.1);display:flex;align-items:center;justify-content:space-between;gap:0.5rem;}
    header img {height:2.2rem;border-radius:8px;}
    header .title {flex:1;text-align:center;font-size:1.3rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    header .logout-icon {width:2.2rem;height:2.2rem;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;cursor:pointer;}
    header .logout-icon:hover {background:#e53e3e;}
    #summary-tiles {display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;padding:1.5rem;}
    .tile {background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);padding:1rem;text-align:center;transition:transform .2s;}
    .tile:hover {transform:translateY(-6px);}
    .tile h3 {color:#4a5568;font-size:.9rem;margin-bottom:.5rem;}
    .tile p {font-size:1.6rem;font-weight:700;color:#48bb78;}
    #avg-times {display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem;padding:0 1.5rem 1.5rem;}
    .avg-tile {background:#fff;border-radius:12px;padding:1.2rem;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
    .avg-tile h3 {font-size:1rem;color:#4a5568;}
    .avg-tile p {font-size:1.8rem;font-weight:700;color:#48bb78;}
    #stats-container {display:grid;grid-template-columns:repeat(4,1fr);gap:1.5rem;padding:1.5rem;}
    .chart-tile {background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);padding:1.25rem;height:340px;display:flex;flex-direction:column;}
    .chart-tile h3 {text-align:center;color:#2d3748;margin-bottom:1rem;font-size:1.1rem;font-weight:600;}
    .chart-container {flex:1;position:relative;}
    .full-width-chart {grid-column:1/-1;height:400px;}
    #log-container {margin:1.5rem;padding:0;background:#1a202c;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);overflow:hidden;}
    #log-header {display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1rem;background:#2d3748;color:#fff;font-weight:600;}
    #clear-logs {background:#e53e3e;color:#fff;padding:0.3rem 0.8rem;border:none;border-radius:6px;font-size:0.85rem;cursor:pointer;}
    #log {background:#1a202c;color:#25e876;padding:1rem;height:180px;overflow-y:auto;font-size:.85rem;font-family:'Courier New',monospace;}
    #attendance-table, #pdf-export {margin:1.5rem;padding:1.5rem;background:#e6f3ff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
    #filters {display:flex;gap:1rem;padding:1.5rem;background:#e6f3ff;border-radius:12px;margin:1.5rem;box-shadow:0 4px 12px rgba(0,0,0,0.1);flex-wrap:wrap;align-items:flex-end;}
    input, select {padding:.6rem;border-radius:8px;border:2px solid #cbd5e0;height:44px;width:100%;font-size:.95rem;}
    button {background:#48bb78;color:#fff;padding:0 1.8rem;border:none;border-radius:8px;cursor:pointer;height:44px;font-weight:600;transition:.2s;}
    button:hover {background:#38a169;}
    .filter-group {flex:1;min-width:180px;}
    #staff-analysis {margin:1.5rem;padding:1.5rem;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
    #staff-stats {display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-top:1rem;}
    .stat-box {background:#f8fafc;padding:1.2rem;border-radius:10px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,0.05);}
    .stat-box p {font-size:1.6rem;font-weight:700;color:#48bb78;}
    .loader {display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.9);z-index:10;justify-content:center;align-items:center;}
    .loader.active {display:flex;}
    .spinner {border:5px solid #f3f3f3;border-top:5px solid #48bb78;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;}
    @keyframes spin {0% {transform:rotate(0deg);} 100% {transform:rotate(360deg);}}
    @media (max-width:768px){
      #summary-tiles{grid-template-columns:repeat(2,1fr);}
      #stats-container{grid-template-columns:1fr;}
      #filters,#pdf-export{flex-direction:column;}
      header .title{font-size:1rem;}
    }
  </style>
</head>
<body>
  <header>
    <img src="/assets/favicon.png" alt="Logo">
    <div class="title">Geofence Attendance Management System</div>
    <span class="logout-icon" id="logoutBtn">X</span>
  </header>

  <!-- Summary Tiles -->
  <section id="summary-tiles">
    <div class="tile"><h3>Total Staff</h3><p id="totalStaff">--</p></div>
    <div class="tile"><h3>Active Staff</h3><p id="activeStaff">--</p></div>
    <div class="tile"><h3>Clock-Ins Today</h3><p id="clockInsToday">--</p></div>
    <div class="tile"><h3>Clock-Outs Today</h3><p id="clockOutsToday">--</p></div>
    <div class="tile"><h3>Absent Today</h3><p id="absentToday">--</p></div>
    <div class="tile"><h3>Inactive Staff</h3><p id="inactiveStaff">--</p></div>
    <div class="tile"><h3>Clock-In Rate</h3><p id="percentClockedIn">--%</p></div>
    <div class="tile"><h3>Clock-Out Rate</h3><p id="percentClockedOut">--%</p></div>
  </section>

  <section id="avg-times">
    <div class="avg-tile"><h3>Avg Reporting Time</h3><p id="avgReportingTime">--:--</p></div>
    <div class="avg-tile"><h3>Avg Departure Time</h3><p id="avgDepartureTime">--:--</p></div>
  </section>

  <!-- Charts -->
  <section id="stats-container">
    <div class="chart-tile"><h3>General Attendance</h3><div class="chart-container"><canvas id="generalAttendanceChart"></canvas></div></div>
    <div class="chart-tile"><h3>Reporting Time</h3><div class="chart-container"><canvas id="reportingChart"></canvas></div></div>
    <div class="chart-tile"><h3>Departure Time</h3><div class="chart-container"><canvas id="departureChart"></canvas></div></div>
    <div class="chart-tile"><h3>Clocking Status</h3><div class="chart-container"><canvas id="clockingChart"></canvas></div></div>
    <div class="chart-tile full-width-chart"><h3>Department Attendance</h3><div class="chart-container"><canvas id="departmentChart"></canvas></div></div>
    <div class="chart-tile full-width-chart"><h3>Location Attendance</h3><div class="chart-container"><canvas id="locationChart"></canvas></div></div>
    <div class="chart-tile full-width-chart"><h3>90-Day Trend</h3><div class="chart-container"><canvas id="trendChart"></canvas></div></div>
  </section>

  <!-- Filters -->
  <section id="filters">
    <div class="filter-group"><label>Select Date</label><input type="date" id="date-select"></div>
    <div class="filter-group"><label>Department</label><select id="department-select"><option value="">All Departments</option></select></div>
    <div class="filter-group"><label>Search Name/ID</label><input type="text" id="name-search" placeholder="Enter name or ID"></div>
    <div style="display:flex;gap:1rem;">
      <button id="clear-filter-btn">Clear Filters</button>
      <button id="export-btn">Export CSV</button>
    </div>
  </section>

  <!-- Attendance Table -->
  <section id="attendance-table">
    <h3 class="text-2xl font-bold text-green-700 mb-4">Attendance Details</h3>
    <div class="loader" id="table-loader"><div class="spinner"></div></div>
    <table style="width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
      <thead style="background:#2d3748;color:#fff;">
        <tr>
          <th style="padding:1rem;text-align:left;">User ID</th>
          <th style="padding:1rem;text-align:left;">Name</th>
          <th style="padding:1rem;text-align:left;">Department</th>
          <th style="padding:1rem;text-align:left;">Time In</th>
          <th style="padding:1rem;text-align:left;">Time Out</th>
          <th style="padding:1rem;text-align:left;">Work Time</th>
          <th style="padding:1rem;text-align:left;">Location</th>
        </tr>
      </thead>
      <tbody id="attendance-body" style="font-size:0.95rem;"></tbody>
    </table>
  </section>

  <!-- PDF EXPORT SECTION -->
  <section id="pdf-export">
    <h2 class="text-2xl font-bold text-green-700 mb-6">Export PDF</h2>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;">
      <div class="filter-group">
        <label>Department</label>
        <select id="department-select-pdf"><option value="">All Departments</option></select>
      </div>
      <div class="filter-group"><label>Start Date</label><input type="date" id="start-date"></div>
      <div class="<br>filter-group"><label>End Date</label><input type="date" id="end-date"></div>
      <div class="filter-group">
        <label>Select Month</label>
        <select id="month-select">
          <option value="">All Months</option>
          <option value="01">January</option><option value="02">February</option><option value="03">March</option>
          <option value="04">April</option><option value="05">May</option><option value="06">June</option>
          <option value="07">July</option><option value="08">August</option><option value="09">September</option>
          <option value="10">October</option><option value="11">November</option><option value="12">December</option>
        </select>
      </div>
      <div style="display:flex;align-items:end;">
        <button id="pdf-export-btn" style="height:44px;width:100%;font-size:1rem;">Generate & Download PDF</button>
      </div>
    </div>
  </section>

  <!-- Staff Analysis -->
  <section id="staff-analysis">
    <h3 class="text-2xl font-bold text-gray-800 mb-4">Staff Attendance Analysis</h3>
    <div id="staff-filters" style="display:flex;gap:1rem;flex-wrap:wrap;align-items:end;margin-bottom:1rem;">
      <div class="filter-group"><label>Search Staff</label><input type="text" id="staff-search" placeholder="Enter name or ID"></div>
      <div class="filter-group">
        <label>Period</label>
        <select id="period-select">
          <option value="7">1 Week</option>
          <option value="30" selected>1 Month</option>
          <option value="90">3 Months</option>
          <option value="180">6 Months</option>
          <option value="365">1 Year</option>
        </select>
      </div>
      <button id="analyze-staff">Analyze Staff</button>
    </div>
    <div class="chart-tile full-width-chart" id="staff-chart-tile" style="display:none;">
      <h3 id="staff-chart-title">Clock Time Trend</h3>
      <div class="chart-container"><canvas id="staffTrendChart"></canvas></div>
    </div>
    <div id="staff-stats" style="display:none;">
      <div class="stat-box"><h4>Avg Clock In</h4><p id="avgClockIn">--:--</p></div>
      <div class="stat-box"><h4>Avg Clock Out</h4><p id="avgClockOut">--:--</p></div>
      <div class="stat-box"><h4>Days Present</h4><p id="daysPresent">0 / 0</p></div>
      <div class="stat-box"><h4>Attendance %</h4><p id="attendancePercent">0%</p></div>
    </div>
  </section>

  <div id="log-container">
    <div id="log-header"><span>System Logs</span><button id="clear-logs">Clear Logs</button></div>
    <div id="log"></div>
  </div>

  <script>
    const backendURL = "https://tolon-attendance.proodentit.com/api";
    const currentDate = new Date().toISOString().split('T')[0];
    let allStaff = [], staffAttendanceData = [], staffAnalysisChart = null;

    const log = msg => {
      const box = document.getElementById('log');
      box.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
      box.scrollTop = box.scrollHeight;
    };

    const fetchJSON = async url => {
      const r = await fetch(url);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const txt = await r.text();
      log(`Fetched: ${url.split('?')[0]}`);
      return JSON.parse(txt);
    };

    const timeToMinutes = t => !t || t === '--' ? null : t.split(':').reduce((h,m) => h*60 + +m);
    const minutesToTime = m => m == null ? '--:--' : `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;

    // PROFESSIONAL PDF EXPORT
    const exportToPDF = async () => {
      const dept = document.getElementById('department-select-pdf').value;
      const startInput = document.getElementById('start-date').value;
      const endInput = document.getElementById('end-date').value;
      const month = document.getElementById('month-select').value;

      if (!startInput && !endInput && !month) {
        alert("Please select a date range or month");
        return;
      }

      let startDate, endDate;
      if (month) {
        const y = new Date().getFullYear();
        startDate = new Date(y, month-1, 1);
        endDate = new Date(y, month, 0);
      } else {
        startDate = new Date(startInput);
        endDate = new Date(endInput);
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape');

      // Header with Logo & Title
      doc.addImage("/assets/favicon.png", "PNG", 15, 10, 25, 25);
      doc.setFontSize(20);
      doc.setFont("helvetica", "bold");
      doc.text("TOLON DISTRICT ASSEMBLY", 50, 20);
      doc.setFontSize(16);
      doc.text("Geofence Attendance Management System", 50, 30);
      doc.setFontSize(14);
      doc.text("Attendance Report", 50, 40);

      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      doc.text(`Period: ${startDate.toLocaleDateString('en-GB')} - ${endDate.toLocaleDateString('en-GB')}`, 200, 20);
      if (dept) doc.text(`Department: ${dept}`, 200, 28);
      doc.text(`Date Printed: ${new Date().toLocaleDateString('en-GB')} ${new Date().toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'})}`, 200, 36);

      let y = 50;

      try {
        let rawData = [];
        try {
          const s = startDate.toISOString().split('T')[0];
          const e = endDate.toISOString().split('T')[0];
          const res = await fetchJSON(`${backendURL}/stats?start=${s}&end=${e}`);
          rawData = Array.isArray(res) ? res : [res];
        } catch (e) {
          // Fallback per day
          const data = [];
          const cur = new Date(startDate);
          while (cur <= endDate) {
            const ds = cur.toISOString().split('T')[0];
            try {
              const day = await fetchJSON(`${backendURL}/stats?date=${ds}`);
              data.push({ date: ds, staffAttendance: day.staffAttendance || [] });
            } catch { data.push({ date: ds, staffAttendance: [] }); }
            cur.setDate(cur.getDate() + 1);
          }
          rawData = data;
        }

        const staffMap = {};
        rawData.forEach(day => {
          (day.staffAttendance || []).forEach(e => {
            if (dept && e.department !== dept) return;
            if (!staffMap[e.name]) {
              staffMap[e.name] = {
                userId: e.userId || allStaff.find(s => s.name === e.name)?.userId || "N/A",
                records: {}
              };
            }
            staffMap[e.name].records[day.date] = { in: e.timeIn || "--", out: e.timeOut || "--" };
          });
        });

        for (const [name, info] of Object.entries(staffMap)) {
          if (y > 170) { doc.addPage(); y = 40; }

          doc.setFontSize(12);
          doc.setFont("helvetica", "bold");
          doc.text(`${name} (${info.userId})`, 15, y);
          y += 10;

          const tableData = Object.entries(info.records)
            .sort(([a], [b]) => a.localeCompare(b))
            .map(([date, times]) => [
              date,
              times.in,
              times.out
            ]);

          doc.autoTable({
            startY: y,
            head: [['Date', 'Time In', 'Time Out']],
            body: tableData,
            theme: 'grid',
            styles: { fontSize: 9, cellPadding: 3 },
            headStyles: { fillColor: [72, 187, 120], textColor: [255, 255, 255] },
            alternateRowStyles: { fillColor: [240, 248, 255] },
            margin: { left: 15, right: 15 }
          });

          y = doc.lastAutoTable.finalY + 15;
        }

        if (Object.keys(staffMap).length === 0) {
          doc.setFontSize(12);
          doc.text("No attendance records found for the selected period and filters.", 15, y);
        }

        doc.save(`Attendance_Report_${startDate.toISOString().split('T')[0]}_to_${endDate.toISOString().split('T')[0]}.pdf`);
        log("PDF generated and downloaded successfully");

      } catch (err) {
        log("PDF Error: " + err.message);
        alert("Failed to generate PDF. Check browser console and logs.");
      }
    };

    // Staff Analysis (working perfectly)
    const analyzeStaff = async () => {
      const btn = document.getElementById('analyze-staff');
      btn.disabled = true; btn.textContent = "Analyzing...";

      const search = document.getElementById('staff-search').value.trim().toLowerCase();
      const days = parseInt(document.getElementById('period-select').value);

      if (!search) { alert("Please enter staff name or ID"); btn.disabled = false; btn.textContent = "Analyze Staff"; return; }

      const staff = allStaff.find(s => 
        s.name.toLowerCase().includes(search) || 
        (s.userId && s.userId.toLowerCase().includes(search))
      );

      if (!staff) { alert("Staff not found"); btn.disabled = false; btn.textContent = "Analyze Staff"; return; }

      const end = new Date();
      const start = new Date(); start.setDate(end.getDate() - days);

      let data = [];
      try {
        const s = start.toISOString().split('T')[0];
        const e = end.toISOString().split('T')[0];
        const res = await fetchJSON(`${backendURL}/stats?start=${s}&end=${e}`);
        data = Array.isArray(res) ? res : [res];
      } catch (e) {
        const temp = [];
        const cur = new Date(start);
        while (cur <= end) {
          const ds = cur.toISOString().split('T')[0];
          try {
            const d = await fetchJSON(`${backendURL}/stats?date=${ds}`);
            temp.push({ date: ds, staffAttendance: d.staffAttendance || [] });
          } catch { temp.push({ date: ds, staffAttendance: [] }); }
          cur.setDate(cur.getDate() + 1);
        }
        data = temp;
      }

      const entries = data.flatMap(d => 
        (d.staffAttendance || []).filter(e => e.name === staff.name).map(e => ({...e, date: d.date}))
      );

      const inTimes = entries.map(e => timeToMinutes(e.timeIn)).filter(Boolean);
      const outTimes = entries.map(e => timeToMinutes(e.timeOut)).filter(Boolean);

      const workingDays = [];
      const present = new Set();
      const cur = new Date(start);
      while (cur <= end) {
        if (cur.getDay() >= 1 && cur.getDay() <= 5) {
          const ds = cur.toISOString().split('T')[0];
          workingDays.push(ds);
          if (entries.some(e => e.date === ds && e.timeIn)) present.add(ds);
        }
        cur.setDate(cur.getDate() + 1);
      }

      const map = {};
      entries.forEach(e => { map[e.date] = { in: timeToMinutes(e.timeIn), out: timeToMinutes(e.timeOut) }; });

      document.getElementById('staff-chart-title').textContent = `${staff.name} - Clock Time Trend`;
      document.getElementById('avgClockIn').textContent = minutesToTime(inTimes.length ? Math.round(inTimes.reduce((a,b)=>a+b)/inTimes.length) : null);
      document.getElementById('avgClockOut').textContent = minutesToTime(outTimes.length ? Math.round(outTimes.reduce((a,b)=>a+b)/outTimes.length) : null);
      document.getElementById('daysPresent').textContent = `${present.size} / ${workingDays.length}`;
      document.getElementById('attendancePercent').textContent = `${Math.round((present.size / workingDays.length) * 100)}%`;

      document.getElementById('staff-chart-tile').style.display = 'block';
      document.getElementById('staff-stats').style.display = 'grid';

      if (staffAnalysisChart) staffAnalysisChart.destroy();
      staffAnalysisChart = new Chart(document.getElementById('staffTrendChart'), {
        type: 'line',
        data: {
          labels: workingDays.map(d => new Date(d).toLocaleDateString('en', {month:'short', day:'numeric'})),
          datasets: [
            { label: 'Clock In', data: workingDays.map(d => map[d]?.in ?? null), borderColor: '#48bb78', tension: 0.3 },
            { label: 'Clock Out', data: workingDays.map(d => map[d]?.out ?? null), borderColor: '#f56565', tension: 0.3 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { ticks: { callback: v => minutesToTime(v) } } }
        }
      });

      btn.disabled = false; btn.textContent = "Analyze Staff";
    };

    // Load Dashboard
    const loadDashboardData = async () => {
      const date = document.getElementById('date-select').value || currentDate;
      try {
        const staffRes = await fetchJSON(`${backendURL}/staff`);
        allStaff = staffRes.staff || [];
        document.getElementById('totalStaff').textContent = staffRes.totalStaff || allStaff.length;

        const stats = await fetchJSON(`${backendURL}/stats?date=${date}`);
        staffAttendanceData = stats.staffAttendance || [];

        const depts = [...new Set(allStaff.map(s=>s.department))].filter(Boolean).sort();
        ['department-select','department-select-pdf'].forEach(id => {
          const sel = document.getElementById(id);
          sel.innerHTML = '<option value="">All Departments</option>' + depts.map(d=>`<option value="${d}">${d}</option>`).join('');
        });

        // Simple table update
        const tbody = document.getElementById('attendance-body');
        tbody.innerHTML = staffAttendanceData.map(r => `
          <tr style="border-bottom:1px solid #e2e8f0;">
            <td style="padding:1rem;">${r.userId || 'N/A'}</td>
            <td style="padding:1rem;">${r.name}</td>
            <td style="padding:1rem;">${r.department || '--'}</td>
            <td style="padding:1rem;">${r.timeIn || '--'}</td>
            <td style="padding:1rem;">${r.timeOut || '--'}</td>
            <td style="padding:1rem;">${r.timeIn && r.timeOut ? 
              `${Math.floor((timeToMinutes(r.timeOut)-timeToMinutes(r.timeIn))/60)}h ${(timeToMinutes(r.timeOut)-timeToMinutes(r.timeIn))%60}m` : 'N/A'}
            </td>
            <td style="padding:1rem;">${r.clockInLocation || 'Unknown'}</td>
          </tr>`).join('');

        log("Dashboard refreshed");
      } catch (e) { log("Load error: " + e.message); }
    };

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('date-select').value = currentDate;
      document.getElementById('pdf-export-btn').onclick = exportToPDF;
      document.getElementById('analyze-staff').onclick = analyzeStaff;
      document.getElementById('date-select').onchange = loadDashboardData;
      loadDashboardData();
      setInterval(loadDashboardData, 30000);
    });
  </script>
</body>
</html>
