<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tolon District Assembly Staff Attendance Portal</title>
<link rel="icon" type="image/png" href="/assets/favicon.png" />

<!-- MEDIAPIPE -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
/* ===== YOUR ORIGINAL STYLES (UNCHANGED) ===== */
body{font-family:Arial,sans-serif;background:#e8f5e8;text-align:center;margin:0;padding:20px;min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center}
.container{padding:20px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.15);max-width:600px;width:90%;background:rgba(255,255,255,.92)}
.logo{width:60px;height:60px;border-radius:50%;border:1.8px solid #009245}
h1{color:#009245}
button{padding:14px;font-size:16px;border:none;border-radius:8px;font-weight:600}
#clockIn{background:#4CAF50;color:#fff}
#clockOut{background:#F44336;color:#fff}
button:disabled{background:#ccc}
#faceModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:3000;justify-content:center;align-items:center}
#faceModal.show{display:flex}
.popup-content{background:#fff;padding:20px;border-radius:14px;width:90%;max-width:380px}
.video-container{width:280px;height:210px;border:3px solid #009245;border-radius:12px;overflow:hidden;margin:auto}
video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
.capture-status{margin-top:10px;font-weight:700;color:#009245}
</style>
</head>

<body>

<div class="container">
  <img src="/assets/client-logo.jpg" class="logo">
  <h1>Tolon District Assembly<br><small>Staff Attendance Portal</small></h1>

  <input type="number" id="userId" placeholder="Enter User ID">
  <br><br>

  <button id="clockIn">Clock In</button>
  <button id="clockOut">Clock Out</button>
</div>

<!-- FACE MODAL -->
<div id="faceModal">
  <div class="popup-content">
    <h3>Face Verification</h3>
    <div class="video-container">
      <video id="video" autoplay playsinline></video>
    </div>
    <div class="capture-status" id="captureStatus">Please blink</div>
  </div>
</div>

<script>
/* ================== GLOBALS ================== */
let videoEl = document.getElementById('video');
let faceModal = document.getElementById('faceModal');
let captureStatus = document.getElementById('captureStatus');

/* ===== MEDIAPIPE STATE ===== */
let faceMesh = null;
let mpCamera = null;
let blinkDetected = false;
let headTurnDetected = false;
let livenessPassed = false;

/* ================== LIVENESS ================== */
function detectBlink(lm){
  const top = lm[159];
  const bottom = lm[145];
  return Math.abs(top.y - bottom.y) < 0.008;
}

function detectHeadTurn(lm){
  const nose = lm[1];
  const left = lm[234];
  const right = lm[454];
  return Math.abs(
    Math.abs(nose.x - left.x) - Math.abs(nose.x - right.x)
  ) > 0.03;
}

function initLiveness(){
  faceMesh = new FaceMesh({
    locateFile:file=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
  });

  faceMesh.setOptions({
    maxNumFaces:1,
    refineLandmarks:true,
    minDetectionConfidence:0.7,
    minTrackingConfidence:0.7
  });

  faceMesh.onResults(res=>{
    if(!res.multiFaceLandmarks || livenessPassed) return;
    const lm = res.multiFaceLandmarks[0];

    if(!blinkDetected && detectBlink(lm)){
      blinkDetected = true;
      captureStatus.textContent = "Blink detected ✔ Turn your head";
      return;
    }

    if(blinkDetected && !headTurnDetected && detectHeadTurn(lm)){
      headTurnDetected = true;
      livenessPassed = true;
      captureStatus.textContent = "Liveness verified ✔";
      setTimeout(captureAndVerify,1000);
    }
  });
}

/* ================== CAMERA ================== */
async function startVideo(){
  const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
  videoEl.srcObject = stream;
  await videoEl.play();

  blinkDetected = false;
  headTurnDetected = false;
  livenessPassed = false;
  captureStatus.textContent = "Please blink";

  initLiveness();

  mpCamera = new Camera(videoEl,{
    onFrame:async()=>{await faceMesh.send({image:videoEl});},
    width:640,height:480
  });
  mpCamera.start();
}

function stopVideo(){
  if(mpCamera){mpCamera.stop();mpCamera=null;}
  if(videoEl.srcObject){
    videoEl.srcObject.getTracks().forEach(t=>t.stop());
    videoEl.srcObject=null;
  }
  faceMesh=null;
}

/* ================== CAPTURE ================== */
function captureAndVerify(){
  if(!livenessPassed){
    alert("Liveness not completed");
    return;
  }

  const canvas = document.createElement("canvas");
  canvas.width = videoEl.videoWidth;
  canvas.height = videoEl.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.translate(canvas.width,0);
  ctx.scale(-1,1);
  ctx.drawImage(videoEl,0,0);

  const image = canvas.toDataURL("image/jpeg");
  console.log("Captured image ready for CompreFace");

  stopVideo();
  faceModal.classList.remove("show");

  alert("Face verified. Attendance recorded.");
}

/* ================== BUTTONS ================== */
document.getElementById("clockIn").onclick=()=>{
  faceModal.classList.add("show");
  startVideo();
};

document.getElementById("clockOut").onclick=()=>{
  faceModal.classList.add("show");
  startVideo();
};
</script>
</body>
</html>
